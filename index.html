<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo„É™„Çπ„Éà Pro - Focus Layout</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Roboto', 'Noto Sans JP', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'] 
                    },
                    colors: {
                        google: {
                            blue: '#1a73e8', red: '#ea4335', yellow: '#fbbc04', green: '#34a853',
                            gray: '#f1f3f4', text: '#202124', textSec: '#5f6368', hover: '#f8f9fa',
                            selected: '#e8f0fe', selectedText: '#1967d2'
                        },
                        duo: {
                            green: '#58cc02', border: '#46a302', greenHighlight: '#89e219',
                            blue: '#1cb0f6', blueBorder: '#1899d6',
                            orange: '#ff9600', orangeBorder: '#cc7900',
                            pink: '#ff4b4b', pinkBorder: '#d42c2c',
                            gray: '#e5e5e5', lightGray: '#f7f7f7', text: '#4b4b4b',
                            gold: '#FFD700', silver: '#C0C0C0'
                        }
                    },
                    boxShadow: {
                        'card': '0 2px 0 0 #e5e5e5',
                        'duo': '0 4px 0 0 #e5e5e5',
                        'floating': '0 6px 16px 0 rgba(0,0,0,0.2)',
                        'glow': '0 0 15px rgba(255, 255, 255, 0.8)',
                    },
                    animation: {
                        'shimmer': 'shimmer 2s linear infinite',
                        'pulse-fast': 'pulse 0.8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-soft': 'bounce-soft 2s infinite',
                        'toast-in': 'toast-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'float-up': 'float-up 1s ease-out forwards',
                        'spring': 'spring 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'chest-open': 'chest-open 0.5s forwards',
                        'light-burst': 'light-burst 1s ease-out infinite',
                        'ignition': 'ignition 1.5s ease-out forwards',
                        'flame-grow': 'flame-grow 0.5s ease-out forwards',
                        'scale-in': 'scale-in 0.2s ease-out forwards',
                        'tech-slide': 'tech-slide 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'log-fade': 'log-fade 3s ease-out forwards',
                        'checkbox-pop': 'checkbox-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'bounce-hard': 'bounce-hard 0.5s infinite',
                    },
                    keyframes: {
                        shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
                        'bounce-soft': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        'bounce-hard': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px) scale(1.1)' } },
                        'toast-in': { '0%': { transform: 'translate(-50%, 100%)', opacity: 0 }, '100%': { transform: 'translate(-50%, 0)', opacity: 1 } },
                        'float-up': { '0%': { transform: 'translateY(0) scale(1)', opacity: 1 }, '100%': { transform: 'translateY(-60px) scale(1.1)', opacity: 0 } },
                        'spring': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        'shake': { '10%, 90%': { transform: 'translate3d(-2px, 0, 0) rotate(-2deg)' }, '20%, 80%': { transform: 'translate3d(4px, 0, 0) rotate(4deg)' }, '30%, 50%, 70%': { transform: 'translate3d(-8px, 0, 0) rotate(-8deg)' }, '40%, 60%': { transform: 'translate3d(8px, 0, 0) rotate(8deg)' } },
                        'chest-open': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.2)' }, '100%': { transform: 'scale(0) opacity(0)' } },
                        'light-burst': { '0%': { transform: 'scale(1)', opacity: 0.5 }, '100%': { transform: 'scale(1.5)', opacity: 0 } },
                        'ignition': { '0%': { opacity: 0, transform: 'scale(0.8)' }, '20%': { opacity: 1, transform: 'scale(1.2)' }, '100%': { opacity: 0, transform: 'scale(2)' } },
                        'flame-grow': { '0%': { transform: 'scale(1)', color: '#e5e5e5' }, '50%': { transform: 'scale(1.5)', color: '#ff9600' }, '100%': { transform: 'scale(1)', color: '#ff9600' } },
                        'scale-in': { '0%': { transform: 'scale(0.8)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'tech-slide': { '0%': { transform: 'translateX(-20px)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        'log-fade': { '0%': { color: '#FFD700', transform: 'translateX(-10px)' }, '20%': { color: '#FFD700', transform: 'translateX(0)' }, '100%': { color: '#4b5563' } },
                        'checkbox-pop': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.5)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Roboto', 'Noto Sans JP', sans-serif; -webkit-font-smoothing: antialiased; }
        @keyframes confetti-explode { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 60% { opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        @keyframes cherry-fall { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(720deg); opacity: 0; } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #dadce0; border-radius: 4px; }

        .progress-glow { filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.8)) brightness(1.2); }
        .fire-active { animation: flame-grow 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-white h-screen overflow-hidden text-duo-text">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Èü≥Èüø„Ç®„É≥„Ç∏„É≥ ---
        const AudioEngine = {
            ctx: null,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(freqs, type = 'sine', volume = 0.1, interval = 0.08) {
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const now = this.ctx.currentTime;
                freqs.forEach((f, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(f, now + i * interval);
                    gain.gain.setValueAtTime(0, now + i * interval);
                    gain.gain.linearRampToValueAtTime(volume, now + i * interval + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * interval + 0.25);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now + i * interval);
                    osc.stop(now + i * interval + 0.3);
                });
            }
        };

        // --- Icons ---
        const SvgIcon = ({ children, size = 20, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Icons = {
            Menu: (p) => <SvgIcon {...p}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></SvgIcon>,
            Plus: (p) => <SvgIcon {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></SvgIcon>,
            Check: (p) => <SvgIcon {...p}><polyline points="20 6 9 17 4 12"/></SvgIcon>,
            Trash2: (p) => <SvgIcon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></SvgIcon>,
            Calendar: (p) => <SvgIcon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></SvgIcon>,
            Flame: (p) => <SvgIcon {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a1 1 0 0 1 .9 3.8z"/></SvgIcon>,
            Gem: (p) => <SvgIcon {...p}><path d="M6 3h12l4 6-10 12L2 9z"/><path d="M11 3v18"/><path d="M6 3l5 6 5-6"/><path d="M2 9h20"/></SvgIcon>,
            ShoppingBag: (p) => <SvgIcon {...p}><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></SvgIcon>,
            ChevronDown: (p) => <SvgIcon {...p}><polyline points="6 9 12 15 18 9"/></SvgIcon>,
            ChevronUp: (p) => <SvgIcon {...p}><polyline points="18 15 12 9 6 15"/></SvgIcon>,
            ChevronRight: (p) => <SvgIcon {...p}><polyline points="9 18 15 12 9 6"/></SvgIcon>,
            Edit: (p) => <SvgIcon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></SvgIcon>,
            GripVertical: (p) => <SvgIcon {...p}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></SvgIcon>,
            Star: (p) => <SvgIcon {...p} fill={p.active ? "currentColor" : "none"}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></SvgIcon>,
            Play: (p) => <SvgIcon {...p}><polygon points="5 3 19 12 5 21 5 3"/></SvgIcon>,
            Pause: (p) => <SvgIcon {...p}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></SvgIcon>,
            AlertCircle: (p) => <SvgIcon {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></SvgIcon>,
            Potion: (p) => <SvgIcon {...p}><path d="M8.5 2h7"/><path d="M12 2v4"/><path d="M16.5 10a4.5 4.5 0 0 0-9 0l-.5 8h10l-.5-8Z"/><line x1="12" y1="12" x2="12" y2="14"/><line x1="10" y1="15" x2="10.5" y2="15"/></SvgIcon>,
            Ticket: (p) => <SvgIcon {...p}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></SvgIcon>,
            Sparkles: (p) => <SvgIcon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 5h4"/></SvgIcon>,
            Cherry: (p) => <SvgIcon {...p}><path d="M2 8a5 5 0 0 0 10 0c0-2.76-2.5-5-5-5-2.5 0-5 2.24-5 5Z"/><path d="M12 8a5 5 0 0 0 10 0c0-2.76-2.5-5-5-5-2.5 0-5 2.24-5 5Z"/><path d="M7 3c2.5-1.5 5 0 10 2"/></SvgIcon>,
            Snowflake: (p) => <SvgIcon {...p}><line x1="12" y1="2" x2="12" y2="22"/><line x1="20" y1="12" x2="4" y2="12"/><line x1="17.66" y1="6.34" x2="6.34" y2="17.66"/><line x1="17.66" y1="17.66" x2="6.34" y2="6.34"/></SvgIcon>,
            Chest: (p) => <SvgIcon {...p}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8"/><path d="M16.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8"/></SvgIcon>,
            Gift: (p) => <SvgIcon {...p}><rect x="3" y="8" width="18" height="4" rx="1" /><path d="M12 8v13" /><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" /><path d="M7.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8" /><path d="M16.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8" /></SvgIcon>,
            Clock: (p) => <SvgIcon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></SvgIcon>,
            Rocket: (p) => <SvgIcon {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></SvgIcon>,
            Divide: (p) => <SvgIcon {...p}><circle cx="12" cy="6" r="2" /><line x1="5" y1="12" x2="19" y2="12" /><circle cx="12" cy="18" r="2" /></SvgIcon>,
            Merge: (p) => <SvgIcon {...p}><path d="m8 6 4-4 4 4"/><path d="M12 2v10.3"/><path d="M12 12.3v8.2"/><path d="m8 18 4 4 4-4"/></SvgIcon>,
            Terminal: (p) => <SvgIcon {...p}><polyline points="4 17 10 11 4 5" /><line x1="12" y1="19" x2="20" y2="19" /></SvgIcon>,
            Search: (p) => <SvgIcon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></SvgIcon>,
            Shield: (p) => <SvgIcon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></SvgIcon>,
            Zap: (p) => <SvgIcon {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></SvgIcon>,
            Trash: (p) => <SvgIcon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></SvgIcon>,
        };

        // --- ÂÖ±ÈÄöUIÈÉ®ÂìÅ ---
        const juicyBtnClass = "transition-all duration-150 transform hover:scale-105 active:scale-95 active:translate-y-1";

        const IconButton = ({ icon: Icon, onClick, className = "", active = false, size = 20, color="text-google-textSec", ...props }) => (
            <button onClick={onClick} className={`p-2 rounded-full flex items-center justify-center hover:bg-google-hover ${active ? 'bg-google-selected text-google-blue' : color} ${className} ${juicyBtnClass}`} {...props}>
                <Icon size={size} active={active} />
            </button>
        );

        const Toast = ({ message, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-2xl shadow-floating z-[120] flex items-center gap-3 animate-toast-in font-black whitespace-nowrap border-b-4 border-red-700">
                    <Icons.AlertCircle size={24} /><span>{message}</span>
                </div>
            );
        };

        const FloatingText = ({ x, y, text, color, scale }) => (
            <div className={`fixed z-[150] pointer-events-none flex items-center gap-1 animate-float-up drop-shadow-md whitespace-nowrap ${color} ${scale}`} style={{ left: x, top: y }}>
                {text}
            </div>
        );

        const IgnitionModal = () => (
            <div className="fixed inset-0 pointer-events-none z-[200] flex items-center justify-center">
                <div className="absolute inset-0 bg-orange-500/20 animate-ignition"></div>
                <div className="text-9xl text-duo-orange animate-ignition flex items-center justify-center drop-shadow-2xl">
                    üî•
                </div>
                <div className="absolute top-1/3 text-4xl font-black text-white animate-ignition drop-shadow-lg uppercase tracking-widest">
                    STREAK IGNITED!
                </div>
            </div>
        );

        // --- Context Menu ---
        const ContextMenu = ({ x, y, onDivide, onMerge, onPurge, showMerge, showPurge }) => (
            <div className="fixed z-[9999] bg-white border-2 border-gray-200 rounded-xl shadow-floating py-1 w-56 animate-scale-in" style={{ left: x, top: y }}>
                <button onClick={onDivide} className="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-2 font-bold text-gray-600 text-sm">
                    <Icons.Divide size={16} /> „Åì„Åì„ÅßÂå∫Âàá„Çã
                </button>
                {showMerge && (
                    <button onClick={onMerge} className="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-2 font-bold text-gray-600 text-sm">
                        <Icons.Merge size={16} /> Âå∫Âàá„Çä„ÇíÂâäÈô§
                    </button>
                )}
                {showPurge && (
                    <div className="border-t border-gray-100 mt-1 pt-1">
                        <button onClick={onPurge} className="w-full text-left px-4 py-3 hover:bg-red-50 flex items-center gap-2 font-bold text-red-500 text-sm">
                            <Icons.Trash size={16} /> Post-MVP„Å∏„Éë„Éº„Ç∏
                        </button>
                    </div>
                )}
            </div>
        );

        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
        const getAdjustedToday = () => {
            const d = new Date(); d.setHours(d.getHours() - 3); return d.toISOString().split('T')[0];
        };

        const Confetti = ({ type, theme }) => {
            const performanceColors = ['bg-yellow-400', 'bg-yellow-300', 'bg-gray-300', 'bg-gray-200'];
            const colors = performanceColors; 
            
            // Checkbox Ignition (Small Confetti)
            const isSmall = type === 'ignition';
            const particlesCount = isSmall ? 8 : (type === 'big' || type === 'performance' ? 45 : 12);
            
            const particles = Array.from({ length: particlesCount }).map((_, i) => ({
                id: i, 
                tx: (Math.random()-0.5)*(isSmall ? 60 : 240), 
                ty: (Math.random()-0.5)*(isSmall ? 60 : 240), 
                size: Math.random()*(isSmall ? 3 : 7)+2, 
                color: colors[Math.floor(Math.random()*colors.length)],
                rotation: Math.random() * 360
            }));

            return (
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-50 overflow-visible">
                    {particles.map(p => (
                        <div key={p.id} className={`absolute rounded-full ${p.color}`} 
                            style={{ 
                                width: p.size, 
                                height: p.size, 
                                '--tx': `${p.tx}px`, '--ty': `${p.ty}px`,
                                animation: 'confetti-explode 0.4s ease-out forwards',
                            }} 
                        />
                    ))}
                </div>
            );
        };

        // --- ÂÆùÁÆ±„É¢„Éº„ÉÄ„É´ ---
        const ChestModal = ({ onClose, onReward }) => {
            const [state, setState] = useState('idle');
            const [reward, setReward] = useState(null);

            const handleOpen = () => {
                if (state !== 'idle') return;
                setState('shaking');
                AudioEngine.play([200, 250, 300], 'sawtooth', 0.1, 0.05);
                
                setTimeout(() => {
                    const roll = Math.random() * 100;
                    console.log("Chest Roll:", roll);
                    let result = {};

                    if (roll < 70) { 
                        result = { type: 'gems', amount: 10, text: '10 Gems', icon: Icons.Gem }; 
                    } else if (roll < 90) { 
                        result = { type: 'gems', amount: 40, text: '40 Gems!', icon: Icons.Gem }; 
                    } else if (roll < 99) { 
                        if (Math.random() < 0.5) {
                             result = { type: 'gems', amount: 100, text: '100 Gems!!', icon: Icons.Gem };
                        } else {
                             result = { type: 'item', itemId: 'freeze', text: 'ÈÄ£Á∂ö„Éï„É™„Éº„Ç∫', icon: Icons.Snowflake };
                        }
                    } else { 
                        result = { type: 'item', itemId: 'ticket', text: 'ËòáÁîü„ÉÅ„Ç±„ÉÉ„Éà', icon: Icons.Ticket }; 
                    }

                    setReward(result);
                    setState('opened');
                    AudioEngine.play([400, 600, 800, 1200], 'sine', 0.2, 0.1);
                    onReward(result);
                }, 800);
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-[200] flex items-center justify-center backdrop-blur-sm animate-in fade-in">
                    <div className="flex flex-col items-center">
                        <div className="relative mb-8 cursor-pointer group" onClick={handleOpen}>
                            {state === 'idle' && (
                                <div className="text-[120px] animate-bounce-soft transition-transform group-hover:scale-110 drop-shadow-2xl">üéÅ</div>
                            )}
                            {state === 'shaking' && (
                                <div className="text-[120px] animate-shake drop-shadow-2xl">üéÅ</div>
                            )}
                            {state === 'opened' && (
                                <div className="relative">
                                    <div className="absolute inset-0 bg-yellow-400 blur-3xl opacity-50 animate-light-burst"></div>
                                    <div className="text-[120px] animate-chest-open">üì¶</div>
                                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 transform scale-150 animate-float-up flex flex-col items-center gap-2">
                                        <div className="text-6xl drop-shadow-md">
                                            {reward?.icon && <reward.icon size={64} className="text-white" fill={reward.type==='gems'?"currentColor":"none"} />}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="text-white text-center min-h-[100px]">
                            {state === 'idle' && <p className="text-2xl font-black animate-pulse">„Çª„ÇØ„Ç∑„Éß„É≥ÂÆå‰∫ÜÔºÅ<br/>ÂÆùÁÆ±„ÇíÈñã„Åë„Çã</p>}
                            {state === 'shaking' && <p className="text-2xl font-black text-yellow-300">„Ç¥„Ç¥„Ç¥„Ç¥...</p>}
                            {state === 'opened' && (
                                <div className="animate-in zoom-in slide-in-from-bottom duration-500">
                                    <p className="text-yellow-300 text-sm font-bold uppercase tracking-widest mb-1">GET REWARD</p>
                                    <p className="text-4xl font-black mb-6">{reward?.text}</p>
                                    <button onClick={onClose} className="bg-white text-duo-green px-8 py-3 rounded-2xl font-black text-xl border-b-4 border-gray-200 active:border-b-0 active:translate-y-[4px] transition-all hover:scale-105">
                                        Âèó„ÅëÂèñ„Çã
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };


        // --- „Çø„Çπ„ÇØÈÉ®ÂìÅ ---
        const TaskItem = ({ task, onToggle, onUpdate, onDelete, onDragStart, isDragging, isMobile, onXpGain, isDeadlineView, activeTheme, onContextMenu, isFocusedSection = true, isLastInSection = false }) => {
            const [isCompleting, setIsCompleting] = useState(false);
            const [confettiType, setConfettiType] = useState(null);
            const [challengeTimeLeft, setChallengeTimeLeft] = useState(null);
            const [animateCheckbox, setAnimateCheckbox] = useState(false);
            const [isEditingTime, setIsEditingTime] = useState(false);
            const [editTimeValue, setEditTimeValue] = useState('9.5');
            const buttonRef = useRef(null);

            useEffect(() => {
                if (!task.challengeEndTime || task.completed) { setChallengeTimeLeft(null); return; }
                const update = () => {
                    const diff = task.challengeEndTime - Date.now();
                    const sec = diff <= 0 ? 0 : Math.ceil(diff / 1000);
                    setChallengeTimeLeft(sec);
                };
                update();
                const timer = setInterval(update, 1000);
                return () => clearInterval(timer);
            }, [task.challengeEndTime, task.completed]);

            const handleToggle = (e) => {
                e.stopPropagation(); // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆ„ÅøÁô∫ÁÅ´„Åï„Åõ„Çã„Åü„ÇÅÂøÖÈ†à
                if (task.completed || isCompleting) return onToggle(task);
                
                const rect = buttonRef.current ? buttonRef.current.getBoundingClientRect() : null;
                const isChallenge = task.challengeEndTime && task.challengeEndTime > Date.now();
                
                // Checkbox Ignition Logic
                setAnimateCheckbox(true);
                // "Kakin!" High pitch sound
                AudioEngine.play([1200, 1800], 'square', 0.1, 0.05);

                const shouldShowConfetti = isChallenge || isLastInSection;

                if (shouldShowConfetti) {
                    setConfettiType('performance');
                    setIsCompleting(true);
                    AudioEngine.play([523.25, 659.25, 783.99, 1046.50], 'triangle', 0.12, 0.06);
                } else {
                     // Small sparks for normal completion
                     setConfettiType('ignition');
                }
                
                setTimeout(() => { 
                    setIsCompleting(false);
                    setAnimateCheckbox(false);
                    onToggle(task); 
                    onXpGain(task, rect, setConfettiType);
                }, 400); 
            };

            const springClass = isCompleting ? "animate-spring" : "";
            const checkboxPop = animateCheckbox ? "animate-checkbox-pop" : "";
            // Section 1‰ª•Â§ñ„ÅØ„ÇØ„É™„ÉÉ„ÇØ‰∏çÂèØ (pointer-events-none)
            const disabledClass = !isFocusedSection && !task.completed ? "pointer-events-none opacity-50 grayscale" : "";

            return (
                <div
                    className={`group flex items-start py-5 px-5 border-b-2 transition-all ${springClass} ${disabledClass} ${isDragging ? 'opacity-50 bg-blue-50' : ''} ${
                        task.completed
                            ? 'bg-gray-50 opacity-60 border-gray-100'
                            : isFocusedSection
                                ? 'bg-white border-gray-200 hover:bg-gray-50'
                                : 'bg-gray-100 border-gray-200'
                    }`}
                    draggable={!task.completed}
                    onDragStart={(e) => {
                        if (!task.completed && onDragStart) {
                            onDragStart(e, task);
                        }
                    }}
                    onContextMenu={(e) => onContextMenu && onContextMenu(e, task)}
                >
                    {/* „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´ */}
                    {!task.completed && (
                        <div className="pt-0.5 pr-2 flex-shrink-0 cursor-move text-gray-300 hover:text-gray-500 transition-colors">
                            <Icons.GripVertical size={18} />
                        </div>
                    )}

                    <div className="pt-0.5 pr-4 flex-shrink-0 relative" ref={buttonRef} onClick={(e) => handleToggle(e)}>
                        {(isCompleting || confettiType === 'ignition') && <Confetti type={confettiType} theme={activeTheme} />}
                        <div className={`w-6 h-6 rounded-xl border-2 flex items-center justify-center transition-all ${checkboxPop} ${
                            task.completed || isCompleting 
                                ? 'bg-duo-blue border-duo-blue scale-110' 
                                : isFocusedSection
                                    ? 'border-gray-300 bg-white text-white group-hover:bg-gray-50' 
                                    : 'border-gray-300 bg-gray-200'
                        }`}>
                            {(task.completed || isCompleting) && <Icons.Check size={16} className="text-gray-500" strokeWidth={4} />}
                        </div>
                    </div>
                    <div className="flex-grow min-w-0 pr-2 pt-0.5">
                        <div className={`text-lg font-black leading-tight ${
                            task.completed
                                ? 'text-gray-400 line-through'
                                : isFocusedSection
                                    ? 'text-gray-900'
                                    : 'text-gray-500'
                        }`}>{task.title}</div>
                    </div>
                    <div className="flex items-center gap-1">
                        {/* Âà∂ÈôêÊôÇÈñìË°®Á§∫: Â∏∏„Å´Ë°®Á§∫„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊôÇ„ÅØ„Éî„É≥„ÇØ„ÄÅÈùû„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊôÇ„ÅØËñÑ„ÅÑ„Ç∞„É¨„Éº */}
                        {!task.completed && (
                            <div className="flex items-center gap-1">
                                {challengeTimeLeft !== null ? (
                                    <span className={`text-[11px] font-black px-3 py-1 rounded-xl border-b-2 shadow-sm ${challengeTimeLeft > 0 ? 'bg-duo-pink text-white border-duo-pinkBorder animate-pulse' : 'bg-gray-200 text-gray-500 border-gray-300'}`}>
                                        {challengeTimeLeft > 0 ? `${Math.floor(challengeTimeLeft / 60)}:${(challengeTimeLeft % 60).toString().padStart(2, '0')}` : 'TIME OVER'}
                                    </span>
                                ) : (
                                    <span
                                        className="text-[11px] font-bold px-3 py-1 rounded-xl bg-gray-50 text-gray-400 border border-gray-200 cursor-pointer hover:bg-gray-100 hover:border-gray-300 transition-colors"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setEditTimeValue(String(task.challengeDuration || 9.5));
                                            setIsEditingTime(true);
                                        }}
                                    >
                                        {task.challengeDuration || 9.5}min
                                    </span>
                                )}
                                {/* ÊôÇÈñìÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ */}
                                {isEditingTime && (
                                    <div className="fixed inset-0 bg-black/50 z-[300] flex items-center justify-center" onClick={() => setIsEditingTime(false)}>
                                        <div className="bg-white rounded-2xl p-6 shadow-floating w-80 animate-scale-in" onClick={(e) => e.stopPropagation()}>
                                            <h3 className="text-lg font-black mb-4 text-gray-700">Set Time Limit</h3>
                                            <div className="flex items-center gap-2 mb-4">
                                                <input
                                                    type="number"
                                                    step="0.5"
                                                    min="0.5"
                                                    value={editTimeValue}
                                                    onChange={(e) => setEditTimeValue(e.target.value)}
                                                    className="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl font-bold text-lg text-center"
                                                />
                                                <span className="font-bold text-gray-500">min</span>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        onUpdate(task.id, { challengeDuration: parseFloat(editTimeValue) });
                                                        setIsEditingTime(false);
                                                    }}
                                                    className="flex-1 bg-duo-blue text-white font-black py-2 rounded-xl hover:scale-105 active:scale-95 transition-transform"
                                                >
                                                    Save
                                                </button>
                                                <button
                                                    onClick={() => setIsEditingTime(false)}
                                                    className="flex-1 bg-gray-200 text-gray-600 font-black py-2 rounded-xl hover:scale-105 active:scale-95 transition-transform"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* „Éú„Çø„É≥Áæ§: Â∏∏„Å´Ë°®Á§∫ */}
                        {!task.completed && (
                            <div className="flex items-center gap-1">
                                {/* ÊåëÊà¶„Éú„Çø„É≥: Â∏∏„Å´Ë°®Á§∫ */}
                                <IconButton
                                    icon={Icons.Flame}
                                    size={18}
                                    className={challengeTimeLeft !== null ? "text-orange-500" : "text-gray-300 hover:text-orange-400 hover:bg-orange-50"}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        const duration = (task.challengeDuration || 9.5) * 60 * 1000;
                                        onUpdate(task.id, { challengeEndTime: Date.now() + duration });
                                    }}
                                />
                                {/* „Åù„ÅÆ‰ªñ„ÅÆ„Éú„Çø„É≥Ôºà„Éõ„Éê„ÉºÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ */}
                                <div className={`flex items-center gap-1 transition-opacity duration-200 ${isMobile ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                                    <IconButton icon={Icons.Star} size={18} active={task.isStarred} className="text-gray-300 hover:text-yellow-400 hover:bg-yellow-50" onClick={(e) => { e.stopPropagation(); onUpdate(task.id, { isStarred: !task.isStarred }); }} />
                                    <IconButton icon={Icons.Trash2} size={18} className="text-gray-300 hover:text-duo-pink hover:bg-red-50" onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} />
                                </div>
                            </div>
                        )}

                        {/* ÂÆå‰∫ÜÊ∏à„Åø„Çø„Çπ„ÇØ„ÅÆ„Éú„Çø„É≥ */}
                        {task.completed && (
                            <div className={`flex items-center gap-1 transition-opacity duration-200 ${isMobile ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                                <IconButton icon={Icons.Trash2} size={18} className="text-gray-300 hover:text-duo-pink" onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- „É°„Ç§„É≥„Ç¢„Éó„É™ ---
        const App = () => {
            const load = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } };
            const [tasks, setTasks] = useState(() => load('duo_v18_tasks', []));
            const [stats, setStats] = useState(() => load('duo_v18_stats', {
                xp: 0, level: 1, gems: 100, streak: 0, lastDate: null, streakFreeze: 0,
                wager: { active: false },
                focusPotion: false,
                resurrectionTickets: 0,
                themes: ['default'], currentTheme: 'default',
                streakBroken: false, savedStreak: 0,
                completedSections: 0,
                devLogs: [],
                mvpScrutinizerActive: true, // „Éá„Éï„Ç©„É´„Éà„ÅßÊúâÂäπ
                devOathActive: false,
                flowCapacitorEndTime: 0,
                tasksCreated: 0,
                tasksPurged: 0,
            }));
            
            const SECTION_SIZE = 4;

            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 768);
            const [activeListId, setActiveListId] = useState('default');
            const [isShopOpen, setIsShopOpen] = useState(false);
            const [isDoubleChance, setIsDoubleChance] = useState(false);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [timerState, setTimerState] = useState({ active: false, time: 52 * 60, mode: 'work' });
            const [isCompletedOpen, setIsCompletedOpen] = useState(false);
            const [toastMessage, setToastMessage] = useState(null);
            const [showChestModal, setShowChestModal] = useState(false);
            const [levelGlow, setLevelGlow] = useState(false);
            const [progressGlow, setProgressGlow] = useState(false);
            const [showIgnition, setShowIgnition] = useState(false);
            const [floatingTexts, setFloatingTexts] = useState([]);
            
            const [contextMenu, setContextMenu] = useState(null);

            // Progress Bar Animation State
            const [progressBounce, setProgressBounce] = useState(false);

            // Drag & Drop State
            const [draggedTaskId, setDraggedTaskId] = useState(null);
            const [dragOverTaskId, setDragOverTaskId] = useState(null);

            const closeToast = useCallback(() => {
                setToastMessage(null);
            }, []);

            useEffect(() => {
                const h = () => { const m = window.innerWidth < 768; setIsMobile(m); if(!m) setIsSidebarOpen(true); };
                window.addEventListener('resize', h); return () => window.removeEventListener('resize', h);
            }, []);

            useEffect(() => {
                const handleClick = () => setContextMenu(null);
                window.addEventListener('click', handleClick);
                return () => window.removeEventListener('click', handleClick);
            }, []);

            useEffect(() => {
                localStorage.setItem('duo_v18_tasks', JSON.stringify(tasks));
                localStorage.setItem('duo_v18_stats', JSON.stringify(stats));
            }, [tasks, stats]);

            useEffect(() => {
                const today = getAdjustedToday();
                // Dev's Oath Check
                if (stats.devOathActive && stats.lastDate !== today) {
                    // Logic for oath check would go here
                }
                
                if (stats.lastDate && stats.lastDate !== today) {
                    const last = new Date(stats.lastDate); const curr = new Date(today);
                    const diff = (curr - last) / (1000 * 60 * 60 * 24);
                    if (diff > 1 && stats.streak > 0 && !stats.streakBroken) {
                        if (stats.streakFreeze > 0) {
                            setStats(s => ({ ...s, streakFreeze: s.streakFreeze - 1, lastDate: today }));
                            setToastMessage("„Éï„É™„Éº„Ç∫Áô∫ÂãïÔºÅStreak„ÅØÂÆà„Çâ„Çå„Åæ„Åó„Åü‚ùÑÔ∏è");
                        } else {
                            setStats(s => ({ ...s, streakBroken: true, savedStreak: s.streak, streak: 0 }));
                        }
                    }
                }
            }, []);

            useEffect(() => {
                let timer = null;
                if (timerState.active && timerState.time > 0) {
                    timer = setInterval(() => setTimerState(s => ({ ...s, time: s.time - 1 })), 1000);
                } else if (timerState.time === 0) {
                    const isWork = timerState.mode === 'work';
                    setTimerState({ active: false, mode: isWork ? 'break' : 'work', time: isWork ? 17 * 60 : 52 * 60 });
                    AudioEngine.play([880, 440], 'sine', 0.15, 0.2);

                    setStats(s => {
                        if (s.wager.active) {
                            setToastMessage("ÂÄç„ÅãÁÑ°„Åã... Â§±Êïó üò¢");
                            return { ...s, wager: { active: false } };
                        }
                        return s;
                    });
                }
                return () => clearInterval(timer);
            }, [timerState.active, timerState.time]);

            const switchTimerMode = (mode) => {
                const time = mode === 'work' ? 52 * 60 : 17 * 60;
                setTimerState({ active: false, mode, time });
                if (mode === 'break') {
                     setStats(s => {
                        if (s.wager.active) {
                            setToastMessage("ÂÄç„ÅãÁÑ°„Åã... Â§±Êïó üò¢");
                            return { ...s, wager: { active: false } };
                        }
                        return s;
                    });
                }
            };

            const resurrectStreak = () => {
                if (stats.resurrectionTickets > 0 && stats.streakBroken) {
                    setStats(s => ({
                        ...s,
                        streak: s.savedStreak,
                        streakBroken: false,
                        resurrectionTickets: s.resurrectionTickets - 1,
                        lastDate: getAdjustedToday()
                    }));
                    setToastMessage("StreakÂæ©Ê¥ªÔºÅüî•");
                    AudioEngine.play([523, 659, 784, 1046], 'sine', 0.2, 0.1);
                }
            };

            const handleContextMenu = (e, task) => {
                e.preventDefault();
                setContextMenu({ x: e.clientX, y: e.clientY, task });
            };

            const toggleSectionBreak = () => {
                if (!contextMenu) return;
                const currentIndex = tasks.findIndex(t => t.id === contextMenu.task.id);
                if (currentIndex === -1 || currentIndex === tasks.length - 1) return;

                const nextTask = tasks[currentIndex + 1];
                const isHead = nextTask.isSectionHead;

                setTasks(tasks.map((t, idx) => 
                    idx === currentIndex + 1 ? { ...t, isSectionHead: !isHead } : t
                ));
                setContextMenu(null);
            };

            // MVP Scrutinizer: „Éë„Éº„Ç∏Ê©üËÉΩ
            const purgeTask = () => {
                if (!contextMenu) return;
                const taskToPurge = contextMenu.task;

                // „Çø„Çπ„ÇØ„ÇíÊú´Â∞æ„Å∏ÁßªÂãï
                const newTasks = tasks.filter(t => t.id !== taskToPurge.id);
                newTasks.push(taskToPurge);

                setTasks(newTasks);
                setContextMenu(null);

                // „Éë„Éº„Ç∏Â†±ÈÖ¨: MVPÊúÄÈÅ©ÂåñË°åÂãï„Å™„ÅÆ„ÅßÈ´òÂ†±ÈÖ¨
                const purgeReward = 25;
                setStats(s => ({
                    ...s,
                    gems: s.gems + purgeReward,
                    tasksPurged: s.tasksPurged + 1
                }));

                setToastMessage(`‚ú® MVPÊúÄÈÅ©ÂåñÔºÅ+${purgeReward}üíé`);
                AudioEngine.play([400, 600, 800], 'sine', 0.15, 0.08);
            };

            const checkSectionCompletion = (completedTaskId) => {
                let sectionTasks = [];
                let currentSection = [];
                
                for (let i = 0; i < tasks.length; i++) {
                    const t = tasks[i];
                    if (i > 0 && t.isSectionHead) {
                        if (currentSection.length > 0) sectionTasks.push(currentSection);
                        currentSection = [];
                    }
                    currentSection.push(t);
                }
                if (currentSection.length > 0) sectionTasks.push(currentSection);

                const targetSection = sectionTasks.find(section => section.some(t => t.id === completedTaskId));

                if (targetSection) {
                    const allCompleted = targetSection.every(t => t.id === completedTaskId || t.completed);
                    if (allCompleted) {
                        return true;
                    }
                }
                return false;
            };

            const handleXpGain = (task, rect, setConfettiType, manualXp = 0) => {
                const today = getAdjustedToday();
                const now = new Date();
                const currentHour = now.getHours();

                // Section 1Âà§ÂÆö
                let section1Tasks = [];
                for (let t of tasks) {
                    if (section1Tasks.length > 0 && t.isSectionHead) break;
                    section1Tasks.push(t);
                }
                const isSection1Task = section1Tasks.some(t => t.id === task.id);

                // 1. Determine Reward Type & Amount
                let rewardAmount = 2; // Default: Focus (Normal)
                let rewardType = 'normal'; // normal, velocity, morning, milestone, mvpSprint
                let logText = "";

                // Milestone (100üíé): Section 1 Complete - ÊúÄÈ´òÂ†±ÈÖ¨
                const isSectionComplete = checkSectionCompletion(task.id);
                if (isSectionComplete && isSection1Task) {
                    rewardAmount = 100;
                    rewardType = 'milestone';
                    logText = "[üöÄ MVP SPRINT] Section 1„ÇØ„É™„Ç¢ÔºÅMVPÊ©üËÉΩ„ÅåÂÆåÊàê„Åó„Åæ„Åó„Åü„ÄÇ";
                } else if (isSectionComplete) {
                    rewardAmount = 50;
                    rewardType = 'milestone';
                    logText = "[Milestone] Section „ÇØ„É™„Ç¢„ÄÇ";
                }

                // Morning Ignition (30üíé): Before 13PM & First Task
                const isFirstTaskToday = stats.lastDate !== today;
                if (currentHour < 13 && isFirstTaskToday && rewardAmount < 30) {
                    rewardAmount = 30;
                    rewardType = 'morning';
                    logText = `[Early Bird] Êúù„ÅÆÁùÄÁÅ´ÊàêÂäü„ÄÇ${task.title} „ÇíÂÆå‰∫Ü„ÄÇ`;
                }

                // High Velocity (20üíé for Section 1, 15üíé for others)
                const isChallenge = task.challengeEndTime && task.challengeEndTime > Date.now();
                const isFlowActive = Date.now() < stats.flowCapacitorEndTime;

                if ((isChallenge || isFlowActive) && rewardAmount < 15) {
                    rewardAmount = isSection1Task ? 20 : 15;
                    rewardType = 'velocity';
                    logText = isSection1Task
                        ? `[‚ö° MVP Focus] ${task.title} „ÇíÊúÄÈÄü„ÅßÂÆåÈÅÇ„ÄÇ„É™„É™„Éº„Çπ„ÅåËøë„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ`
                        : `[High Velocity] „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØÊàêÂäü„ÄÇ${task.title} „ÇíÊúÄÁü≠Â∑•Êï∞„ÅßÂÆåÈÅÇ„Åó„Åæ„Åó„Åü„ÄÇ`;
                }

                // MVP Task Bonus: Section 1„ÅÆ„Çø„Çπ„ÇØ„ÅØÂü∫Á§éÂ†±ÈÖ¨Â¢óÂä†
                if (isSection1Task && rewardAmount < 10) {
                    rewardAmount = 10;
                    rewardType = 'mvpFocus';
                    logText = `[MVP Task] ${task.title} ÂÆå‰∫Ü„ÄÇMVPÈñãÁô∫„ÇíÂâçÈÄ≤„Åï„Åõ„Åæ„Åó„Åü„ÄÇ`;
                }

                // Normal log if not specified
                if (!logText) {
                    logText = `[Focus] ${task.title} ÂÆå‰∫Ü„ÄÇ`;
                }

                let wagerBonus = 0;
                let wagerComplete = false;

                // Progress Bar Shimmer & Bounce
                setLevelGlow(true);
                setProgressBounce(true);
                setTimeout(() => setLevelGlow(false), 500);
                setTimeout(() => setProgressBounce(false), 500);
                
                setProgressGlow(true);
                setTimeout(() => setProgressGlow(false), 700);

                // Confetti & Floating Text Setup
                if (setConfettiType) {
                    // Always show small sparks (ignition) for normal
                    // Show performance confetti for higher rewards
                    if (rewardAmount >= 15) {
                          setConfettiType('performance');
                          AudioEngine.play([440, 554, 659, 880], 'square', 0.2, 0.1);
                    } else {
                          setConfettiType('ignition');
                    }
                }

                setStats(prev => {
                    const isFirstTaskToday = prev.lastDate !== today;
                    if (isFirstTaskToday) {
                        setShowIgnition(true); 
                        setTimeout(() => setShowIgnition(false), 2000);
                        AudioEngine.play([100, 150, 200, 300, 500], 'sawtooth', 0.2, 0.1);
                    }
                    
                    // Dev's Oath Success
                    let oathBonus = 0;
                    if (isFirstTaskToday && prev.devOathActive) {
                        oathBonus = 100;
                        setToastMessage("Dev's Oath ÈÅîÊàêÔºÅ100üíéËøîÈÇÑÔºÅ");
                    }

                    // XPÂä†ÁÆóÂâäÈô§
                    let newXp = prev.xp;
                    let newLevel = prev.level;
                    let newStreak = prev.streak;
                    let newWager = { ...prev.wager };
                    let newGems = prev.gems + rewardAmount; // Use calculated reward

                    if (isFirstTaskToday) {
                        if (!prev.lastDate) { 
                            newStreak = 1; 
                        } else {
                            const last = new Date(prev.lastDate); const curr = new Date(today);
                            const diff = (curr - last) / (1000 * 60 * 60 * 24);
                            
                            if (diff <= 1) {
                                newStreak++;
                            } else { 
                                newStreak = 1; 
                            }
                        }
                    }

                    // Wager Logic (Simplified: Active & Challenge Success = Win)
                    if (prev.wager.active && (isChallenge || isFlowActive)) {
                         wagerBonus = 100;
                         wagerComplete = true;
                         newWager = { active: false };
                    }

                    if (wagerBonus > 0) newGems += wagerBonus;
                    if (oathBonus > 0) newGems += oathBonus;

                    if (wagerComplete) setToastMessage("ÂÄç„ÅãÁÑ°„ÅãÈÅîÊàêÔºÅ100üíéÁç≤ÂæóÔºÅ");

                    // Floating Text Style Logic
                    let floatColor = "text-slate-400 text-sm";
                    let floatScale = "scale-100";
                    let floatText = `+${rewardAmount}üíé`;

                    if (rewardAmount >= 100) {
                        floatColor = "text-yellow-400 font-black";
                        floatScale = "scale-[2] animate-bounce-hard";
                        floatText = `üöÄ +${rewardAmount}üíé`;
                    } else if (rewardAmount >= 50) {
                        floatColor = "text-fuchsia-500 font-black";
                        floatScale = "scale-150 animate-bounce-hard";
                    } else if (rewardAmount >= 30) {
                        floatColor = "text-amber-500 font-bold";
                        floatScale = "scale-125";
                    } else if (rewardAmount >= 15) {
                        floatColor = "text-cyan-400 font-bold";
                        floatScale = "scale-110";
                    } else if (rewardAmount >= 10) {
                        floatColor = "text-blue-400 font-bold";
                        floatScale = "scale-105";
                    }

                    // Log Logic
                    let newLogs = prev.devLogs || [];
                    // Log Color based on reward type for display logic later
                    let logColorClass = "text-gray-600";
                    if (rewardType === 'milestone') logColorClass = "text-yellow-600 font-black";
                    else if (rewardType === 'morning') logColorClass = "text-amber-600 font-bold";
                    else if (rewardType === 'velocity') logColorClass = "text-cyan-600 font-bold";
                    else if (rewardType === 'mvpFocus') logColorClass = "text-blue-600 font-bold";

                    // Prepend timestamp to text for simple display or store structure
                    const logEntry = { 
                        id: Date.now(), 
                        text: logText, 
                        date: new Date().toLocaleTimeString(),
                        colorClass: logColorClass 
                    };
                    newLogs = [logEntry, ...newLogs].slice(0, 20);

                    // Add Floating Text
                    if (rect) {
                        const id = Date.now();
                        setFloatingTexts(prev => [...prev, { id, x: rect.left + 50, y: rect.top - 20, text: floatText, color: floatColor, scale: floatScale }]);
                        setTimeout(() => setFloatingTexts(prev => prev.filter(t => t.id !== id)), 1000);
                    }

                    return { 
                        ...prev, xp: newXp, level: newLevel, gems: newGems, streak: newStreak, lastDate: today, 
                        wager: newWager,
                        streakBroken: false,
                        devLogs: newLogs,
                        devOathActive: oathBonus > 0 ? false : prev.devOathActive
                    };
                });
            };

            const buyItem = (cost, action) => {
                if (stats.gems < cost) {
                    setToastMessage("„Ç∏„Çß„É†„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅüíé");
                    AudioEngine.play([150, 100], 'sawtooth', 0.1, 0.1);
                    return;
                }
                setStats(prev => ({ ...prev, gems: prev.gems - cost }));
                action(); 
                AudioEngine.play([783, 1046], 'sine', 0.1, 0.1);
            };

            const handleReward = (reward) => {
                if (reward.type === 'gems') {
                    setStats(prev => ({ ...prev, gems: prev.gems + reward.amount }));
                } else if (reward.itemId === 'freeze') {
                    setStats(prev => ({ ...prev, streakFreeze: prev.streakFreeze + 1 }));
                } else if (reward.itemId === 'ticket') {
                    setStats(prev => ({ ...prev, resurrectionTickets: prev.resurrectionTickets + 1 }));
                }
                setToastMessage(`${reward.text} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`);
            };

            const unlockTheme = (themeName, cost) => {
                if (stats.themes.includes(themeName)) {
                    setStats(s => ({ ...s, currentTheme: themeName }));
                    setToastMessage("„ÉÜ„Éº„Éû„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åüüé®");
                } else {
                    buyItem(cost, () => {
                        setStats(s => ({ ...s, themes: [...s.themes, themeName], currentTheme: themeName }));
                        setToastMessage("Êñ∞„ÉÜ„Éº„ÉûÁç≤ÂæóÔºÅ‚ú®");
                    });
                }
            };

            const updateTask = (id, updates) => setTasks(tasks.map(t => t.id === id ? { ...t, ...updates } : t));

            // „Çø„Çπ„ÇØ„ÅÆ‰∏¶„Å≥Êõø„ÅàÊ©üËÉΩ
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÈñ¢Êï∞
            const handleDragStart = (e, task) => {
                setDraggedTaskId(task.id);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, task) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverTaskId(task.id);
            };

            const handleDrop = (e, dropTask) => {
                e.preventDefault();

                if (!draggedTaskId || draggedTaskId === dropTask.id) {
                    setDraggedTaskId(null);
                    setDragOverTaskId(null);
                    return;
                }

                const draggedIndex = tasks.findIndex(t => t.id === draggedTaskId);
                const dropIndex = tasks.findIndex(t => t.id === dropTask.id);

                if (draggedIndex === -1 || dropIndex === -1) {
                    setDraggedTaskId(null);
                    setDragOverTaskId(null);
                    return;
                }

                const newTasks = [...tasks];
                const [draggedTask] = newTasks.splice(draggedIndex, 1);
                newTasks.splice(dropIndex, 0, draggedTask);

                setTasks(newTasks);
                setDraggedTaskId(null);
                setDragOverTaskId(null);
            };

            const handleDragEnd = () => {
                setDraggedTaskId(null);
                setDragOverTaskId(null);
            };

            const visibleTasks = tasks.filter(t => activeListId === 'default' ? !t.listId || t.listId === 'default' : t.listId === activeListId);
            const incomplete = visibleTasks.filter(t => !t.completed);
            const completed = visibleTasks.filter(t => t.completed);
            
            const totalTasks = tasks.length;
            const completedTasksCount = tasks.filter(t => t.completed).length;
            const completionRate = totalTasks === 0 ? 0 : Math.round((completedTasksCount / totalTasks) * 100);

            // Calculate Section 1 completion for Rocket Pulse
            let section1Tasks = [];
            for (let t of tasks) {
                 if (section1Tasks.length > 0 && t.isSectionHead) break; 
                 section1Tasks.push(t);
            }
            const section1Total = section1Tasks.length;
            const section1Completed = section1Tasks.filter(t => t.completed).length;
            const section1Rate = section1Total === 0 ? 0 : section1Completed / section1Total;
            // Pulse speed depends on rate. 0.2s (fast) to 2s (slow)
            const pulseDuration = section1Rate > 0 ? Math.max(0.2, 2 - (section1Rate * 1.8)) + 's' : '0s';


            const btn3DClass = "transition-all active:translate-y-[4px] active:border-b-0 border-b-[4px] hover:scale-105 active:scale-95 duration-150";
            
            const isStreakActive = stats.lastDate === getAdjustedToday();

            let sectionCounter = 0; 

            // Helper to determine if a task is the last in its section (of incomplete tasks)
            const isLastTaskInSection = (index) => {
                 const nextTask = incomplete[index + 1];
                 return !nextTask || nextTask.isSectionHead;
            };

            return (
                <div className="flex h-screen w-full bg-white overflow-hidden relative selection:bg-duo-green/20 font-bold text-duo-text">
                    
                    {/* Header */}
                    <header className="fixed top-0 left-0 right-0 h-16 bg-white border-b-2 border-gray-100 z-[100] flex items-center justify-between px-6">
                        {/* Left: Menu Button */}
                        <div className="flex-shrink-0 z-20">
                            <IconButton icon={Icons.Menu} onClick={() => setIsSidebarOpen(!isSidebarOpen)} />
                        </div>

                        {/* Center: Project Progress Bar (MVP Progress) */}
                        <div className="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-[500px] px-4 hidden md:block">
                            <div className={`relative h-8 bg-gray-100 rounded-full overflow-hidden border-2 border-gray-200 shadow-inner ${levelGlow ? 'animate-pulse' : ''}`}>
                                <div className={`h-full bg-gradient-to-r from-duo-green to-duo-greenHighlight transition-all duration-700 ease-out relative ${levelGlow ? 'progress-glow brightness-125' : ''}`} style={{ width: `${completionRate}%` }}>
                                     <div className="absolute inset-0 bg-white/20 animate-shimmer" style={{ backgroundSize: '200% 100%' }} />
                                </div>
                                <div className={`absolute inset-0 flex items-center justify-center gap-2 z-10 transition-transform ${progressBounce ? 'scale-110' : ''}`}>
                                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest opacity-40" style={{ textShadow: '0 1px 0 rgba(255,255,255,0.8)' }}>MVP Progress</span>
                                    <span className={`text-xs font-black ${progressBounce ? 'text-duo-green' : 'text-slate-600'}`} style={{ textShadow: '0 1px 0 rgba(255,255,255,0.6)' }}>{completionRate}%</span>
                                </div>
                                <div className="absolute right-2 top-1/2 transform -translate-y-1/2 text-lg z-20" style={{ animation: section1Rate > 0 && section1Rate < 1 ? `pulse ${pulseDuration} cubic-bezier(0.4, 0, 0.6, 1) infinite` : 'none', color: section1Rate > 0.8 ? '#ef4444' : 'currentColor', filter: 'drop-shadow(0 1px 1px rgba(0,0,0,0.1))' }}>üöÄ</div>
                            </div>
                        </div>

                        {/* Right: Reward Units (Streak & Gem) */}
                        <div className="flex items-center gap-2 z-20">
                            {/* Streak Unit */}
                            <div className="relative">
                                <button className={`flex items-center gap-1.5 px-3 py-1.5 rounded-2xl transition-all group ${isStreakActive ? 'hover:bg-gray-50' : ''}`}>
                                    <Icons.Flame 
                                        size={26} 
                                        fill="currentColor" 
                                        className={`transition-colors duration-500 ${!stats.streakBroken && isStreakActive ? "text-duo-orange" : "text-[#e5e5e5]"}`} 
                                    />
                                    <span className={`text-lg font-black transition-colors duration-500 ${!stats.streakBroken && isStreakActive ? "text-duo-orange" : "text-[#e5e5e5]"}`}>
                                        {stats.streakBroken ? 0 : stats.streak}
                                    </span>
                                </button>
                                {stats.streakBroken && stats.resurrectionTickets > 0 && (
                                    <button onClick={resurrectStreak} className={`absolute -bottom-8 left-1/2 -translate-x-1/2 bg-duo-blue text-white text-xs font-black px-3 py-1 rounded-xl whitespace-nowrap animate-bounce border-b-4 border-duo-blueBorder ${btn3DClass} z-50`}>
                                        Âæ©Ê¥ªÔºÅ
                                    </button>
                                )}
                            </div>

                            {/* Gem Unit */}
                            <button className={`flex items-center gap-1.5 px-3 py-1.5 rounded-2xl transition-all group ${isStreakActive ? 'hover:bg-gray-50' : ''}`}>
                                <Icons.Gem 
                                    size={26} 
                                    fill="currentColor" 
                                    className={`transition-transform duration-500 ${!stats.streakBroken && isStreakActive ? "text-duo-pink" : "text-[#e5e5e5]"}`} 
                                />
                                <span className={`text-lg font-black transition-colors duration-500 ${!stats.streakBroken && isStreakActive ? "text-duo-pink" : "text-[#e5e5e5]"}`}>
                                    {stats.gems}
                                </span>
                            </button>
                        </div>
                    </header>

                    {/* Sidebar */}
                    {isMobile && isSidebarOpen && <div className="fixed inset-0 bg-black/40 z-[80] backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)} />}
                    <aside className={`fixed inset-y-0 left-0 transform transition-all duration-300 z-[90] w-72 bg-white border-r-2 border-duo-gray pt-20 flex flex-col ${isSidebarOpen ? 'translate-x-0 shadow-xl' : '-translate-x-full'}`}>
                        {/* Streak Section */}
                        <div className="p-4 mb-2">
                            <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-3">‰ªäÊó•„ÅÆË®òÈå≤</h3>
                            <div className={`flex items-center gap-4 p-3 rounded-2xl border-2 transition-colors duration-500 ${isStreakActive ? 'bg-orange-50 border-orange-100' : 'bg-gray-50 border-gray-200'}`}>
                                <div className="relative group cursor-pointer transition-transform hover:scale-110">
                                    <Icons.Flame size={32} className={`transition-colors duration-1000 ${isStreakActive ? "text-duo-orange" : "text-gray-300"}`} fill="currentColor" />
                                    {stats.streakBroken && stats.resurrectionTickets > 0 && (
                                        <button onClick={resurrectStreak} className="absolute -bottom-2 -right-4 bg-duo-blue text-white text-[10px] font-black px-2 py-0.5 rounded-lg whitespace-nowrap animate-bounce shadow-sm">
                                            Âæ©Ê¥ªÔºÅ
                                        </button>
                                    )}
                                </div>
                                <div>
                                    <div className={`text-xl font-black transition-colors duration-1000 ${isStreakActive ? "text-duo-orange" : "text-gray-400"}`}>
                                        {stats.streakBroken ? 0 : stats.streak}Êó•ÈÄ£Á∂ö
                                    </div>
                                    <div className="text-xs text-gray-400 font-bold">{isStreakActive ? "Keep it burning!" : "„Çø„Çπ„ÇØÂÆå‰∫Ü„ÅßÁùÄÁÅ´ÔºÅ"}</div>
                                </div>
                            </div>
                        </div>

                        {/* Compact Focus Bar (Moved to Sidebar) */}
                        <div className="px-4 mb-6">
                            <div className="w-full bg-white border-2 border-gray-200 border-b-4 rounded-2xl p-2 flex items-center justify-between shadow-sm hover:shadow-md transition-all">
                                <button onClick={() => setTimerState(s => ({ ...s, active: !s.active }))} 
                                    className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${btn3DClass} ${timerState.active ? 'bg-gray-100 text-gray-400 border-gray-300' : 'bg-duo-blue text-white border-duo-blueBorder'}`}>
                                    {timerState.active ? <Icons.Pause size={18} fill="currentColor"/> : <Icons.Play size={18} fill="currentColor" className="ml-0.5"/>}
                                </button>
                                <div className="text-xl font-black font-mono tracking-tighter text-duo-text">
                                    {Math.floor(timerState.time / 60)}:{(timerState.time % 60).toString().padStart(2, '0')}
                                </div>
                                <div className="flex flex-col gap-1">
                                    <button onClick={() => switchTimerMode('work')} className={`text-[9px] font-black px-2 py-0.5 rounded ${timerState.mode === 'work' ? 'bg-duo-blue/10 text-duo-blue' : 'text-gray-400'}`}>ÈõÜ‰∏≠</button>
                                    <button onClick={() => switchTimerMode('break')} className={`text-[9px] font-black px-2 py-0.5 rounded ${timerState.mode === 'break' ? 'bg-duo-green/10 text-duo-green' : 'text-gray-400'}`}>‰ºëÊÜ©</button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-6 border-t-2 border-duo-gray">
                            <div className="space-y-3">
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest px-2">Lists</h3>
                                <button className={`w-full p-4 flex items-center gap-4 rounded-2xl font-black ${btn3DClass} ${activeListId === 'default' ? 'bg-duo-blue/10 text-duo-blue border-duo-blue/20' : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-500'}`} onClick={() => { setActiveListId('default'); if(isMobile) setIsSidebarOpen(false); }}><Icons.Check size={24} />„Éû„Ç§„Çø„Çπ„ÇØ</button>
                                <button className={`w-full p-4 flex items-center gap-4 rounded-2xl font-black ${btn3DClass} ${activeListId === 'deadline' ? 'bg-duo-pink/10 text-duo-pink border-duo-pink/20' : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-500'}`} onClick={() => { setActiveListId('deadline'); if(isMobile) setIsSidebarOpen(false); }}><Icons.Calendar size={24} />Á∑†Âàá„É™„Çπ„Éà</button>
                            </div>

                            {/* MVP Stats */}
                            <div className="mb-4">
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2 px-2">MVPÈñãÁô∫ÊåáÊ®ô</h3>
                                <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 border-2 border-blue-200 space-y-2">
                                    <div className="flex justify-between items-center">
                                        <span className="text-xs font-bold text-gray-600">üéØ ‰ΩúÊàê„Çø„Çπ„ÇØÊï∞</span>
                                        <span className="text-sm font-black text-blue-600">{stats.tasksCreated || 0}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-xs font-bold text-gray-600">‚ú® ÊúÄÈÅ©ÂåñÂõûÊï∞</span>
                                        <span className="text-sm font-black text-purple-600">{stats.tasksPurged || 0}</span>
                                    </div>
                                    <div className="mt-3 pt-2 border-t border-blue-200">
                                        <div className="text-[10px] font-bold text-gray-500 text-center">
                                            {stats.tasksPurged >= 3 ? "üèÜ „Éû„Çπ„Çø„ÉºÁ¥ö„ÅÆÊúÄÈÅ©ÂåñÔºÅ" : stats.tasksPurged >= 1 ? "üëç MVPÊÄùËÄÉ„ÅåË∫´„Å´„Å§„ÅÑ„Å¶„ÅÑ„Åæ„Åô" : "üí° ‰∏çË¶Å„Å™„Çø„Çπ„ÇØ„ÅØ„Éë„Éº„Ç∏„Åó„Çà„ÅÜ"}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Dev Log Moved Here (Above Gem Shop) */}
                            <div>
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2 px-2">ÈñãÁô∫„É≠„Ç∞</h3>
                                <div className="bg-white rounded-xl p-4 border-2 border-gray-200 h-56 overflow-y-auto space-y-3">
                                    {stats.devLogs && stats.devLogs.length > 0 ? (
                                        stats.devLogs.map((log, i) => (
                                            <div key={log.id} className={`text-xs font-medium leading-relaxed border-l-4 border-l-gray-300 pl-3 py-2 ${i === 0 ? 'animate-log-fade bg-blue-50' : 'bg-gray-50'} rounded-r ${log.colorClass}`}>
                                                <span className="text-gray-500 block mb-1 font-bold text-[11px]">{log.date}</span>
                                                <span className="block">{log.text}</span>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="text-xs text-gray-500 text-center py-6 font-medium">„É≠„Ç∞„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                                    )}
                                </div>
                            </div>

                            <div className="pt-6 border-t-2 border-duo-gray/50 pb-20">
                                <button onClick={() => setIsShopOpen(!isShopOpen)} className={`w-full flex items-center justify-between px-4 py-3 rounded-2xl transition-all font-black text-gray-500 bg-white border-2 border-transparent hover:bg-gray-50 ${isShopOpen ? 'text-duo-text' : ''} ${juicyBtnClass}`}>
                                    <div className="flex items-center gap-2 text-xs uppercase tracking-widest"><Icons.ShoppingBag size={18}/> Gem Shop</div>
                                    {isShopOpen ? <Icons.ChevronDown size={18} /> : <Icons.ChevronRight size={18} />}
                                </button>
                                {isShopOpen && (
                                    <div className="mt-4 space-y-3 animate-in fade-in slide-in-from-top-1 pb-20 px-1">
                                        <div className={`p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all bg-white hover:scale-105 active:scale-95`} onClick={() => buyItem(200, () => setStats(s => ({...s, streakFreeze: s.streakFreeze + 1})))}>
                                            <div className="text-left"><div className="font-black text-sm text-duo-blue flex items-center gap-1"><Icons.Snowflake size={16}/> ÈÄ£Á∂ö„Éï„É™„Éº„Ç∫ ({stats.streakFreeze})</div><div className="text-[10px] text-gray-400 font-bold">Streak„Çí1Êó•ÂÆà„Çã</div></div>
                                            <div className="text-duo-pink font-black text-sm">200üíé</div>
                                        </div>
                                        
                                        {/* MVP Scrutinizer */}
                                        <div className={`p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${stats.mvpScrutinizerActive ? 'bg-blue-50 border-blue-200' : 'bg-white'}`} 
                                             onClick={() => !stats.mvpScrutinizerActive && buyItem(100, () => setStats(s => ({...s, mvpScrutinizerActive: true})))}>
                                            <div className="text-left">
                                                <div className="font-black text-sm text-duo-blue flex items-center gap-1"><Icons.Search size={16}/> MVP Scrutinizer</div>
                                                <div className="text-[10px] text-gray-400 font-bold">Âè≥„ÇØ„É™„ÉÉ„ÇØ„Åß„Çø„Çπ„ÇØ„Çí„Éë„Éº„Ç∏</div>
                                            </div>
                                            {!stats.mvpScrutinizerActive ? <div className="text-duo-pink font-black text-sm">100üíé</div> : <div className="text-[10px] font-black text-blue-600 bg-blue-100 px-2 py-1 rounded-lg">ON</div>}
                                        </div>

                                        {/* Dev's Oath */}
                                        <div className={`p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${stats.devOathActive ? 'bg-purple-50 border-purple-200' : 'bg-white'}`} 
                                             onClick={() => !stats.devOathActive && buyItem(50, () => setStats(s => ({...s, devOathActive: true})))}>
                                            <div className="text-left">
                                                <div className="font-black text-sm text-purple-600 flex items-center gap-1"><Icons.Shield size={16}/> Dev's Oath</div>
                                                <div className="text-[10px] text-gray-400 font-bold">ÊòéÊó•„ÅÆ„Çø„Çπ„ÇØÂÆå‰∫Ü„ÇíË™ì„ÅÜ</div>
                                            </div>
                                            {!stats.devOathActive ? <div className="text-duo-pink font-black text-sm">50üíé</div> : <div className="text-[10px] font-black text-purple-600 bg-purple-100 px-2 py-1 rounded-lg">Ë™ìÁ¥ÑÊ∏à</div>}
                                        </div>

                                        {/* Flow Capacitor */}
                                        <div className={`p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${Date.now() < stats.flowCapacitorEndTime ? 'bg-yellow-50 border-yellow-200' : 'bg-white'}`} 
                                             onClick={() => Date.now() > stats.flowCapacitorEndTime && buyItem(150, () => setStats(s => ({...s, flowCapacitorEndTime: Date.now() + 15 * 60 * 1000})))}>
                                            <div className="text-left">
                                                <div className="font-black text-sm text-yellow-600 flex items-center gap-1"><Icons.Zap size={16}/> Flow Capacitor</div>
                                                <div className="text-[10px] text-gray-400 font-bold">15ÂàÜÈñì„ÄÅÊºîÂá∫Á¢∫Áéá100%</div>
                                            </div>
                                            {Date.now() > stats.flowCapacitorEndTime ? <div className="text-duo-pink font-black text-sm">150üíé</div> : <div className="text-[10px] font-black text-yellow-600 bg-yellow-100 px-2 py-1 rounded-lg">Active</div>}
                                        </div>

                                        <div className="p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all bg-white hover:scale-105 active:scale-95" onClick={() => buyItem(150, () => setStats(s => ({...s, resurrectionTickets: s.resurrectionTickets + 1})))}>
                                            <div className="text-left"><div className="font-black text-sm text-gray-600 flex items-center gap-1"><Icons.Ticket size={16}/> ËòáÁîü„ÉÅ„Ç±„ÉÉ„Éà ({stats.resurrectionTickets})</div><div className="text-[10px] text-gray-400 font-bold">StreakÂàá„Çå„ÇíÂæ©Ê¥ª</div></div>
                                            <div className="text-duo-pink font-black text-sm">150üíé</div>
                                        </div>

                                        <div className="mt-4 text-[10px] font-black text-gray-400 px-2 uppercase tracking-widest">THEMES</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className={`p-3 border-2 border-b-4 rounded-2xl text-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${stats.currentTheme === 'cherry' ? 'border-pink-400 bg-pink-50' : 'border-gray-200 bg-white'}`} onClick={() => unlockTheme('cherry', 500)}>
                                                <Icons.Cherry size={24} className="mx-auto text-pink-400 mb-2"/>
                                                <div className="text-[10px] font-bold text-gray-600">Ê°úÂêπÈõ™</div>
                                                {!stats.themes.includes('cherry') && <div className="text-duo-pink text-xs font-black mt-1">500üíé</div>}
                                            </div>
                                            <div className={`p-3 border-2 border-b-4 rounded-2xl text-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${stats.currentTheme === 'fireworks' ? 'border-blue-400 bg-blue-50' : 'border-gray-200 bg-white'}`} onClick={() => unlockTheme('fireworks', 500)}>
                                                <Icons.Sparkles size={24} className="mx-auto text-blue-400 mb-2"/>
                                                <div className="text-[10px] font-bold text-gray-600">Ëä±ÁÅ´</div>
                                                {!stats.themes.includes('fireworks') && <div className="text-duo-pink text-xs font-black mt-1">500üíé</div>}
                                            </div>
                                        </div>

                                    </div>
                                )}
                            </div>
                        </div>
                    </aside>

                    {/* Main Area */}
                    <main className={`flex-1 pt-20 transition-all duration-300 ${isSidebarOpen && !isMobile ? 'pl-72' : 'pl-0'}`}>
                        <div className="h-full overflow-y-auto px-6 md:px-20 lg:px-32 pb-40">
                            <div className="max-w-2xl mx-auto pt-8">
                                <div className="flex items-center gap-3 mb-6">
                                    <h1 className="text-lg font-bold tracking-tight text-gray-500">{activeListId === 'default' ? '„Éû„Ç§„Çø„Çπ„ÇØ' : 'Á∑†Âàá„É™„Çπ„Éà'}</h1>
                                </div>

                                {/* „Çø„Çπ„ÇØÂÖ•Âäõ„Ç®„É™„Ç¢ */}
                                <div className={`mb-8 bg-gray-100 border-2 border-gray-200 rounded-xl p-1 flex items-center shadow-sm ${btn3DClass} focus-within:translate-y-[4px] focus-within:border-b-0`}>
                                    <div className="w-full h-full flex items-center px-3 py-2 gap-2">
                                        <Icons.Plus className="text-gray-400 opacity-80" size={20} />
                                        <input className="bg-transparent outline-none flex-1 font-medium text-base text-gray-700 placeholder-gray-400" placeholder="MVPÂøÖÈ†àÊ©üËÉΩ„ÅÆ„Åø„ÇíËøΩÂä†" onKeyDown={(e) => {
                                            if (e.key === 'Enter' && e.target.value.trim()) {
                                                // Section 1„ÅÆ„Çø„Çπ„ÇØÊï∞„Çí„Ç´„Ç¶„É≥„Éà
                                                let section1Count = 0;
                                                for (let t of tasks) {
                                                    if (!t.completed && section1Count > 0 && t.isSectionHead) break;
                                                    if (!t.completed) section1Count++;
                                                }

                                                // Section 1„Åå5„Å§‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØË≠¶Âëä
                                                if (section1Count >= 5) {
                                                    setToastMessage("‚ö†Ô∏è MVPÈñãÁô∫„ÅØ„Ç∑„É≥„Éó„É´„Å´ÔºÅ„Çø„Çπ„ÇØ„ÇíÊ∏õ„Çâ„Åô„Å®ÈõÜ‰∏≠ÂäõUP");
                                                    AudioEngine.play([200, 150], 'sawtooth', 0.1, 0.1);
                                                }

                                                setTasks([...tasks, { id: Date.now().toString(), title: e.target.value, completed: false, listId: activeListId, createdAt: Date.now(), isSectionHead: tasks.length === 0 }]);
                                                setStats(s => ({...s, tasksCreated: s.tasksCreated + 1}));
                                                e.target.value = '';
                                            }
                                        }} />
                                    </div>
                                </div>

                                <div className="space-y-3 relative">
                                    {incomplete.map((t, index) => {
                                        const isFirst = index === 0;
                                        const showSectionHeader = isFirst || t.isSectionHead;
                                        
                                        if (showSectionHeader) {
                                            sectionCounter++;
                                            const sectionNum = sectionCounter;
                                            const isLast = isLastTaskInSection(index);

                                            return (
                                                <React.Fragment key={t.id}>
                                                    <div className="py-4 flex items-center justify-center gap-2">
                                                        <div className={`font-black text-xs px-4 py-1 rounded-full uppercase tracking-widest ${sectionNum === 1 ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-500'}`}>
                                                            Section {sectionNum}
                                                        </div>
                                                        {sectionNum === 1 && (
                                                            <div className="flex items-center gap-1 bg-yellow-100 border-2 border-yellow-300 rounded-full px-3 py-1 animate-pulse">
                                                                <span className="text-lg">üöÄ</span>
                                                                <span className="text-[10px] font-black text-yellow-700 uppercase tracking-wider">MVP Focus</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div
                                                        onDragOver={(e) => handleDragOver(e, t)}
                                                        onDrop={(e) => handleDrop(e, t)}
                                                    >
                                                        <TaskItem
                                                            task={t}
                                                            isMobile={isMobile}
                                                            onXpGain={handleXpGain}
                                                            onToggle={() => updateTask(t.id, { completed: true, completedAt: Date.now() })}
                                                            onUpdate={updateTask}
                                                            onDelete={(id)=>setTasks(tasks.filter(x=>x.id!==id))}
                                                            onDragStart={handleDragStart}
                                                            isDragging={draggedTaskId === t.id}
                                                            isDeadlineView={activeListId==='deadline'}
                                                            activeTheme={stats.currentTheme}
                                                            onContextMenu={handleContextMenu}
                                                            isFocusedSection={sectionNum === 1}
                                                            isLastInSection={isLast}
                                                        />
                                                    </div>
                                                </React.Fragment>
                                            );
                                        }
                                        
                                        const isLast = isLastTaskInSection(index);
                                        return (
                                            <div
                                                key={t.id}
                                                onDragOver={(e) => handleDragOver(e, t)}
                                                onDrop={(e) => handleDrop(e, t)}
                                            >
                                                <TaskItem
                                                    task={t}
                                                    isMobile={isMobile}
                                                    onXpGain={handleXpGain}
                                                    onToggle={() => updateTask(t.id, { completed: true, completedAt: Date.now() })}
                                                    onUpdate={updateTask}
                                                    onDelete={(id)=>setTasks(tasks.filter(x=>x.id!==id))}
                                                    onDragStart={handleDragStart}
                                                    isDragging={draggedTaskId === t.id}
                                                    isDeadlineView={activeListId==='deadline'}
                                                    activeTheme={stats.currentTheme}
                                                    onContextMenu={handleContextMenu}
                                                    isFocusedSection={sectionCounter === 1}
                                                    isLastInSection={isLast}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* ÂÆå‰∫Ü„Çø„Çπ„ÇØ„Çª„ÇØ„Ç∑„Éß„É≥ */}
                                {completed.length > 0 && (
                                    <div className="mt-16 mb-20">
                                        <button onClick={() => setIsCompletedOpen(!isCompletedOpen)} className={`flex items-center gap-2 text-sm font-black text-gray-400 hover:text-gray-600 px-4 py-3 rounded-xl transition-colors bg-gray-50 border-2 border-transparent hover:border-gray-200 ${juicyBtnClass}`}>
                                            {isCompletedOpen ? <Icons.ChevronDown size={18} /> : <Icons.ChevronRight size={18} />}
                                            ÂÆå‰∫ÜÊ∏à„Åø ({completed.length})
                                        </button>
                                        
                                        {isCompletedOpen && (
                                            <div className="mt-4 space-y-2 opacity-75">
                                                {completed.map(t => (
                                                    <TaskItem
                                                        key={t.id}
                                                        task={t}
                                                        isMobile={isMobile}
                                                        onXpGain={handleXpGain}
                                                        onToggle={() => updateTask(t.id, { completed: false })}
                                                        onUpdate={updateTask}
                                                        onDelete={(id)=>setTasks(tasks.filter(x=>x.id!==id))}
                                                        onDragStart={null}
                                                        isDragging={false}
                                                        isDeadlineView={activeListId==='deadline'}
                                                        activeTheme={stats.currentTheme}
                                                    />
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>

                    {/* Effects */}
                    {toastMessage && <Toast message={toastMessage} onClose={closeToast} />}
                    {floatingTexts.map(t => <FloatingText key={t.id} x={t.x} y={t.y} text={t.text} color={t.color} scale={t.scale} />)}
                    {/* PerformanceOverlay removed */}
                    {showChestModal && <ChestModal onClose={() => setShowChestModal(false)} onReward={handleReward} />}
                    {showIgnition && <IgnitionModal />}
                    {contextMenu && (
                        <ContextMenu 
                            x={contextMenu.x} 
                            y={contextMenu.y} 
                            onDivide={toggleSectionBreak} 
                            onMerge={toggleSectionBreak}
                            showMerge={tasks.findIndex(t => t.id === contextMenu.task.id) < tasks.length - 1 && tasks[tasks.findIndex(t => t.id === contextMenu.task.id) + 1].isSectionHead}
                            showPurge={stats.mvpScrutinizerActive}
                            onPurge={purgeTask}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
