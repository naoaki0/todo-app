<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo„É™„Çπ„Éà Pro - Focus Layout</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Roboto', 'Noto Sans JP', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'] 
                    },
                    colors: {
                        google: {
                            blue: '#1a73e8', red: '#ea4335', yellow: '#fbbc04', green: '#34a853',
                            gray: '#f1f3f4', text: '#202124', textSec: '#5f6368', hover: '#f8f9fa',
                            selected: '#e8f0fe', selectedText: '#1967d2'
                        },
                        duo: {
                            green: '#58cc02', border: '#46a302', greenHighlight: '#89e219',
                            blue: '#1cb0f6', blueBorder: '#1899d6',
                            orange: '#ff9600', orangeBorder: '#cc7900',
                            pink: '#ff4b4b', pinkBorder: '#d42c2c',
                            gray: '#e5e5e5', lightGray: '#f7f7f7', text: '#4b4b4b',
                            gold: '#FFD700', silver: '#C0C0C0'
                        }
                    },
                    boxShadow: {
                        'card': '0 2px 0 0 #e5e5e5',
                        'duo': '0 4px 0 0 #e5e5e5',
                        'floating': '0 6px 16px 0 rgba(0,0,0,0.2)',
                        'glow': '0 0 15px rgba(255, 255, 255, 0.8)',
                    },
                    animation: {
                        'shimmer': 'shimmer 2s linear infinite',
                        'pulse-fast': 'pulse 0.8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-soft': 'bounce-soft 2s infinite',
                        'toast-in': 'toast-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'float-up': 'float-up 1s ease-out forwards',
                        'spring': 'spring 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'chest-open': 'chest-open 0.5s forwards',
                        'light-burst': 'light-burst 1s ease-out infinite',
                        'ignition': 'ignition 1.5s ease-out forwards',
                        'flame-grow': 'flame-grow 0.5s ease-out forwards',
                        'scale-in': 'scale-in 0.2s ease-out forwards',
                        'tech-slide': 'tech-slide 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'log-fade': 'log-fade 3s ease-out forwards',
                        'checkbox-pop': 'checkbox-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'bounce-hard': 'bounce-hard 0.5s infinite',
                    },
                    keyframes: {
                        shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
                        'bounce-soft': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        'bounce-hard': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px) scale(1.1)' } },
                        'toast-in': { '0%': { transform: 'translate(-50%, 100%)', opacity: 0 }, '100%': { transform: 'translate(-50%, 0)', opacity: 1 } },
                        'float-up': { '0%': { transform: 'translateY(0) scale(1)', opacity: 1 }, '100%': { transform: 'translateY(-60px) scale(1.1)', opacity: 0 } },
                        'spring': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        'shake': { '10%, 90%': { transform: 'translate3d(-2px, 0, 0) rotate(-2deg)' }, '20%, 80%': { transform: 'translate3d(4px, 0, 0) rotate(4deg)' }, '30%, 50%, 70%': { transform: 'translate3d(-8px, 0, 0) rotate(-8deg)' }, '40%, 60%': { transform: 'translate3d(8px, 0, 0) rotate(8deg)' } },
                        'chest-open': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.2)' }, '100%': { transform: 'scale(0) opacity(0)' } },
                        'light-burst': { '0%': { transform: 'scale(1)', opacity: 0.5 }, '100%': { transform: 'scale(1.5)', opacity: 0 } },
                        'ignition': { '0%': { opacity: 0, transform: 'scale(0.8)' }, '20%': { opacity: 1, transform: 'scale(1.2)' }, '100%': { opacity: 0, transform: 'scale(2)' } },
                        'flame-grow': { '0%': { transform: 'scale(1)', color: '#e5e5e5' }, '50%': { transform: 'scale(1.5)', color: '#ff9600' }, '100%': { transform: 'scale(1)', color: '#ff9600' } },
                        'scale-in': { '0%': { transform: 'scale(0.8)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'tech-slide': { '0%': { transform: 'translateX(-20px)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        'log-fade': { '0%': { color: '#FFD700', transform: 'translateX(-10px)' }, '20%': { color: '#FFD700', transform: 'translateX(0)' }, '100%': { color: '#4b5563' } },
                        'checkbox-pop': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.5)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Roboto', 'Noto Sans JP', sans-serif; -webkit-font-smoothing: antialiased; }
        @keyframes confetti-explode { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 60% { opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        @keyframes cherry-fall { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(720deg); opacity: 0; } }
        @keyframes confetti-rise { 0% { transform: translateX(0) translateY(0) rotate(0deg); opacity: 1; } 50% { opacity: 1; } 100% { transform: translateX(var(--random-x)) translateY(-100vh) rotate(var(--random-rotation)); opacity: 0; } }

        /* ‰∏≠ÊØíÊÄßMAXÂ†±ÈÖ¨„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes near-miss-flash { 0% { opacity: 0; } 30% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes reward-particle { 0% { transform: translate(0, 0); opacity: 1; } 100% { transform: translate(var(--vx), var(--vy)); opacity: 0; } }
        @keyframes reward-fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        @keyframes big-flash { 0% { opacity: 0; } 20% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes jackpot-flash { 0% { opacity: 0; } 30% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes screen-shake { 0%, 100% { transform: translate(0, 0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px); } 20%, 40%, 60%, 80% { transform: translate(5px, -5px); } }
        @keyframes jackpot-text { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 20% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; } 50% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
        @keyframes anticipation-glow { 0%, 100% { box-shadow: 0 0 0 rgba(255, 215, 0, 0); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); } }
        @keyframes anticipation-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes cracker-shoot { 0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; } 70% { opacity: 1; } 100% { transform: translate(calc(var(--target-x) - 50vw), calc(var(--target-y) - 50vh)) rotate(var(--rotation)) scale(0.3); opacity: 0; } }

        /* ÂÆåÂÖ®‰æùÂ≠ò„É¨„Éô„É´„ÅÆÊºîÂá∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes near-miss-intense { 0% { opacity: 0; } 30% { opacity: 1; } 70% { opacity: 0.8; } 100% { opacity: 0; } }
        @keyframes whiff-darken { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes whiff-fade { 0% { transform: translate(0, 0); opacity: 1; } 100% { transform: translate(var(--vx), var(--vy)); opacity: 0; } }
        @keyframes normal-flash { 0% { opacity: 0; } 40% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes ring-expand { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(15); opacity: 0; } }
        @keyframes reward-particle-glow { 0% { transform: translate(0, 0); opacity: 1; } 100% { transform: translate(var(--vx), var(--vy)); opacity: 0; } }
        @keyframes big-rainbow-flash { 0% { opacity: 0; } 30% { opacity: 1; } 70% { opacity: 0.8; } 100% { opacity: 0; } }
        @keyframes beam-pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
        @keyframes explosion { 0% { transform: scale(0); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.8; } 100% { transform: scale(3); opacity: 0; } }
        @keyframes reward-fall-glow { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(1080deg); opacity: 0; } }
        @keyframes big-text { 0% { transform: translate(-50%, -50%) scale(0) rotate(-20deg); opacity: 0; } 30% { transform: translate(-50%, -50%) scale(1.3) rotate(5deg); opacity: 1; } 50% { transform: translate(-50%, -50%) scale(1) rotate(0deg); } 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; } }
        @keyframes jackpot-mega-flash { 0% { opacity: 0; } 20% { opacity: 1; } 50% { opacity: 0.9; } 80% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes screen-shake-intense { 0%, 100% { transform: translate(0, 0); } 5%, 15%, 25%, 35%, 45%, 55%, 65%, 75%, 85%, 95% { transform: translate(-10px, 10px); } 10%, 20%, 30%, 40%, 50%, 60%, 70%, 80%, 90% { transform: translate(10px, -10px); } }
        @keyframes mega-wave-expand { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(30); opacity: 0; } }
        @keyframes spiral-rotate-cw { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spiral-rotate-ccw { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }
        @keyframes starburst-pulse { 0% { opacity: 0; transform: scale(0); } 30% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(1.5); } }
        @keyframes reward-fall-mega-glow { 0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translateY(100vh) rotate(1440deg) scale(0.5); opacity: 0; } }
        @keyframes jackpot-mega-text { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 20% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; } 40% { transform: translate(-50%, -50%) scale(0.9); } 50% { transform: translate(-50%, -50%) scale(1.1); } 60% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes jackpot-subtext { 0% { opacity: 0; transform: translateY(50px); } 50% { opacity: 1; transform: translateY(0); } 100% { opacity: 1; transform: translateY(0); } }

        /* ‰∏≠ÊØíÊÄßMAXÂÆùÁÆ±„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes chest-float { 0%, 100% { transform: translateY(0px) rotate(-2deg); } 50% { transform: translateY(-15px) rotate(2deg); } }
        @keyframes chest-shake-anticipation { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        @keyframes chest-lid-open { 0% { transform: rotateX(0deg); transform-origin: bottom; } 100% { transform: rotateX(-120deg); transform-origin: bottom; } }
        @keyframes chest-glow-pulse { 0%, 100% { box-shadow: 0 0 20px rgba(150, 180, 255, 0.5), 0 0 40px rgba(100, 150, 255, 0.3); } 50% { box-shadow: 0 0 40px rgba(150, 180, 255, 0.8), 0 0 80px rgba(100, 150, 255, 0.6), 0 0 120px rgba(80, 130, 255, 0.4); } }
        @keyframes sparkle-twinkle { 0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); } 50% { opacity: 1; transform: scale(1) rotate(180deg); } }
        @keyframes light-ray-rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes chest-burst-open { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 0; } }
        @keyframes reward-emerge { 0% { transform: translateY(50px) scale(0); opacity: 0; } 60% { transform: translateY(-20px) scale(1.2); opacity: 1; } 100% { transform: translateY(0) scale(1); opacity: 1; } }

        /* „ÇÆ„É£„É≥„Éñ„É´‰æùÂ≠òÊÄßÔºöÂÆùÁÆ±„ÅÆ‰∫àÂëäÔºÜ„Éã„Ç¢„Éü„ÇπÊºîÂá∫ */
        @keyframes chest-anticipation-shake { 0%, 100% { transform: translate(0, 0) rotate(0deg) scale(1); } 10% { transform: translate(-8px, -8px) rotate(-10deg) scale(1.05); } 20% { transform: translate(8px, 8px) rotate(10deg) scale(1.05); } 30% { transform: translate(-8px, 8px) rotate(-10deg) scale(1.05); } 40% { transform: translate(8px, -8px) rotate(10deg) scale(1.05); } 50% { transform: translate(-6px, -6px) rotate(-8deg) scale(1.03); } 60% { transform: translate(6px, 6px) rotate(8deg) scale(1.03); } 70% { transform: translate(-4px, 4px) rotate(-5deg) scale(1.02); } 80% { transform: translate(4px, -4px) rotate(5deg) scale(1.02); } 90% { transform: translate(-2px, 2px) rotate(-2deg) scale(1.01); } }
        @keyframes chest-color-tease { 0% { filter: hue-rotate(0deg) brightness(1) saturate(1); } 20% { filter: hue-rotate(60deg) brightness(1.3) saturate(1.8); } 40% { filter: hue-rotate(120deg) brightness(1.5) saturate(2); } 60% { filter: hue-rotate(180deg) brightness(1.7) saturate(2.2); } 80% { filter: hue-rotate(240deg) brightness(1.5) saturate(2); } 100% { filter: hue-rotate(300deg) brightness(1.3) saturate(1.8); } }
        @keyframes chest-glow-intensify { 0% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); } 25% { box-shadow: 0 0 60px rgba(255, 100, 255, 1), 0 0 100px rgba(255, 100, 255, 0.8); } 50% { box-shadow: 0 0 80px rgba(255, 50, 50, 1), 0 0 120px rgba(255, 50, 50, 0.9), 0 0 160px rgba(255, 50, 50, 0.7); } 75% { box-shadow: 0 0 60px rgba(100, 255, 255, 1), 0 0 100px rgba(100, 255, 255, 0.8); } 100% { box-shadow: 0 0 80px rgba(255, 215, 0, 1), 0 0 120px rgba(255, 215, 0, 0.9); } }
        @keyframes near-miss-flash { 0% { opacity: 0; transform: scale(1); } 30% { opacity: 1; transform: scale(1.2); } 60% { opacity: 0.8; transform: scale(1.1); } 100% { opacity: 0; transform: scale(1.3); } }
        @keyframes heartbeat-pulse { 0%, 100% { transform: scale(1); } 10% { transform: scale(1.1); } 20% { transform: scale(1); } 30% { transform: scale(1.15); } 40% { transform: scale(1); } }

        /* „Ç´„Ç∏„Éé„Ç∞„É¨„Éº„ÉâÊºîÂá∫ÔºöÁâ©ÁêÜ„Å™„Åó„ÉªÈ´òÁ¥ö„Ç∏„É•„Éº„Çπ */
        @keyframes spatial-distortion { 0% { transform: scale(1) skewX(0deg); } 25% { transform: scale(1.05) skewX(5deg); } 50% { transform: scale(0.95) skewX(-5deg); } 75% { transform: scale(1.02) skewX(2deg); } 100% { transform: scale(1) skewX(0deg); } }
        @keyframes chromatic-aberration { 0% { text-shadow: 0 0 0 rgba(255,0,0,0), 0 0 0 rgba(0,255,255,0); } 50% { text-shadow: -5px 0 0 rgba(255,0,0,0.8), 5px 0 0 rgba(0,255,255,0.8); } 100% { text-shadow: 0 0 0 rgba(255,0,0,0), 0 0 0 rgba(0,255,255,0); } }
        @keyframes light-convergence { 0% { transform: scale(3); opacity: 0; } 50% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }
        @keyframes whiteout-burst { 0% { opacity: 0; } 30% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes screen-shake-brutal { 0%, 100% { transform: translate(0, 0); } 10% { transform: translate(-15px, 10px); } 20% { transform: translate(15px, -10px); } 30% { transform: translate(-10px, -15px); } 40% { transform: translate(10px, 15px); } 50% { transform: translate(-12px, 8px); } 60% { transform: translate(12px, -8px); } 70% { transform: translate(-8px, -12px); } 80% { transform: translate(8px, 12px); } 90% { transform: translate(-5px, 5px); } }
        @keyframes resistance-denial { 0% { transform: translateX(0) rotate(0deg); } 10% { transform: translateX(-20px) rotate(-15deg); } 20% { transform: translateX(15px) rotate(10deg); } 30% { transform: translateX(-10px) rotate(-8deg); } 40% { transform: translateX(5px) rotate(5deg); } 50% { transform: translateX(-3px) rotate(-3deg); } 100% { transform: translateX(0) rotate(0deg); } }
        @keyframes jackpot-peek { 0% { opacity: 0; transform: translateY(30px) scale(0.5); } 40% { opacity: 1; transform: translateY(0) scale(1); } 60% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-30px) scale(0.8); } }
        @keyframes charge-buildup { 0% { box-shadow: 0 0 0 rgba(100,150,255,0); transform: scale(1); } 100% { box-shadow: 0 0 50px rgba(100,150,255,1), 0 0 100px rgba(100,150,255,0.8), 0 0 150px rgba(100,150,255,0.6); transform: scale(1.15); } }
        @keyframes roulette-spin { 0% { transform: translateY(0); } 100% { transform: translateY(-500%); } }
        @keyframes roulette-slowdown { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
        @keyframes slot-stop-slam { 0% { transform: translateY(0) scale(1); } 20% { transform: translateY(-30px) scale(1.15); } 50% { transform: translateY(10px) scale(0.9); } 80% { transform: translateY(-5px) scale(1.05); } 100% { transform: translateY(0) scale(1); } }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #dadce0; border-radius: 4px; }

        .progress-glow { filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.8)) brightness(1.2); }
        .fire-active { animation: flame-grow 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        /* --- 3DÂÆùÁÆ±Áî® È´òÂ∫¶„Çπ„Çø„Ç§„É´ --- */
        .chest-scene { perspective: 1200px; transform-style: preserve-3d; }
        .chest-3d { transform-style: preserve-3d; width: 100%; height: 100%; position: relative; }
        .face { position: absolute; backface-visibility: visible; }
        
        /* È´òÁ¥ö„Éû„ÉÉ„Éà„Éñ„É©„ÉÉ„ÇØ„ÅÆË≥™ÊÑü */
        .mat-black-surface {
            background: linear-gradient(135deg, #222 0%, #1a1a1a 100%);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
        }
        /* „Éó„É©„ÉÅ„Éä„Ç∑„É´„Éê„Éº„ÅÆÈáëÂ±ûÂÖâÊ≤¢ÔºàÁ∏ÅÂèñ„ÇäÁî®Ôºâ */
        .platinum-rim {
            background: linear-gradient(90deg, #555 0%, #999 20%, #fff 50%, #999 80%, #555 100%);
            box-shadow: 0 0 5px rgba(255,255,255,0.3);
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥: ÂëºÂê∏„Åô„Çã„Çà„ÅÜ„Å™ÂæÖÊ©üÁä∂ÊÖã */
        @keyframes chest-breathe {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-4px) scale(1.01); }
        }
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥: ÈöôÈñì„Åã„Çâ„ÅÆÂÖâÊºè„Çå */
        @keyframes leak-light {
            0%, 100% { opacity: 0.3; transform: scaleX(0.8); }
            50% { opacity: 0.8; transform: scaleX(1.1); filter: blur(4px); }
        }
        
        /* ÈÄ£ÊâìÁî®„Ç´„Çπ„Çø„É†„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes neon-pulse-scan { 0% { transform: scale(0.8); opacity: 0.1; } 50% { opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }
        @keyframes shake-brutal-x { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="bg-white h-screen overflow-hidden text-duo-text">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Èü≥Èüø„Ç®„É≥„Ç∏„É≥ ---
        const AudioEngine = {
            ctx: null,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(freqs, type = 'sine', volume = 0.1, interval = 0.08) {
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const now = this.ctx.currentTime;
                freqs.forEach((f, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(f, now + i * interval);
                    gain.gain.setValueAtTime(0, now + i * interval);
                    gain.gain.linearRampToValueAtTime(volume, now + i * interval + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * interval + 0.25);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now + i * interval);
                    osc.stop(now + i * interval + 0.3);
                });
            }
        };

        // --- Icons (ÁúÅÁï•„Å™„Åó) ---
        const SvgIcon = ({ children, size = 20, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Icons = {
            Menu: (p) => <SvgIcon {...p}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></SvgIcon>,
            Plus: (p) => <SvgIcon {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></SvgIcon>,
            Check: (p) => <SvgIcon {...p}><polyline points="20 6 9 17 4 12"/></SvgIcon>,
            Trash2: (p) => <SvgIcon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></SvgIcon>,
            Calendar: (p) => <SvgIcon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></SvgIcon>,
            Flame: (p) => <SvgIcon {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a1 1 0 0 1 .9 3.8z"/></SvgIcon>,
            Gem: (p) => <SvgIcon {...p}><path d="M6 3h12l4 6-10 12L2 9z"/><path d="M11 3v18"/><path d="M6 3l5 6 5-6"/><path d="M2 9h20"/></SvgIcon>,
            ShoppingBag: (p) => <SvgIcon {...p}><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></SvgIcon>,
            ChevronDown: (p) => <SvgIcon {...p}><polyline points="6 9 12 15 18 9"/></SvgIcon>,
            ChevronUp: (p) => <SvgIcon {...p}><polyline points="18 15 12 9 6 15"/></SvgIcon>,
            ChevronRight: (p) => <SvgIcon {...p}><polyline points="9 18 15 12 9 6"/></SvgIcon>,
            Edit: (p) => <SvgIcon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></SvgIcon>,
            GripVertical: (p) => <SvgIcon {...p}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></SvgIcon>,
            Star: (p) => <SvgIcon {...p} fill={p.active ? "currentColor" : "none"}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></SvgIcon>,
            Play: (p) => <SvgIcon {...p}><polygon points="5 3 19 12 5 21 5 3"/></SvgIcon>,
            Pause: (p) => <SvgIcon {...p}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></SvgIcon>,
            AlertCircle: (p) => <SvgIcon {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></SvgIcon>,
            Potion: (p) => <SvgIcon {...p}><path d="M8.5 2h7"/><path d="M12 2v4"/><path d="M16.5 10a4.5 4.5 0 0 0-9 0l-.5 8h10l-.5-8Z"/><line x1="12" y1="12" x2="12" y2="14"/><line x1="10" y1="15" x2="10.5" y2="15"/></SvgIcon>,
            Ticket: (p) => <SvgIcon {...p}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></SvgIcon>,
            Sparkles: (p) => <SvgIcon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 5h4"/></SvgIcon>,
            Cherry: (p) => <SvgIcon {...p}><path d="M2 8a5 5 0 0 0 10 0c0-2.76-2.5-5-5-5-2.5 0-5 2.24-5 5Z"/><path d="M12 8a5 5 0 0 0 10 0c0-2.76-2.5-5-5-5-2.5 0-5 2.24-5 5Z"/><path d="M7 3c2.5-1.5 5 0 10 2"/></SvgIcon>,
            Snowflake: (p) => <SvgIcon {...p}><line x1="12" y1="2" x2="12" y2="22"/><line x1="20" y1="12" x2="4" y2="12"/><line x1="17.66" y1="6.34" x2="6.34" y2="17.66"/><line x1="17.66" y1="17.66" x2="6.34" y2="6.34"/></SvgIcon>,
            Chest: (p) => <SvgIcon {...p}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8"/><path d="M16.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8"/></SvgIcon>,
            Gift: (p) => <SvgIcon {...p}><rect x="3" y="8" width="18" height="4" rx="1" /><path d="M12 8v13" /><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" /><path d="M7.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8" /><path d="M16.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8" /></SvgIcon>,
            Clock: (p) => <SvgIcon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></SvgIcon>,
            Rocket: (p) => <SvgIcon {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></SvgIcon>,
            Divide: (p) => <SvgIcon {...p}><circle cx="12" cy="6" r="2" /><line x1="5" y1="12" x2="19" y2="12" /><circle cx="12" cy="18" r="2" /></SvgIcon>,
            Merge: (p) => <SvgIcon {...p}><path d="m8 6 4-4 4 4"/><path d="M12 2v10.3"/><path d="M12 12.3v8.2"/><path d="m8 18 4 4 4-4"/></SvgIcon>,
            Terminal: (p) => <SvgIcon {...p}><polyline points="4 17 10 11 4 5" /><line x1="12" y1="19" x2="20" y2="19" /></SvgIcon>,
            Search: (p) => <SvgIcon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></SvgIcon>,
            Shield: (p) => <SvgIcon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></SvgIcon>,
            Zap: (p) => <SvgIcon {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></SvgIcon>,
            Trash: (p) => <SvgIcon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></SvgIcon>,
        };

        const juicyBtnClass = "transition-all duration-150 transform hover:scale-105 active:scale-95 active:translate-y-1";

        const IconButton = ({ icon: Icon, onClick, className = "", active = false, size = 20, color="text-google-textSec", ...props }) => (
            <button onClick={onClick} className={`p-2 rounded-full flex items-center justify-center hover:bg-google-hover ${active ? 'bg-google-selected text-google-blue' : color} ${className} ${juicyBtnClass}`} {...props}>
                <Icon size={size} active={active} />
            </button>
        );

        const Toast = ({ message, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-2xl shadow-floating z-[120] flex items-center gap-3 animate-toast-in font-black whitespace-nowrap border-b-4 border-red-700">
                    <Icons.AlertCircle size={24} /><span>{message}</span>
                </div>
            );
        };

        const FloatingText = ({ x, y, text, color, scale }) => (
            <div className={`fixed z-[150] pointer-events-none flex items-center gap-1 animate-float-up drop-shadow-md whitespace-nowrap ${color} ${scale}`} style={{ left: x, top: y }}>
                {text}
            </div>
        );

        const IgnitionModal = () => (
            <div className="fixed inset-0 pointer-events-none z-[200] flex items-center justify-center">
                <div className="absolute inset-0 bg-orange-500/20 animate-ignition"></div>
                <div className="text-9xl text-duo-orange animate-ignition flex items-center justify-center drop-shadow-2xl">
                    üî•
                </div>
                <div className="absolute top-1/3 text-4xl font-black text-white animate-ignition drop-shadow-lg uppercase tracking-widest">
                    STREAK IGNITED!
                </div>
            </div>
        );

        const ContextMenu = ({ x, y, onDivide, onMerge, onPurge, showMerge, showPurge }) => (
            <div className="fixed z-[9999] bg-white border-2 border-gray-200 rounded-xl shadow-floating py-1 w-56 animate-scale-in" style={{ left: x, top: y }}>
                <button onClick={onDivide} className="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-2 font-bold text-gray-600 text-sm">
                    <Icons.Divide size={16} /> „Åì„Åì„ÅßÂå∫Âàá„Çã
                </button>
                {showMerge && (
                    <button onClick={onMerge} className="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-2 font-bold text-gray-600 text-sm">
                        <Icons.Merge size={16} /> Âå∫Âàá„Çä„ÇíÂâäÈô§
                    </button>
                )}
                {showPurge && (
                    <div className="border-t border-gray-100 mt-1 pt-1">
                        <button onClick={onPurge} className="w-full text-left px-4 py-3 hover:bg-red-50 flex items-center gap-2 font-bold text-red-500 text-sm">
                            <Icons.Trash size={16} /> Post-MVP„Å∏„Éë„Éº„Ç∏
                        </button>
                    </div>
                )}
            </div>
        );

        const getAdjustedToday = () => {
            const d = new Date(); d.setHours(d.getHours() - 3); return d.toISOString().split('T')[0];
        };

        const determineRewardTier = (pityCounter, isFeverMode) => {
            let whiffChance = 45; let smallChance = 35; let normalChance = 14; let bigChance = 5; let jackpotChance = 1;
            const pityBonus = Math.min(pityCounter * 2, 30);
            jackpotChance += pityBonus * 0.5; bigChance += pityBonus * 0.5; whiffChance -= pityBonus;
            if (isFeverMode) {
                const originalBig = bigChance; const originalJackpot = jackpotChance;
                bigChance = Math.min(originalBig * 2, 40); jackpotChance = Math.min(originalJackpot * 2, 30);
                const boost = (bigChance - originalBig) + (jackpotChance - originalJackpot);
                whiffChance -= boost; smallChance = Math.max(smallChance - boost * 0.3, 10);
            }
            const roll = Math.random() * 100;
            if (roll < jackpotChance) return 'jackpot';
            if (roll < jackpotChance + bigChance) return 'big';
            if (roll < jackpotChance + bigChance + normalChance) return 'normal';
            if (roll < jackpotChance + bigChance + normalChance + smallChance) return 'small';
            return 'whiff';
        };

        const Confetti = ({ type, theme }) => {
            const performanceColors = ['bg-yellow-400', 'bg-yellow-300', 'bg-gray-300', 'bg-gray-200'];
            const colors = performanceColors; 
            const isSmall = type === 'ignition';
            const particlesCount = isSmall ? 8 : (type === 'big' || type === 'performance' ? 45 : 12);
            const particles = Array.from({ length: particlesCount }).map((_, i) => ({
                id: i, tx: (Math.random()-0.5)*(isSmall ? 60 : 240), ty: (Math.random()-0.5)*(isSmall ? 60 : 240), 
                size: Math.random()*(isSmall ? 3 : 7)+2, color: colors[Math.floor(Math.random()*colors.length)], rotation: Math.random() * 360
            }));
            return (
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-50 overflow-visible">
                    {particles.map(p => (
                        <div key={p.id} className={`absolute rounded-full ${p.color}`} style={{ width: p.size, height: p.size, '--tx': `${p.tx}px`, '--ty': `${p.ty}px`, animation: 'confetti-explode 0.4s ease-out forwards' }} />
                    ))}
                </div>
            );
        };

        const CrackerConfettiParticle = ({ startX, startY, targetX, targetY, color, delay, duration, size }) => {
            const randomRotation = Math.random() * 1080 - 540;
            return <div style={{ position: 'fixed', left: startX, bottom: startY, width: `${size}px`, height: `${size}px`, backgroundColor: color, opacity: 0.95, borderRadius: '50%', pointerEvents: 'none', zIndex: 250, animation: `cracker-shoot ${duration}s cubic-bezier(0.25, 0.46, 0.45, 0.94) ${delay}s forwards`, transform: 'scale(1)', boxShadow: color === '#FFD700' ? '0 0 15px rgba(255, 215, 0, 1)' : '0 0 15px rgba(192, 192, 192, 1)', '--target-x': targetX, '--target-y': targetY, '--rotation': `${randomRotation}deg` }} />;
        };

        const ConfettiSystem = ({ rarity }) => {
            const [particles, setParticles] = useState([]);
            useEffect(() => {
                let count = rarity === 'mythic' ? 250 : rarity === 'legendary' ? 150 : rarity === 'epic' ? 100 : 30;
                const newParticles = [];
                for (let i = 0; i < count; i++) {
                    newParticles.push({ id: i, startX: i%2===0?'5%':'95%', startY: '5%', targetX: `${window.innerWidth/2 + (Math.random()-0.5)*400}px`, targetY: `${window.innerHeight/2 + (Math.random()-0.5)*400}px`, color: Math.random() < 0.5 ? '#FFD700' : '#C0C0C0', delay: Math.random() * 0.3, duration: 0.8 + Math.random() * 0.4, size: 10 + Math.random() * 8 });
                }
                setParticles(newParticles);
                const timeout = setTimeout(() => setParticles([]), 3000);
                return () => clearTimeout(timeout);
            }, [rarity]);
            return <>{particles.map(p => <CrackerConfettiParticle key={p.id} {...p} />)}</>;
        };

        // --- ChestModal (Heavy Mashing + 3D CSS) ---
        const ChestModal = ({ onClose, onReward, onStartFocus, isWakeupChest = false }) => {
            const [state, setState] = useState('idle'); // idle, resisting, mashing, silence, opened
            const [reward, setReward] = useState(null);
            const [tapsRequired, setTapsRequired] = useState(0);
            const [currentTaps, setCurrentTaps] = useState(0);
            const [showJackpotTease, setShowJackpotTease] = useState(false);
            const [mashPower, setMashPower] = useState(0); // 0.0 to 1.0

            const getReward = () => {
                const roll = Math.random() * 100;
                if (roll < 40) return { type: 'gems', amount: 15, text: 'üíé 15 Gems', icon: Icons.Gem, rarity: 'common', rarityText: 'COMMON' };
                if (roll < 70) return { type: 'gems', amount: 50, text: 'üíé 50 Gems!', icon: Icons.Gem, rarity: 'rare', rarityText: 'RARE' };
                if (roll < 88) return { type: 'gems', amount: 120, text: 'üíé 120 Gems!!', icon: Icons.Gem, rarity: 'epic', rarityText: 'EPIC' };
                if (roll < 97) return { type: 'gems', amount: 300, text: 'üíé 300 Gems!!!', icon: Icons.Gem, rarity: 'legendary', rarityText: 'LEGENDARY' };
                return { type: 'gems', amount: 777, text: 'üíé 777 JACKPOT!!!', icon: Icons.Gem, rarity: 'mythic', rarityText: 'MYTHIC' };
            };

            const getRarityColor = (rarity) => {
                if (rarity === 'common') return 'text-gray-300';
                if (rarity === 'rare') return 'text-blue-400';
                if (rarity === 'epic') return 'text-purple-400';
                if (rarity === 'legendary') return 'text-yellow-400';
                if (rarity === 'mythic') return 'text-red-500';
                return 'text-white';
            };

            const handleInteraction = async () => {
                if (state === 'opened' || state === 'silence') return;

                if (state === 'idle') {
                    // 50% ÊäµÊäóÁô∫Áîü -> Lock-on
                    if (Math.random() < 0.5) {
                        setState('mashing');
                        const req = Math.floor(Math.random() * 6) + 10; // 10-15 taps
                        setTapsRequired(req);
                        setCurrentTaps(0);
                        AudioEngine.play([150, 100, 80], 'sawtooth', 0.3, 0.1);
                        return;
                    } else {
                        proceedToOpen();
                        return;
                    }
                }

                if (state === 'mashing') {
                    const nextTaps = currentTaps + 1;
                    setCurrentTaps(nextTaps);
                    const progress = nextTaps / tapsRequired;
                    setMashPower(progress);

                    const pitchBase = 200 + (progress * 600);
                    AudioEngine.play([pitchBase, pitchBase * 1.5], 'square', 0.1 + (progress * 0.2), 0.05);

                    if (progress >= 0.9 && !showJackpotTease && nextTaps < tapsRequired) {
                        setShowJackpotTease(true);
                        setTimeout(() => setShowJackpotTease(false), 300);
                        AudioEngine.play([1200, 1500], 'sine', 0.05, 0.1); 
                    }

                    if (nextTaps >= tapsRequired) {
                        proceedToOpen();
                    }
                }
            };

            const proceedToOpen = async () => {
                setState('silence');
                await new Promise(r => setTimeout(r, 200));
                const result = getReward();
                setReward(result);
                setState('opened');
                onReward(result);
                AudioEngine.play([50, 100, 200, 400], 'sawtooth', 0.4, 0.1);
                if (result.rarity === 'mythic' || result.rarity === 'legendary') {
                    setTimeout(() => AudioEngine.play([800, 1200, 1500, 2000], 'sine', 0.3, 0.1), 100);
                }
            };

            // 3D Chest Visual Component
            const ChestVisual = ({ state, mashPower }) => {
                const shakeX = state === 'mashing' ? (Math.random() - 0.5) * mashPower * 20 : 0;
                const shakeY = state === 'mashing' ? (Math.random() - 0.5) * mashPower * 20 : 0;
                const scale = state === 'mashing' ? 1 + mashPower * 0.1 : 1;
                
                // 3D Transform Styles
                const chestStyle = {
                    transformStyle: 'preserve-3d',
                    transform: `translate3d(${shakeX}px, ${shakeY}px, 0) scale(${scale}) rotateX(-10deg) rotateY(-20deg)`,
                    transition: state === 'mashing' ? 'none' : 'transform 0.5s ease-out'
                };

                const lidStyle = {
                    transformStyle: 'preserve-3d',
                    transformOrigin: 'top',
                    transform: state === 'opened' ? 'rotateX(110deg)' : 'rotateX(0deg)',
                    transition: 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                };

                // Face styles - Matte Black Luxury
                const faceCommon = "absolute border border-gray-700 bg-gradient-to-b from-gray-800 to-black";
                const goldTrim = "absolute bg-gray-600/30 border border-gray-500/20";

                return (
                    <div className="relative w-40 h-40" style={{ perspective: '800px' }}>
                        {/* Background Effects */}
                        {state === 'mashing' && (
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div className="absolute w-64 h-64 rounded-full border-4 border-red-500 opacity-0" style={{ animation: `neon-pulse-scan ${0.5 - (mashPower * 0.3)}s linear infinite` }}></div>
                            </div>
                        )}
                        {showJackpotTease && (
                            <div className="absolute -top-32 left-1/2 -translate-x-1/2 font-black text-4xl text-yellow-400 whitespace-nowrap z-50 animate-bounce" style={{ textShadow: '0 0 20px rgba(255,215,0,1)' }}>JACKPOT!?</div>
                        )}

                        <div className="w-full h-full relative" style={chestStyle}>
                            
                            {/* BASE (Body) */}
                            <div className="absolute bottom-0 left-0 w-32 h-20 left-4 top-16" style={{ transformStyle: 'preserve-3d' }}>
                                {/* Front */}
                                <div className={`${faceCommon} w-32 h-20`} style={{ transform: 'translateZ(16px)' }}>
                                    <div className="absolute top-2 left-2 right-2 h-1 bg-black/30"></div>
                                    {/* Lock - Matte Finish */}
                                    <div className="absolute top-0 left-1/2 -translate-x-1/2 w-6 h-8 bg-gray-400 border border-gray-600 rounded-b-lg"></div>
                                </div>
                                {/* Back */}
                                <div className={`${faceCommon} w-32 h-20`} style={{ transform: 'translateZ(-16px) rotateY(180deg)' }}></div>
                                {/* Right */}
                                <div className={`${faceCommon} w-32 h-20`} style={{ width: '32px', transform: 'rotateY(90deg) translateZ(16px)', left: '16px' }}></div>
                                <div className="absolute w-8 h-20 bg-black border border-gray-800" style={{ transform: 'rotateY(90deg) translateZ(16px)', right: '-4px', top:0 }}></div>
                                <div className="absolute w-8 h-20 bg-black border border-gray-800" style={{ transform: 'rotateY(-90deg) translateZ(16px)', left: '-4px', top:0 }}></div>
                                
                                {/* Bottom */}
                                <div className={`${faceCommon} w-32 h-32`} style={{ height: '32px', transform: 'rotateX(-90deg) translateZ(20px)', top: '0' }}></div>

                                {/* Inner Content - Matte (reduced glow) */}
                                <div className="absolute inset-0 bg-gray-600/10" style={{ transform: 'translateZ(0)', boxShadow: '0 0 5px rgba(100,100,100,0.3)' }}></div>
                            </div>

                            {/* LID (Top) */}
                            <div className="absolute w-32 h-12 left-4 top-16" style={lidStyle}>
                                {/* Lid Front */}
                                <div className={`${faceCommon} w-32 h-12`} style={{ transform: 'translateZ(16px)' }}>
                                    <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-6 h-4 bg-gray-400 border border-gray-600 rounded-t-lg"></div>
                                </div>
                                {/* Lid Top */}
                                <div className={`${faceCommon} w-32 h-32`} style={{ height: '32px', transform: 'rotateX(90deg) translateZ(16px)', top: '-16px' }}>
                                    <div className="absolute inset-2 border border-gray-500/50"></div>
                                </div>
                                {/* Lid Back */}
                                <div className={`${faceCommon} w-32 h-12`} style={{ transform: 'translateZ(-16px) rotateY(180deg)' }}></div>
                                {/* Lid Sides - Matte */}
                                <div className="absolute w-8 h-12 bg-gray-900 border border-gray-700" style={{ transform: 'rotateY(90deg) translateZ(16px)', right: '-4px' }}></div>
                                <div className="absolute w-8 h-12 bg-gray-900 border border-gray-700" style={{ transform: 'rotateY(-90deg) translateZ(16px)', left: '-4px' }}></div>
                            </div>

                            {/* Open Effects - Matte (subtle) */}
                            {state === 'opened' && (
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-2 h-40 bg-white/30 blur-sm" style={{ transform: 'translateY(-100px) rotate(0deg)' }}></div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center backdrop-blur-md animate-in fade-in select-none" onClick={handleInteraction}>
                    {state === 'silence' && <div className="fixed inset-0 bg-white z-[210] animate-none"></div>}
                    {state === 'opened' && reward && <ConfettiSystem rarity={reward.rarity} />}

                    <div className="flex flex-col items-center w-full max-w-md pointer-events-none">
                        <div className="relative mb-12 transform transition-transform duration-75">
                            <ChestVisual state={state} mashPower={mashPower} />
                            
                            {state === 'opened' && reward && (
                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50" style={{ animation: 'reward-emerge 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards' }}>
                                    <div className="text-8xl drop-shadow-2xl filter brightness-110">
                                        {reward?.icon && <reward.icon size={100} className="text-white drop-shadow-[0_0_30px_rgba(255,255,255,0.8)]" fill={reward.type==='gems'?"currentColor":"none"} />}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="text-white text-center min-h-[140px] px-4 w-full">
                            {state === 'idle' && (
                                <div className="animate-pulse">
                                    <p className="text-3xl font-black mb-2 text-yellow-300 drop-shadow-lg tracking-wider">{isWakeupChest ? '„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑ' : 'SECTION CLEAR'}</p>
                                    <p className="text-lg font-bold text-gray-300">„Çø„ÉÉ„Éó„Åó„Å¶Â†±ÈÖ¨„ÇíÁç≤Âæó</p>
                                </div>
                            )}
                            {state === 'mashing' && (
                                <div>
                                    <p className="text-5xl font-black text-red-500 drop-shadow-[0_0_10px_rgba(255,0,0,0.8)] animate-pulse tracking-widest" style={{ transform: `scale(${1 + mashPower * 0.5})`, filter: `blur(${mashPower * 1}px)` }}>LOCKED!</p>
                                    <p className="text-xl font-bold text-white mt-2 animate-bounce">TAP TO BREAK!!</p>
                                    <div className="w-64 h-3 bg-gray-800 rounded-full mt-4 mx-auto overflow-hidden border border-gray-600">
                                        <div className="h-full bg-red-600 transition-all duration-75" style={{ width: `${mashPower * 100}%` }}></div>
                                    </div>
                                </div>
                            )}
                            {state === 'opened' && (
                                <div className="animate-in slide-in-from-bottom-10 duration-500 pointer-events-auto">
                                    <p className={`text-sm font-black uppercase tracking-[0.3em] mb-2 ${getRarityColor(reward.rarity)} drop-shadow-md`}>{reward.rarityText}</p>
                                    <p className="text-5xl font-black mb-8 drop-shadow-lg text-white tracking-tighter">{reward?.text}</p>
                                    <button onClick={(e) => { e.stopPropagation(); onStartFocus(); }} className="bg-white text-black px-12 py-4 rounded-full font-black text-xl border-4 border-transparent hover:border-yellow-300 shadow-[0_0_30px_rgba(255,255,255,0.3)] active:scale-95 transition-all hover:scale-105 hover:shadow-[0_0_50px_rgba(255,215,0,0.5)] flex items-center justify-center gap-2 mx-auto">
                                        <Icons.Zap size={24} className="text-black" fill="currentColor"/> START FOCUS
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- TaskItem (Focus Layout) ---
        const TaskItem = ({ task, onToggle, onUpdate, onDelete, onDragStart, isDragging, isMobile, onXpGain, isDeadlineView, activeTheme, onContextMenu, isFocusedSection = true, isLastInSection = false, setRewardEffect, stats, setStats, setToastMessage }) => {
            const [isCompleting, setIsCompleting] = useState(false);
            const [confettiType, setConfettiType] = useState(null);
            const [challengeTimeLeft, setChallengeTimeLeft] = useState(null);
            const [animateCheckbox, setAnimateCheckbox] = useState(false);
            const [isEditingTime, setIsEditingTime] = useState(false);
            const [editTimeValue, setEditTimeValue] = useState('9.5');
            const buttonRef = useRef(null);

            useEffect(() => {
                if (!task.challengeEndTime || task.completed) { setChallengeTimeLeft(null); return; }
                const update = () => {
                    const diff = task.challengeEndTime - Date.now();
                    const sec = diff <= 0 ? 0 : Math.ceil(diff / 1000);
                    setChallengeTimeLeft(sec);
                };
                update();
                const timer = setInterval(update, 1000);
                return () => clearInterval(timer);
            }, [task.challengeEndTime, task.completed]);

            const handleToggle = async (e) => {
                e.stopPropagation();
                if (task.completed || isCompleting) return onToggle(task);
                setIsCompleting(true);
                setAnimateCheckbox(true);
                AudioEngine.play([1200, 600], 'square', 0.08, 0.02);
                setTimeout(() => AudioEngine.play([600], 'square', 0.05, 0.025), 0);
                setTimeout(() => AudioEngine.play([400], 'square', 0.05, 0.025), 80);
                setTimeout(() => AudioEngine.play([600], 'square', 0.05, 0.025), 160);
                setTimeout(() => AudioEngine.play([400], 'square', 0.05, 0.025), 240);
                await new Promise(resolve => setTimeout(resolve, 800));
                AudioEngine.play([300, 200], 'square', 0.18, 0.08);
                onToggle(task);
                onXpGain(task, buttonRef.current?.getBoundingClientRect(), setConfettiType);
                setIsCompleting(false);
                setAnimateCheckbox(false);
            };

            const springClass = isCompleting ? "animate-spring" : "";
            const checkboxPop = animateCheckbox ? "animate-checkbox-pop" : "";
            const anticipationGlow = animateCheckbox ? "animate-anticipation-glow animate-anticipation-pulse" : "";
            const disabledClass = !isFocusedSection && !task.completed ? "pointer-events-none opacity-50 grayscale" : "";

            return (
                <div className={`group flex items-start py-5 px-5 border-b-2 transition-all ${springClass} ${disabledClass} ${isDragging ? 'opacity-50 bg-blue-50' : ''} ${task.completed ? 'bg-gray-50 opacity-60 border-gray-100' : isFocusedSection ? 'bg-white border-gray-200 hover:bg-gray-50' : 'bg-gray-100 border-gray-200'}`} draggable={!task.completed} onDragStart={(e) => !task.completed && onDragStart && onDragStart(e, task)} onContextMenu={(e) => onContextMenu && onContextMenu(e, task)}>
                    {!task.completed && <div className="pt-0.5 pr-2 flex-shrink-0 cursor-move text-gray-300 hover:text-gray-500 transition-colors"><Icons.GripVertical size={18} /></div>}
                    <div className="pt-0.5 pr-4 flex-shrink-0 relative" ref={buttonRef} onClick={(e) => handleToggle(e)}>
                        {(isCompleting || confettiType === 'ignition') && <Confetti type={confettiType} theme={activeTheme} />}
                        <div className={`w-6 h-6 rounded-xl border-2 flex items-center justify-center transition-all ${checkboxPop} ${anticipationGlow} ${task.completed || isCompleting ? 'bg-duo-blue border-duo-blue scale-110' : isFocusedSection ? 'border-gray-300 bg-white text-white group-hover:bg-gray-50' : 'border-gray-300 bg-gray-200'}`}>
                            {(task.completed || isCompleting) && <Icons.Check size={16} className="text-gray-500" strokeWidth={4} />}
                        </div>
                    </div>
                    <div className="flex-grow min-w-0 pr-2 pt-0.5"><div className={`text-lg font-black leading-tight ${task.completed ? 'text-gray-400 line-through' : isFocusedSection ? 'text-gray-900' : 'text-gray-500'}`}>{task.title}</div></div>
                    <div className="flex items-center gap-1">
                        {!task.completed && (
                            <div className="flex items-center gap-1">
                                {challengeTimeLeft !== null ? (
                                    <span className={`text-[11px] font-black px-3 py-1 rounded-xl border-b-2 shadow-sm ${challengeTimeLeft > 0 ? 'bg-duo-pink text-white border-duo-pinkBorder animate-pulse' : 'bg-gray-200 text-gray-500 border-gray-300'}`}>{challengeTimeLeft > 0 ? `${Math.floor(challengeTimeLeft / 60)}:${(challengeTimeLeft % 60).toString().padStart(2, '0')}` : 'TIME OVER'}</span>
                                ) : (
                                    <span className="text-[11px] font-bold px-3 py-1 rounded-xl bg-gray-50 text-gray-400 border border-gray-200 cursor-pointer hover:bg-gray-100 hover:border-gray-300 transition-colors" onClick={(e) => { e.stopPropagation(); setEditTimeValue(String(task.challengeDuration || 9.5)); setIsEditingTime(true); }}>{task.challengeDuration || 9.5}min</span>
                                )}
                                {isEditingTime && (
                                    <div className="fixed inset-0 bg-black/50 z-[300] flex items-center justify-center" onClick={() => setIsEditingTime(false)}>
                                        <div className="bg-white rounded-2xl p-6 shadow-floating w-80 animate-scale-in" onClick={(e) => e.stopPropagation()}>
                                            <h3 className="text-lg font-black mb-4 text-gray-700">Set Time Limit</h3>
                                            <div className="flex items-center gap-2 mb-4"><input type="number" step="0.5" min="0.5" value={editTimeValue} onChange={(e) => setEditTimeValue(e.target.value)} className="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl font-bold text-lg text-center"/><span className="font-bold text-gray-500">min</span></div>
                                            <div className="flex gap-2"><button onClick={() => { onUpdate(task.id, { challengeDuration: parseFloat(editTimeValue) }); setIsEditingTime(false); }} className="flex-1 bg-duo-blue text-white font-black py-2 rounded-xl hover:scale-105 active:scale-95 transition-transform">Save</button><button onClick={() => setIsEditingTime(false)} className="flex-1 bg-gray-200 text-gray-600 font-black py-2 rounded-xl hover:scale-105 active:scale-95 transition-transform">Cancel</button></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {!task.completed && <div className="flex items-center gap-1"><IconButton icon={Icons.Flame} size={18} className={challengeTimeLeft !== null ? "text-orange-500" : "text-gray-300 hover:text-orange-400 hover:bg-orange-50"} onClick={(e) => { e.stopPropagation(); const duration = (task.challengeDuration || 9.5) * 60 * 1000; onUpdate(task.id, { challengeEndTime: Date.now() + duration }); }} /><div className={`flex items-center gap-1 transition-opacity duration-200 ${isMobile ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}><IconButton icon={Icons.Trash2} size={18} className="text-gray-300 hover:text-duo-pink hover:bg-red-50" onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} /></div></div>}
                        {task.completed && <div className={`flex items-center gap-1 transition-opacity duration-200 ${isMobile ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}><IconButton icon={Icons.Trash2} size={18} className="text-gray-300 hover:text-duo-pink" onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} /></div>}
                    </div>
                </div>
            );
        };

        // --- „É°„Ç§„É≥„Ç¢„Éó„É™ ---
        const App = () => {
            const load = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } };
            const [tasks, setTasks] = useState(() => load('duo_v18_tasks', []));
            const [stats, setStats] = useState(() => load('duo_v18_stats', {
                xp: 0, level: 1, gems: 100, streak: 0, lastDate: null, streakFreeze: 0,
                wager: { active: false }, focusPotion: false, resurrectionTickets: 0,
                themes: ['default'], currentTheme: 'default',
                streakBroken: false, savedStreak: 0, completedSections: 0, devLogs: [],
                mvpScrutinizerActive: true, devOathActive: false, flowCapacitorEndTime: 0,
                tasksCreated: 0, tasksPurged: 0, lastWakeupChestTime: 0, pityCounter: 0, feverEndTime: 0,
            }));
            
            const SECTION_SIZE = 4;
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeListId, setActiveListId] = useState('default');
            const [isShopOpen, setIsShopOpen] = useState(false);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [timerState, setTimerState] = useState({ active: false, time: 52 * 60, mode: 'work' });
            const [isCompletedOpen, setIsCompletedOpen] = useState(false);
            const [toastMessage, setToastMessage] = useState(null);
            const [showChestModal, setShowChestModal] = useState(false);
            const [levelGlow, setLevelGlow] = useState(false);
            const [progressGlow, setProgressGlow] = useState(false);
            const [showIgnition, setShowIgnition] = useState(false);
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [rewardEffect, setRewardEffect] = useState(null);
            const [contextMenu, setContextMenu] = useState(null);
            const [progressBounce, setProgressBounce] = useState(false);
            const [draggedTaskId, setDraggedTaskId] = useState(null);
            const [dragOverTaskId, setDragOverTaskId] = useState(null);

            const closeToast = useCallback(() => setToastMessage(null), []);

            useEffect(() => {
                const h = () => { const m = window.innerWidth < 768; setIsMobile(m); if(!m) setIsSidebarOpen(true); };
                window.addEventListener('resize', h); return () => window.removeEventListener('resize', h);
            }, []);

            useEffect(() => {
                const handleClick = () => setContextMenu(null);
                window.addEventListener('click', handleClick);
                return () => window.removeEventListener('click', handleClick);
            }, []);

            const startFocusSession = () => {
                setShowChestModal(false);
                setTimerState({ active: true, time: 52 * 60, mode: 'work' });
                setToastMessage("üî• FOCUS MODE STARTED! üî•");
                AudioEngine.play([200, 400, 800], 'square', 0.2, 0.1);
                const firstTask = document.querySelector('.group');
                if (firstTask) firstTask.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };

            useEffect(() => {
                localStorage.setItem('duo_v18_tasks', JSON.stringify(tasks));
                localStorage.setItem('duo_v18_stats', JSON.stringify(stats));
            }, [tasks, stats]);

            useEffect(() => {
                let timer = null;
                if (timerState.active && timerState.time > 0) {
                    timer = setInterval(() => setTimerState(s => ({ ...s, time: s.time - 1 })), 1000);
                } else if (timerState.time === 0) {
                    const isWork = timerState.mode === 'work';
                    setTimerState({ active: false, mode: isWork ? 'break' : 'work', time: isWork ? 17 * 60 : 52 * 60 });
                    AudioEngine.play([880, 440], 'sine', 0.15, 0.2);
                }
                return () => clearInterval(timer);
            }, [timerState.active, timerState.time]);

            const switchTimerMode = (mode) => {
                const time = mode === 'work' ? 52 * 60 : 17 * 60;
                setTimerState({ active: false, mode, time });
            };

            const handleReward = (reward) => {
                if (reward.type === 'gems') {
                    setStats(prev => ({ ...prev, gems: prev.gems + reward.amount }));
                } else if (reward.itemId === 'freeze') {
                    setStats(prev => ({ ...prev, streakFreeze: prev.streakFreeze + 1 }));
                } else if (reward.itemId === 'ticket') {
                    setStats(prev => ({ ...prev, resurrectionTickets: prev.resurrectionTickets + 1 }));
                }
            };

            const updateTask = (id, updates) => setTasks(tasks.map(t => t.id === id ? { ...t, ...updates } : t));
            const handleDragStart = (e, task) => { setDraggedTaskId(task.id); e.dataTransfer.effectAllowed = 'move'; };
            const handleDragOver = (e, task) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; setDragOverTaskId(task.id); };
            const handleDrop = (e, dropTask) => {
                e.preventDefault();
                if (!draggedTaskId || draggedTaskId === dropTask.id) { setDraggedTaskId(null); setDragOverTaskId(null); return; }
                const draggedIndex = tasks.findIndex(t => t.id === draggedTaskId);
                const dropIndex = tasks.findIndex(t => t.id === dropTask.id);
                if (draggedIndex === -1 || dropIndex === -1) { setDraggedTaskId(null); setDragOverTaskId(null); return; }
                const newTasks = [...tasks];
                const [draggedTask] = newTasks.splice(draggedIndex, 1);
                newTasks.splice(dropIndex, 0, draggedTask);
                setTasks(newTasks);
                setDraggedTaskId(null);
                setDragOverTaskId(null);
            };

            const visibleTasks = tasks.filter(t => activeListId === 'default' ? !t.listId || t.listId === 'default' : t.listId === activeListId);
            const incomplete = visibleTasks.filter(t => !t.completed);
            const completed = visibleTasks.filter(t => t.completed);
            const totalTasks = tasks.length;
            const completedTasksCount = tasks.filter(t => t.completed).length;
            const completionRate = totalTasks === 0 ? 0 : Math.round((completedTasksCount / totalTasks) * 100);

            const buyItem = (cost, action) => {
                if (stats.gems < cost) { setToastMessage("„Ç∏„Çß„É†„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅüíé"); return; }
                setStats(prev => ({ ...prev, gems: prev.gems - cost })); action();
            };
            const unlockTheme = (n, c) => buyItem(c, () => setStats(s => ({...s, themes: [...s.themes, n], currentTheme: n})));
            const handleXpGain = (task, rect, setConfettiType) => { 
                setStats(prev => ({ ...prev, gems: prev.gems + 2, xp: prev.xp + 10 }));
                setConfettiType && setConfettiType('ignition');
            };
            const resurrectStreak = () => { if(stats.streakBroken && stats.resurrectionTickets > 0) setStats(s => ({...s, streakBroken: false, resurrectionTickets: s.resurrectionTickets - 1})); };
            const handleContextMenu = (e, task) => { e.preventDefault(); setContextMenu({ x: e.clientX, y: e.clientY, task }); };
            const toggleSectionBreak = () => { if(!contextMenu) return; const idx = tasks.findIndex(t=>t.id===contextMenu.task.id); if(idx!==-1 && idx < tasks.length-1) { const next=tasks[idx+1]; setTasks(tasks.map((t,i)=>i===idx+1?{...t,isSectionHead:!next.isSectionHead}:t)); } setContextMenu(null); };
            const purgeTask = () => { if(!contextMenu) return; const t=contextMenu.task; setTasks([...tasks.filter(x=>x.id!==t.id), t]); setStats(s=>({...s, gems:s.gems+25})); setToastMessage("MVPÊúÄÈÅ©ÂåñÔºÅ+25üíé"); setContextMenu(null); };

            return (
                <div className="flex h-screen w-full bg-white overflow-hidden relative selection:bg-duo-green/20 font-bold text-duo-text">
                    <header className="fixed top-0 left-0 right-0 h-16 bg-white border-b-2 border-gray-100 z-[100] flex items-center justify-between px-6">
                        <div className="flex-shrink-0 z-20"><IconButton icon={Icons.Menu} onClick={() => setIsSidebarOpen(!isSidebarOpen)} /></div>
                        
                        <div className="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-[500px] px-4 hidden md:block">
                            <div className={`relative h-8 bg-gray-100 rounded-full overflow-hidden border-2 border-gray-200 shadow-inner ${levelGlow ? 'animate-pulse' : ''}`}>
                                <div className={`h-full bg-gradient-to-r from-duo-green to-duo-greenHighlight transition-all duration-700 ease-out relative ${levelGlow ? 'progress-glow brightness-125' : ''}`} style={{ width: `${completionRate}%` }}>
                                     <div className="absolute inset-0 bg-white/20 animate-shimmer" style={{ backgroundSize: '200% 100%' }} />
                                </div>
                                <div className={`absolute inset-0 flex items-center justify-center gap-2 z-10 transition-transform ${progressBounce ? 'scale-110' : ''}`}>
                                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest opacity-40" style={{ textShadow: '0 1px 0 rgba(255,255,255,0.8)' }}>MVP Progress</span>
                                    <span className={`text-xs font-black ${progressBounce ? 'text-duo-green' : 'text-slate-600'}`} style={{ textShadow: '0 1px 0 rgba(255,255,255,0.6)' }}>{completionRate}%</span>
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center gap-2 z-20">
                            <button className="flex items-center gap-1.5 px-3 py-1.5 rounded-2xl"><Icons.Gem size={26} fill="currentColor" className="text-cyan-400"/><span className="text-lg font-black text-cyan-400">{stats.gems}</span></button>
                        </div>
                    </header>

                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 transform transition-all duration-300 z-[90] w-72 bg-white border-r-2 border-duo-gray pt-20 flex flex-col ${isSidebarOpen ? 'translate-x-0 shadow-xl' : '-translate-x-full'}`}>
                        <div className="p-4 mb-2">
                            <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-3">‰ªäÊó•„ÅÆË®òÈå≤</h3>
                            <div className={`flex items-center gap-4 p-3 rounded-2xl border-2 transition-colors duration-500 bg-gray-50 border-gray-200`}>
                                <Icons.Flame size={32} className={`transition-colors duration-1000 ${stats.streak > 0 ? "text-duo-orange" : "text-gray-300"}`} fill="currentColor" />
                                <div>
                                    <div className={`text-xl font-black transition-colors duration-1000 ${stats.streak > 0 ? "text-duo-orange" : "text-gray-400"}`}>{stats.streakBroken ? 0 : stats.streak}Êó•ÈÄ£Á∂ö</div>
                                    <div className="text-xs text-gray-400 font-bold">Keep it burning!</div>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6 border-t-2 border-duo-gray">
                            <div className="space-y-3">
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest px-2">Lists</h3>
                                <button className={`w-full p-4 flex items-center gap-4 rounded-2xl font-black ${btn3DClass} ${activeListId === 'default' ? 'bg-duo-blue/10 text-duo-blue border-duo-blue/20' : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-500'}`} onClick={() => { setActiveListId('default'); if(isMobile) setIsSidebarOpen(false); }}><Icons.Check size={24} />„Éû„Ç§„Çø„Çπ„ÇØ</button>
                                <button className={`w-full p-4 flex items-center gap-4 rounded-2xl font-black ${btn3DClass} ${activeListId === 'deadline' ? 'bg-duo-pink/10 text-duo-pink border-duo-pink/20' : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-500'}`} onClick={() => { setActiveListId('deadline'); if(isMobile) setIsSidebarOpen(false); }}><Icons.Calendar size={24} />Á∑†Âàá„É™„Çπ„Éà</button>
                            </div>
                            <div className="pt-6 border-t-2 border-duo-gray/50 pb-20">
                                <button onClick={() => setIsShopOpen(!isShopOpen)} className={`w-full flex items-center justify-between px-4 py-3 rounded-2xl transition-all font-black text-gray-500 bg-white border-2 border-transparent hover:bg-gray-50 ${isShopOpen ? 'text-duo-text' : ''} ${juicyBtnClass}`}>
                                    <div className="flex items-center gap-2 text-xs uppercase tracking-widest"><Icons.ShoppingBag size={18}/> Gem Shop</div>
                                    {isShopOpen ? <Icons.ChevronDown size={18} /> : <Icons.ChevronRight size={18} />}
                                </button>
                                {isShopOpen && (
                                    <div className="mt-4 space-y-3 animate-in fade-in slide-in-from-top-1 pb-20 px-1">
                                        <div className="p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all bg-white hover:scale-105 active:scale-95" onClick={() => buyItem(200, () => setStats(s => ({...s, streakFreeze: s.streakFreeze + 1})))}>
                                            <div className="text-left"><div className="font-black text-sm text-duo-blue flex items-center gap-1"><Icons.Snowflake size={16}/> ÈÄ£Á∂ö„Éï„É™„Éº„Ç∫ ({stats.streakFreeze})</div><div className="text-[10px] text-gray-400 font-bold">Streak„Çí1Êó•ÂÆà„Çã</div></div>
                                            <div className="text-duo-pink font-black text-sm">200üíé</div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </aside>

                    <main className={`flex-1 pt-20 transition-all duration-300 ${isSidebarOpen && !isMobile ? 'pl-72' : 'pl-0'}`}>
                        <div className="h-full overflow-y-auto px-6 md:px-20 lg:px-32 pb-40">
                            <div className="max-w-2xl mx-auto pt-8">
                                {/* Task List Area */}
                                <div className="mb-8 bg-gray-100 border-2 border-gray-200 rounded-xl p-1 shadow-sm transition-all active:translate-y-[4px] active:border-b-0 border-b-[4px] hover:scale-105 active:scale-95 duration-150 focus-within:translate-y-[4px] focus-within:border-b-0">
                                    <div className="w-full h-full flex items-center px-3 py-2 gap-2">
                                        <Icons.Plus className="text-gray-400 opacity-80" size={20} />
                                        <textarea
                                            className="bg-transparent outline-none flex-1 font-medium text-base text-gray-700 placeholder-gray-400 resize-none min-h-[32px] max-h-[200px]"
                                            placeholder="MVPÂøÖÈ†àÊ©üËÉΩ„ÅÆ„Åø„ÇíËøΩÂä†"
                                            rows="1"
                                            onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                            onKeyDown={(e) => {
                                                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                                                    e.preventDefault();
                                                    const val = e.target.value.trim();
                                                    if (!val) return;
                                                    const titles = val.split(/[\n;]/).map(t=>t.trim()).filter(t=>t);
                                                    if (titles.length===0) return;
                                                    const newTasks = titles.map((t,i) => ({ id: (Date.now()+i).toString(), title: t, completed: false, listId: activeListId, createdAt: Date.now()+i, isSectionHead: tasks.length===0 && i===0 }));
                                                    setTasks([...tasks, ...newTasks]);
                                                    setStats(s=>({...s, tasksCreated: s.tasksCreated+newTasks.length}));
                                                    setToastMessage(`‚ú® ${newTasks.length} tasks added`);
                                                    e.target.value = ''; e.target.style.height = 'auto';
                                                }
                                            }}
                                        />
                                    </div>
                                </div>

                                <div className="space-y-3 relative">
                                    {incomplete.map((t, index) => (
                                        <TaskItem key={t.id} task={t} onToggle={()=>updateTask(t.id, {completed:true})} onUpdate={updateTask} onDelete={(id)=>setTasks(tasks.filter(x=>x.id!==id))} isMobile={isMobile} onXpGain={handleXpGain} activeTheme={stats.currentTheme} onContextMenu={handleContextMenu} stats={stats} setStats={setStats} setToastMessage={setToastMessage} />
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* Effects & Modals */}
                    {toastMessage && <Toast message={toastMessage} onClose={closeToast} />}
                    {showChestModal && <ChestModal onClose={() => setShowChestModal(false)} onReward={handleReward} onStartFocus={startFocusSession} isWakeupChest={true} />}
                    {contextMenu && <ContextMenu x={contextMenu.x} y={contextMenu.y} onDivide={toggleSectionBreak} onMerge={toggleSectionBreak} showPurge={true} onPurge={purgeTask} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
