<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo„É™„Çπ„Éà Pro - Focus Layout</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Roboto', 'Noto Sans JP', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        google: {
                            blue: '#1a73e8', red: '#ea4335', yellow: '#fbbc04', green: '#34a853',
                            gray: '#f1f3f4', text: '#202124', textSec: '#5f6368', hover: '#f8f9fa',
                            selected: '#e8f0fe', selectedText: '#1967d2'
                        },
                        duo: {
                            green: '#58cc02', border: '#46a302', greenHighlight: '#89e219',
                            blue: '#1cb0f6', blueBorder: '#1899d6',
                            orange: '#ff9600', orangeBorder: '#cc7900',
                            pink: '#ff4b4b', pinkBorder: '#d42c2c',
                            gray: '#e5e5e5', lightGray: '#f7f7f7', text: '#4b4b4b',
                            gold: '#FFD700', silver: '#C0C0C0'
                        }
                    },
                    boxShadow: {
                        'card': '0 2px 0 0 #e5e5e5',
                        'duo': '0 4px 0 0 #e5e5e5',
                        'floating': '0 6px 16px 0 rgba(0,0,0,0.2)',
                        'glow': '0 0 15px rgba(255, 255, 255, 0.8)',
                    },
                    animation: {
                        'shimmer': 'shimmer 2s linear infinite',
                        'pulse-fast': 'pulse 0.8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-soft': 'bounce-soft 2s infinite',
                        'toast-in': 'toast-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'float-up': 'float-up 1s ease-out forwards',
                        'spring': 'spring 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'chest-open': 'chest-open 0.5s forwards',
                        'light-burst': 'light-burst 1s ease-out infinite',
                        'ignition': 'ignition 1.5s ease-out forwards',
                        'flame-grow': 'flame-grow 0.5s ease-out forwards',
                        'scale-in': 'scale-in 0.2s ease-out forwards',
                        'tech-slide': 'tech-slide 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'log-fade': 'log-fade 3s ease-out forwards',
                        'checkbox-pop': 'checkbox-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'bounce-hard': 'bounce-hard 0.5s infinite',
                    },
                    keyframes: {
                        shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
                        'bounce-soft': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        'bounce-hard': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px) scale(1.1)' } },
                        'toast-in': { '0%': { transform: 'translate(-50%, 100%)', opacity: 0 }, '100%': { transform: 'translate(-50%, 0)', opacity: 1 } },
                        'float-up': { '0%': { transform: 'translateY(0) scale(1)', opacity: 1 }, '100%': { transform: 'translateY(-60px) scale(1.1)', opacity: 0 } },
                        'spring': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        'shake': { '10%, 90%': { transform: 'translate3d(-2px, 0, 0) rotate(-2deg)' }, '20%, 80%': { transform: 'translate3d(4px, 0, 0) rotate(4deg)' }, '30%, 50%, 70%': { transform: 'translate3d(-8px, 0, 0) rotate(-8deg)' }, '40%, 60%': { transform: 'translate3d(8px, 0, 0) rotate(8deg)' } },
                        'chest-open': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.2)' }, '100%': { transform: 'scale(0) opacity(0)' } },
                        'light-burst': { '0%': { transform: 'scale(1)', opacity: 0.5 }, '100%': { transform: 'scale(1.5)', opacity: 0 } },
                        'ignition': { '0%': { opacity: 0, transform: 'scale(0.8)' }, '20%': { opacity: 1, transform: 'scale(1.2)' }, '100%': { opacity: 0, transform: 'scale(2)' } },
                        'flame-grow': { '0%': { transform: 'scale(1)', color: '#e5e5e5' }, '50%': { transform: 'scale(1.5)', color: '#ff9600' }, '100%': { transform: 'scale(1)', color: '#ff9600' } },
                        'scale-in': { '0%': { transform: 'scale(0.8)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        'tech-slide': { '0%': { transform: 'translateX(-20px)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        'log-fade': { '0%': { color: '#FFD700', transform: 'translateX(-10px)' }, '20%': { color: '#FFD700', transform: 'translateX(0)' }, '100%': { color: '#4b5563' } },
                        'checkbox-pop': { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.5)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        @keyframes confetti-explode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            60% {
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        @keyframes cherry-fall {
            0% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes confetti-rise {
            0% {
                transform: translateX(0) translateY(0) rotate(0deg);
                opacity: 1;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: translateX(var(--random-x)) translateY(-100vh) rotate(var(--random-rotation));
                opacity: 0;
            }
        }

        /* ‰∏≠ÊØíÊÄßMAXÂ†±ÈÖ¨„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes near-miss-flash {
            0% {
                opacity: 0;
            }

            30% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes reward-particle {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: translate(var(--vx), var(--vy));
                opacity: 0;
            }
        }

        @keyframes reward-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes big-flash {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes jackpot-flash {
            0% {
                opacity: 0;
            }

            30% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes screen-shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translate(-5px, 5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translate(5px, -5px);
            }
        }

        @keyframes jackpot-text {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            20% {
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 1;
            }

            50% {
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        @keyframes anticipation-glow {

            0%,
            100% {
                box-shadow: 0 0 0 rgba(255, 215, 0, 0);
            }

            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }
        }

        @keyframes anticipation-pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes gem-absorb {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            50% {
                transform: translate(calc((var(--target-x) - 50%) / 2), calc((var(--target-y) - 50%) / 2)) scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translate(calc(var(--target-x) - 50%), calc(var(--target-y) - 50%)) scale(0.5);
                opacity: 0;
            }
        }

        @keyframes forecast-flash {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            30% {
                opacity: 0.8;
                transform: scale(1.1);
            }

            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        @keyframes buildup-pulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.02);
            }
        }

        @keyframes buildup-shake {

            0%,
            100% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            25% {
                transform: translate(-50%, -50%) translate(-3px, 3px) rotate(-1deg);
            }

            75% {
                transform: translate(-50%, -50%) translate(3px, -3px) rotate(1deg);
            }
        }

        @keyframes feint-flash {
            0% {
                opacity: 0;
            }

            30% {
                opacity: 0.5;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes near-miss-text {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }

            30% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        @keyframes cracker-shoot {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }

            70% {
                opacity: 1;
            }

            100% {
                transform: translate(calc(var(--target-x) - 50vw), calc(var(--target-y) - 50vh)) rotate(var(--rotation)) scale(0.3);
                opacity: 0;
            }
        }

        /* ÂÆåÂÖ®‰æùÂ≠ò„É¨„Éô„É´„ÅÆÊºîÂá∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes near-miss-intense {
            0% {
                opacity: 0;
            }

            30% {
                opacity: 1;
            }

            70% {
                opacity: 0.8;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes whiff-darken {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes whiff-fade {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: translate(var(--vx), var(--vy));
                opacity: 0;
            }
        }

        @keyframes normal-flash {
            0% {
                opacity: 0;
            }

            40% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes ring-expand {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(15);
                opacity: 0;
            }
        }

        @keyframes reward-particle-glow {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: translate(var(--vx), var(--vy));
                opacity: 0;
            }
        }

        @keyframes big-rainbow-flash {
            0% {
                opacity: 0;
            }

            30% {
                opacity: 1;
            }

            70% {
                opacity: 0.8;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes beam-pulse {

            0%,
            100% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }
        }

        @keyframes explosion {
            0% {
                transform: scale(0);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.8;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        @keyframes reward-fall-glow {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(1080deg);
                opacity: 0;
            }
        }

        @keyframes big-text {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-20deg);
                opacity: 0;
            }

            30% {
                transform: translate(-50%, -50%) scale(1.3) rotate(5deg);
                opacity: 1;
            }

            50% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 0;
            }
        }

        @keyframes jackpot-mega-flash {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            50% {
                opacity: 0.9;
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes screen-shake-intense {

            0%,
            100% {
                transform: translate(0, 0);
            }

            5%,
            15%,
            25%,
            35%,
            45%,
            55%,
            65%,
            75%,
            85%,
            95% {
                transform: translate(-10px, 10px);
            }

            10%,
            20%,
            30%,
            40%,
            50%,
            60%,
            70%,
            80%,
            90% {
                transform: translate(10px, -10px);
            }
        }

        @keyframes mega-wave-expand {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(30);
                opacity: 0;
            }
        }

        @keyframes spiral-rotate-cw {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes spiral-rotate-ccw {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(-360deg);
            }
        }

        @keyframes starburst-pulse {
            0% {
                opacity: 0;
                transform: scale(0);
            }

            30% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(1.5);
            }
        }

        @keyframes reward-fall-mega-glow {
            0% {
                transform: translateY(0) rotate(0deg) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(1440deg) scale(0.5);
                opacity: 0;
            }
        }

        @keyframes jackpot-mega-text {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            20% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 1;
            }

            40% {
                transform: translate(-50%, -50%) scale(0.9);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }

            60% {
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes jackpot-subtext {
            0% {
                opacity: 0;
                transform: translateY(50px);
            }

            50% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ‰∏≠ÊØíÊÄßMAXÂÆùÁÆ±„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes chest-float {

            0%,
            100% {
                transform: translateY(0px) rotate(-2deg);
            }

            50% {
                transform: translateY(-15px) rotate(2deg);
            }
        }

        @keyframes chest-shake-anticipation {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-5deg);
            }

            75% {
                transform: rotate(5deg);
            }
        }

        @keyframes chest-lid-open {
            0% {
                transform: rotateX(0deg);
                transform-origin: bottom;
            }

            100% {
                transform: rotateX(-120deg);
                transform-origin: bottom;
            }
        }

        @keyframes chest-glow-pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(150, 180, 255, 0.5), 0 0 40px rgba(100, 150, 255, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(150, 180, 255, 0.8), 0 0 80px rgba(100, 150, 255, 0.6), 0 0 120px rgba(80, 130, 255, 0.4);
            }
        }

        @keyframes sparkle-twinkle {

            0%,
            100% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }

            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
        }

        @keyframes light-ray-rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes chest-burst-open {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        @keyframes reward-emerge {
            0% {
                transform: translateY(50px) scale(0);
                opacity: 0;
            }

            60% {
                transform: translateY(-20px) scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* „ÇÆ„É£„É≥„Éñ„É´‰æùÂ≠òÊÄßÔºöÂÆùÁÆ±„ÅÆ‰∫àÂëäÔºÜ„Éã„Ç¢„Éü„ÇπÊºîÂá∫ */
        @keyframes chest-anticipation-shake {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }

            10% {
                transform: translate(-8px, -8px) rotate(-10deg) scale(1.05);
            }

            20% {
                transform: translate(8px, 8px) rotate(10deg) scale(1.05);
            }

            30% {
                transform: translate(-8px, 8px) rotate(-10deg) scale(1.05);
            }

            40% {
                transform: translate(8px, -8px) rotate(10deg) scale(1.05);
            }

            50% {
                transform: translate(-6px, -6px) rotate(-8deg) scale(1.03);
            }

            60% {
                transform: translate(6px, 6px) rotate(8deg) scale(1.03);
            }

            70% {
                transform: translate(-4px, 4px) rotate(-5deg) scale(1.02);
            }

            80% {
                transform: translate(4px, -4px) rotate(5deg) scale(1.02);
            }

            90% {
                transform: translate(-2px, 2px) rotate(-2deg) scale(1.01);
            }
        }

        @keyframes chest-color-tease {
            0% {
                filter: hue-rotate(0deg) brightness(1) saturate(1);
            }

            20% {
                filter: hue-rotate(60deg) brightness(1.3) saturate(1.8);
            }

            40% {
                filter: hue-rotate(120deg) brightness(1.5) saturate(2);
            }

            60% {
                filter: hue-rotate(180deg) brightness(1.7) saturate(2.2);
            }

            80% {
                filter: hue-rotate(240deg) brightness(1.5) saturate(2);
            }

            100% {
                filter: hue-rotate(300deg) brightness(1.3) saturate(1.8);
            }
        }

        @keyframes chest-glow-intensify {
            0% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            }

            25% {
                box-shadow: 0 0 60px rgba(255, 100, 255, 1), 0 0 100px rgba(255, 100, 255, 0.8);
            }

            50% {
                box-shadow: 0 0 80px rgba(255, 50, 50, 1), 0 0 120px rgba(255, 50, 50, 0.9), 0 0 160px rgba(255, 50, 50, 0.7);
            }

            75% {
                box-shadow: 0 0 60px rgba(100, 255, 255, 1), 0 0 100px rgba(100, 255, 255, 0.8);
            }

            100% {
                box-shadow: 0 0 80px rgba(255, 215, 0, 1), 0 0 120px rgba(255, 215, 0, 0.9);
            }
        }

        @keyframes near-miss-flash {
            0% {
                opacity: 0;
                transform: scale(1);
            }

            30% {
                opacity: 1;
                transform: scale(1.2);
            }

            60% {
                opacity: 0.8;
                transform: scale(1.1);
            }

            100% {
                opacity: 0;
                transform: scale(1.3);
            }
        }

        @keyframes heartbeat-pulse {

            0%,
            100% {
                transform: scale(1);
            }

            10% {
                transform: scale(1.1);
            }

            20% {
                transform: scale(1);
            }

            30% {
                transform: scale(1.15);
            }

            40% {
                transform: scale(1);
            }
        }

        /* „Ç´„Ç∏„Éé„Ç∞„É¨„Éº„ÉâÊºîÂá∫ÔºöÁâ©ÁêÜ„Å™„Åó„ÉªÈ´òÁ¥ö„Ç∏„É•„Éº„Çπ */
        @keyframes spatial-distortion {
            0% {
                transform: scale(1) skewX(0deg);
            }

            25% {
                transform: scale(1.05) skewX(5deg);
            }

            50% {
                transform: scale(0.95) skewX(-5deg);
            }

            75% {
                transform: scale(1.02) skewX(2deg);
            }

            100% {
                transform: scale(1) skewX(0deg);
            }
        }

        @keyframes chromatic-aberration {
            0% {
                text-shadow: 0 0 0 rgba(255, 0, 0, 0), 0 0 0 rgba(0, 255, 255, 0);
            }

            50% {
                text-shadow: -5px 0 0 rgba(255, 0, 0, 0.8), 5px 0 0 rgba(0, 255, 255, 0.8);
            }

            100% {
                text-shadow: 0 0 0 rgba(255, 0, 0, 0), 0 0 0 rgba(0, 255, 255, 0);
            }
        }

        @keyframes light-convergence {
            0% {
                transform: scale(3);
                opacity: 0;
            }

            50% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        @keyframes whiteout-burst {
            0% {
                opacity: 0;
            }

            30% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes screen-shake-brutal {

            0%,
            100% {
                transform: translate(0, 0);
            }

            10% {
                transform: translate(-15px, 10px);
            }

            20% {
                transform: translate(15px, -10px);
            }

            30% {
                transform: translate(-10px, -15px);
            }

            40% {
                transform: translate(10px, 15px);
            }

            50% {
                transform: translate(-12px, 8px);
            }

            60% {
                transform: translate(12px, -8px);
            }

            70% {
                transform: translate(-8px, -12px);
            }

            80% {
                transform: translate(8px, 12px);
            }

            90% {
                transform: translate(-5px, 5px);
            }
        }

        @keyframes resistance-denial {
            0% {
                transform: translateX(0) rotate(0deg);
            }

            10% {
                transform: translateX(-20px) rotate(-15deg);
            }

            20% {
                transform: translateX(15px) rotate(10deg);
            }

            30% {
                transform: translateX(-10px) rotate(-8deg);
            }

            40% {
                transform: translateX(5px) rotate(5deg);
            }

            50% {
                transform: translateX(-3px) rotate(-3deg);
            }

            100% {
                transform: translateX(0) rotate(0deg);
            }
        }

        @keyframes jackpot-peek {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.5);
            }

            40% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            60% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-30px) scale(0.8);
            }
        }

        @keyframes charge-buildup {
            0% {
                box-shadow: 0 0 0 rgba(100, 150, 255, 0);
                transform: scale(1);
            }

            100% {
                box-shadow: 0 0 50px rgba(100, 150, 255, 1), 0 0 100px rgba(100, 150, 255, 0.8), 0 0 150px rgba(100, 150, 255, 0.6);
                transform: scale(1.15);
            }
        }

        @keyframes roulette-spin {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-500%);
            }
        }

        @keyframes roulette-slowdown {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-100%);
            }
        }

        @keyframes slot-stop-slam {
            0% {
                transform: translateY(0) scale(1);
            }

            20% {
                transform: translateY(-30px) scale(1.15);
            }

            50% {
                transform: translateY(10px) scale(0.9);
            }

            80% {
                transform: translateY(-5px) scale(1.05);
            }

            100% {
                transform: translateY(0) scale(1);
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #dadce0;
            border-radius: 4px;
        }

        .progress-glow {
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.8)) brightness(1.2);
        }

        .fire-active {
            animation: flame-grow 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* ChestModal: ÊÆµÈöéÁöÑÊòáÊ†º„ÅÆÂÑÄÂºè - „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes flash {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }

            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        @keyframes glitch {

            0%,
            100% {
                transform: translate(0, 0) skew(0deg);
                opacity: 1;
            }

            10% {
                transform: translate(-5px, 2px) skew(-2deg);
                opacity: 0.8;
                filter: hue-rotate(90deg);
            }

            20% {
                transform: translate(3px, -3px) skew(1deg);
                opacity: 0.9;
                filter: hue-rotate(180deg);
            }

            30% {
                transform: translate(-2px, 4px) skew(-1deg);
                opacity: 0.7;
                filter: hue-rotate(270deg);
            }

            40% {
                transform: translate(4px, -2px) skew(2deg);
                opacity: 0.9;
                filter: hue-rotate(0deg);
            }

            50% {
                transform: translate(-3px, 3px) skew(-2deg);
                opacity: 0.8;
                filter: hue-rotate(90deg);
            }

            60% {
                transform: translate(2px, -4px) skew(1deg);
                opacity: 0.9;
                filter: hue-rotate(180deg);
            }

            70% {
                transform: translate(-4px, 2px) skew(-1deg);
                opacity: 0.7;
                filter: hue-rotate(270deg);
            }

            80% {
                transform: translate(3px, -3px) skew(2deg);
                opacity: 0.9;
                filter: hue-rotate(0deg);
            }

            90% {
                transform: translate(-2px, 4px) skew(-2deg);
                opacity: 0.8;
                filter: hue-rotate(90deg);
            }
        }

        @keyframes gem-scatter-absorb {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            30% {
                transform: translate(var(--scatter-x), var(--scatter-y)) scale(1.5) rotate(720deg);
                opacity: 1;
            }

            31% {
                transform: translate(var(--scatter-x), var(--scatter-y)) scale(1.5) rotate(720deg);
                opacity: 1;
            }

            100% {
                transform: translate(calc(50vw - 50%), calc(-50vh + 100px)) scale(0.3) rotate(1080deg);
                opacity: 0;
            }
        }

        @keyframes burn-overlay {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            30% {
                opacity: 1;
                transform: scale(1.2);
            }

            70% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        @keyframes screen-shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            10% {
                transform: translate(-5px, 2px);
            }

            20% {
                transform: translate(5px, -2px);
            }

            30% {
                transform: translate(-5px, 2px);
            }

            40% {
                transform: translate(5px, -2px);
            }

            50% {
                transform: translate(-5px, 2px);
            }

            60% {
                transform: translate(5px, -2px);
            }

            70% {
                transform: translate(-5px, 2px);
            }

            80% {
                transform: translate(5px, -2px);
            }

            90% {
                transform: translate(-5px, 2px);
            }
        }

        /* ChestModal: The Void - ÊµÆÈÅä„Å®Èúß„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes float-particle {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }

            50% {
                transform: translate(10px, -20px) scale(1.2);
                opacity: 0.6;
            }
        }

        @keyframes float-chest {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes aura-intense {

            0%,
            100% {
                opacity: 0.6;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Tier-specific classes */
        .tier-void {
            filter: brightness(0.7) contrast(1.2);
        }

        .tier-bronze {
            filter: brightness(1) contrast(1.1);
        }

        .tier-gold {
            filter: brightness(1.3) contrast(1.2) saturate(1.5);
        }

        .tier-rainbow {
            filter: brightness(1.5) contrast(1.3) saturate(2);
            animation: rainbow-pulse 1s ease-in-out infinite;
        }

        @keyframes rainbow-pulse {

            0%,
            100% {
                filter: brightness(1.5) contrast(1.3) saturate(2) hue-rotate(0deg);
            }

            50% {
                filter: brightness(1.8) contrast(1.4) saturate(2.5) hue-rotate(30deg);
            }
        }
    </style>
</head>

<body class="bg-white h-screen overflow-hidden text-duo-text">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Èü≥Èüø„Ç®„É≥„Ç∏„É≥ ---
        const AudioEngine = {
            ctx: null,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(freqs, type = 'sine', volume = 0.1, interval = 0.08) {
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const now = this.ctx.currentTime;
                freqs.forEach((f, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(f, now + i * interval);
                    gain.gain.setValueAtTime(0, now + i * interval);
                    gain.gain.linearRampToValueAtTime(volume, now + i * interval + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * interval + 0.25);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now + i * interval);
                    osc.stop(now + i * interval + 0.3);
                });
            }
        };

        // --- Icons ---
        const SvgIcon = ({ children, size = 20, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Icons = {
            Menu: (p) => <SvgIcon {...p}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></SvgIcon>,
            Plus: (p) => <SvgIcon {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></SvgIcon>,
            Check: (p) => <SvgIcon {...p}><polyline points="20 6 9 17 4 12" /></SvgIcon>,
            Trash2: (p) => <SvgIcon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></SvgIcon>,
            Calendar: (p) => <SvgIcon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></SvgIcon>,
            Flame: (p) => <SvgIcon {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a1 1 0 0 1 .9 3.8z" /></SvgIcon>,
            Gem: (p) => <SvgIcon {...p}><path d="M6 3h12l4 6-10 12L2 9z" /><path d="M11 3v18" /><path d="M6 3l5 6 5-6" /><path d="M2 9h20" /></SvgIcon>,
            ShoppingBag: (p) => <SvgIcon {...p}><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" /><line x1="3" y1="6" x2="21" y2="6" /><path d="M16 10a4 4 0 0 1-8 0" /></SvgIcon>,
            ChevronDown: (p) => <SvgIcon {...p}><polyline points="6 9 12 15 18 9" /></SvgIcon>,
            ChevronUp: (p) => <SvgIcon {...p}><polyline points="18 15 12 9 6 15" /></SvgIcon>,
            ChevronRight: (p) => <SvgIcon {...p}><polyline points="9 18 15 12 9 6" /></SvgIcon>,
            Edit: (p) => <SvgIcon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></SvgIcon>,
            GripVertical: (p) => <SvgIcon {...p}><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></SvgIcon>,
            Star: (p) => <SvgIcon {...p} fill={p.active ? "currentColor" : "none"}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></SvgIcon>,
            Play: (p) => <SvgIcon {...p}><polygon points="5 3 19 12 5 21 5 3" /></SvgIcon>,
            Pause: (p) => <SvgIcon {...p}><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></SvgIcon>,
            AlertCircle: (p) => <SvgIcon {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></SvgIcon>,
            Potion: (p) => <SvgIcon {...p}><path d="M8.5 2h7" /><path d="M12 2v4" /><path d="M16.5 10a4.5 4.5 0 0 0-9 0l-.5 8h10l-.5-8Z" /><line x1="12" y1="12" x2="12" y2="14" /><line x1="10" y1="15" x2="10.5" y2="15" /></SvgIcon>,
            Ticket: (p) => <SvgIcon {...p}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z" /><path d="M13 5v2" /><path d="M13 17v2" /><path d="M13 11v2" /></SvgIcon>,
            Sparkles: (p) => <SvgIcon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 3v4" /><path d="M3 7h4" /><path d="M3 5h4" /></SvgIcon>,
            Cherry: (p) => <SvgIcon {...p}><path d="M2 8a5 5 0 0 0 10 0c0-2.76-2.5-5-5-5-2.5 0-5 2.24-5 5Z" /><path d="M12 8a5 5 0 0 0 10 0c0-2.76-2.5-5-5-5-2.5 0-5 2.24-5 5Z" /><path d="M7 3c2.5-1.5 5 0 10 2" /></SvgIcon>,
            Snowflake: (p) => <SvgIcon {...p}><line x1="12" y1="2" x2="12" y2="22" /><line x1="20" y1="12" x2="4" y2="12" /><line x1="17.66" y1="6.34" x2="6.34" y2="17.66" /><line x1="17.66" y1="17.66" x2="6.34" y2="6.34" /></SvgIcon>,
            Chest: (p) => <SvgIcon {...p}><rect x="3" y="8" width="18" height="4" rx="1" /><path d="M12 8v13" /><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" /><path d="M7.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8" /><path d="M16.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8" /></SvgIcon>,
            Gift: (p) => <SvgIcon {...p}><rect x="3" y="8" width="18" height="4" rx="1" /><path d="M12 8v13" /><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" /><path d="M7.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8" /><path d="M16.5 8a2.5 2.5 0 0 1 0-5A2.5 2.5 0 0 1 12 5.5V8" /></SvgIcon>,
            Clock: (p) => <SvgIcon {...p}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></SvgIcon>,
            Rocket: (p) => <SvgIcon {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" /><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z" /><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0" /><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5" /></SvgIcon>,
            Divide: (p) => <SvgIcon {...p}><circle cx="12" cy="6" r="2" /><line x1="5" y1="12" x2="19" y2="12" /><circle cx="12" cy="18" r="2" /></SvgIcon>,
            Merge: (p) => <SvgIcon {...p}><path d="m8 6 4-4 4 4" /><path d="M12 2v10.3" /><path d="M12 12.3v8.2" /><path d="m8 18 4 4 4-4" /></SvgIcon>,
            Terminal: (p) => <SvgIcon {...p}><polyline points="4 17 10 11 4 5" /><line x1="12" y1="19" x2="20" y2="19" /></SvgIcon>,
            Search: (p) => <SvgIcon {...p}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></SvgIcon>,
            Shield: (p) => <SvgIcon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></SvgIcon>,
            Zap: (p) => <SvgIcon {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></SvgIcon>,
            Trash: (p) => <SvgIcon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></SvgIcon>,
            Bell: (p) => <SvgIcon {...p}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" /><path d="M13.73 21a2 2 0 0 1-3.46 0" /></SvgIcon>,
        };

        // --- ÂÖ±ÈÄöUIÈÉ®ÂìÅ ---
        const juicyBtnClass = "transition-all duration-150 transform hover:scale-105 active:scale-95 active:translate-y-1";

        const IconButton = ({ icon: Icon, onClick, className = "", active = false, size = 20, color = "text-google-textSec", ...props }) => (
            <button onClick={onClick} className={`p-2 rounded-full flex items-center justify-center hover:bg-google-hover ${active ? 'bg-google-selected text-google-blue' : color} ${className} ${juicyBtnClass}`} {...props}>
                <Icon size={size} active={active} />
            </button>
        );

        const Toast = ({ message, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-2xl shadow-floating z-[120] flex items-center gap-3 animate-toast-in font-black whitespace-nowrap border-b-4 border-red-700">
                    <Icons.AlertCircle size={24} /><span>{message}</span>
                </div>
            );
        };

        const FloatingText = ({ x, y, text, color, scale }) => (
            <div className={`fixed z-[150] pointer-events-none flex items-center gap-1 animate-float-up drop-shadow-md whitespace-nowrap ${color} ${scale}`} style={{ left: x, top: y }}>
                {text}
            </div>
        );

        const IgnitionModal = () => (
            <div className="fixed inset-0 pointer-events-none z-[200] flex items-center justify-center">
                <div className="absolute inset-0 bg-orange-500/20 animate-ignition"></div>
                <div className="text-9xl text-duo-orange animate-ignition flex items-center justify-center drop-shadow-2xl">
                    üî•
                </div>
                <div className="absolute top-1/3 text-4xl font-black text-white animate-ignition drop-shadow-lg uppercase tracking-widest">
                    STREAK IGNITED!
                </div>
            </div>
        );

        // üåÖ „É¢„Éº„Éã„É≥„Ç∞„Éú„Éº„Éä„ÇπÂÆùÁÆ±„É¢„Éº„ÉÄ„É´
        const MorningBonusChestModal = ({ onClose, onClaim }) => {
            const [timeRemaining, setTimeRemaining] = useState('');
            const [isOpening, setIsOpening] = useState(false);

            useEffect(() => {
                const updateTimer = () => {
                    const now = new Date();
                    const endTime = new Date();
                    endTime.setHours(16, 0, 0, 0);

                    if (now >= endTime) {
                        setTimeRemaining('00:00:00');
                        return;
                    }

                    const diff = endTime - now;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const secs = Math.floor((diff % (1000 * 60)) / 1000);
                    setTimeRemaining(`${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`);
                };

                updateTimer();
                const interval = setInterval(updateTimer, 1000);
                return () => clearInterval(interval);
            }, []);

            const handleOpen = () => {
                setIsOpening(true);
                AudioEngine.play([400, 500, 600, 700, 800, 1000], 'sine', 0.35, 0.15);

                // Á¢∫Áéá2ÂÄç„Éñ„Éº„Çπ„ÉàÈÅ©Áî®
                const boostedRoll = Math.random() * 100;
                let reward = 30; // Âü∫Êú¨Â†±ÈÖ¨
                let rarity = 'rare';

                if (boostedRoll < 10) {
                    reward = 200;
                    rarity = 'legendary';
                } else if (boostedRoll < 30) {
                    reward = 80;
                    rarity = 'epic';
                } else if (boostedRoll < 60) {
                    reward = 50;
                    rarity = 'rare';
                }

                setTimeout(() => {
                    onClaim(reward, rarity);
                }, 1500);
            };

            return (
                <div className="fixed inset-0 bg-black/90 z-[250] flex items-center justify-center backdrop-blur-md animate-scale-in">
                    {/* ËÉåÊôØ„ÅÆ„Çµ„É≥„É©„Ç§„Ç∫„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */}
                    <div className="absolute inset-0 bg-gradient-to-t from-orange-600/30 via-yellow-500/20 to-transparent pointer-events-none" />

                    {/* Â§™ÈôΩÂÖâÁ∑ö„Ç®„Éï„Çß„ÇØ„Éà */}
                    <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[200vw] h-[50vh] bg-gradient-to-b from-yellow-400/40 to-transparent pointer-events-none"
                        style={{ clipPath: 'polygon(50% 0, 100% 100%, 0 100%)' }} />

                    <div className="relative text-center z-10">
                        {/* „Éò„ÉÉ„ÉÄ„Éº */}
                        <div className="mb-6">
                            <div className="text-6xl mb-2 animate-bounce-soft">‚òÄÔ∏è</div>
                            <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-orange-400 to-yellow-300 mb-2">
                                MORNING BONUS!
                            </h2>
                            <p className="text-orange-200 font-bold text-sm">
                                Êó©Ëµ∑„Åç„ÅÆ„ÅîË§íÁæé - Á¢∫Áéá2ÂÄç„Éñ„Éº„Çπ„Éà‰∏≠ÔºÅ
                            </p>
                        </div>

                        {/* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ */}
                        <div className="bg-black/50 rounded-2xl px-6 py-3 mb-6 inline-block">
                            <div className="text-xs text-orange-300 font-bold uppercase tracking-widest mb-1">
                                ÊÆã„ÇäÊôÇÈñì
                            </div>
                            <div className="text-2xl font-mono font-black text-white">
                                {timeRemaining}
                            </div>
                        </div>

                        {/* ÂÆùÁÆ± */}
                        <div className={`relative w-40 h-40 mx-auto mb-8 ${isOpening ? 'animate-shake' : 'animate-bounce-soft'}`}>
                            <div className="absolute inset-0 bg-gradient-to-r from-yellow-400 via-orange-500 to-yellow-400 rounded-3xl blur-2xl opacity-60 animate-pulse" />
                            <div className="relative w-full h-full flex items-center justify-center text-8xl filter drop-shadow-2xl">
                                {isOpening ? '‚ú®' : 'üéÅ'}
                            </div>
                        </div>

                        {/* „Éú„Çø„É≥ */}
                        {!isOpening ? (
                            <button
                                onClick={handleOpen}
                                className="bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-black text-xl px-12 py-4 rounded-2xl border-b-4 border-orange-700 hover:scale-105 active:scale-95 active:border-b-0 active:translate-y-1 transition-all shadow-2xl"
                            >
                                üåÖ ÈñãÂ∞Å„Åô„ÇãÔºÅ
                            </button>
                        ) : (
                            <div className="text-2xl text-yellow-300 font-black animate-pulse">
                                ÈñãÂ∞Å‰∏≠...
                            </div>
                        )}

                        {/* Ë¶ãÈÄÉ„ÅóË≠¶Âëä */}
                        <p className="mt-6 text-orange-400/70 text-xs font-bold">
                            ‚ö†Ô∏è 16ÊôÇ„ÇíÈÅé„Åé„Çã„Å®Ê∂à„Åà„Åæ„Åô„ÄÇ24ÊôÇÈñìÂæå„Åæ„ÅßÂæÖÊ©ü„ÄÇ
                        </p>
                    </div>
                </div>
            );
        };

        // üíé Áù°Áú†„ÉÅ„É£„Éº„Ç∏„É¢„Éº„ÉÄ„É´
        const SleepChargeModal = ({ amount, onCollect, onClose }) => {
            const [collected, setCollected] = useState(false);
            const [displayAmount, setDisplayAmount] = useState(0);

            useEffect(() => {
                // Êï∞Â≠ó„Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                const duration = 1500;
                const start = Date.now();
                const animate = () => {
                    const elapsed = Date.now() - start;
                    const progress = Math.min(elapsed / duration, 1);
                    setDisplayAmount(Math.floor(amount * progress));
                    if (progress < 1) requestAnimationFrame(animate);
                };
                animate();
            }, [amount]);

            const handleCollect = () => {
                setCollected(true);
                AudioEngine.play([523, 659, 784, 880, 1047, 1319], 'sine', 0.25, 0.1);
                setTimeout(() => onCollect(amount), 800);
            };

            return (
                <div className="fixed inset-0 bg-black/85 z-[240] flex items-center justify-center backdrop-blur-sm animate-scale-in">
                    {/* Â§úÁ©∫„ÅÆÊòü„Ç®„Éï„Çß„ÇØ„Éà */}
                    <div className="absolute inset-0 pointer-events-none overflow-hidden">
                        {Array.from({ length: 30 }, (_, i) => (
                            <div
                                key={i}
                                className="absolute w-1 h-1 bg-white rounded-full animate-pulse"
                                style={{
                                    left: `${Math.random() * 100}%`,
                                    top: `${Math.random() * 100}%`,
                                    animationDelay: `${Math.random() * 2}s`,
                                    opacity: 0.3 + Math.random() * 0.7
                                }}
                            />
                        ))}
                    </div>

                    <div className="relative text-center z-10">
                        {/* „Éò„ÉÉ„ÉÄ„Éº */}
                        <div className="mb-6">
                            <div className="text-6xl mb-2">üí§</div>
                            <h2 className="text-2xl font-black text-blue-300 mb-2">
                                SLEEP CHARGE
                            </h2>
                            <p className="text-blue-200/70 font-bold text-sm">
                                ÂØù„Å¶„ÅÑ„ÇãÈñì„Å´„Ç∏„Çß„É†„ÅåÊ∫ú„Åæ„Çä„Åæ„Åó„ÅüÔºÅ
                            </p>
                        </div>

                        {/* „Ç∏„Çß„É†Ë°®Á§∫ */}
                        <div className="bg-gradient-to-br from-blue-900/80 to-purple-900/80 rounded-3xl px-10 py-8 mb-6 border-2 border-blue-400/30">
                            <div className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300 mb-2">
                                +{displayAmount}üíé
                            </div>
                            <div className="text-blue-300 text-sm font-bold">
                                „Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô
                            </div>
                        </div>

                        {/* Ê∏õË°∞Ë≠¶Âëä */}
                        <div className="bg-red-900/30 border border-red-500/30 rounded-xl px-4 py-2 mb-6">
                            <p className="text-red-300 text-xs font-bold animate-pulse">
                                ‚ö†Ô∏è ÂõûÂèé„Åó„Å™„ÅÑ„Å®10ÂàÜ„ÅßÊ∏õË°∞ÈñãÂßãÔºÅ
                            </p>
                        </div>

                        {/* „Éú„Çø„É≥ */}
                        {!collected ? (
                            <button
                                onClick={handleCollect}
                                className="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-black text-lg px-10 py-3 rounded-2xl border-b-4 border-blue-700 hover:scale-105 active:scale-95 active:border-b-0 active:translate-y-1 transition-all"
                            >
                                üíé ÂõûÂèé„Åô„Çã
                            </button>
                        ) : (
                            <div className="text-2xl text-cyan-300 font-black animate-pulse">
                                ÂõûÂèéÂÆå‰∫ÜÔºÅ
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // üî• „Çπ„Éà„É™„Éº„ÇØË≠¶Âëä„Éê„Éä„Éº
        const StreakWarningBanner = ({ streak, onDismiss }) => (
            <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[150] animate-bounce">
                <div className="bg-gradient-to-r from-red-600 to-orange-600 text-white px-6 py-3 rounded-2xl shadow-2xl border-b-4 border-red-800 flex items-center gap-3">
                    <span className="text-2xl animate-pulse">üî•</span>
                    <div>
                        <div className="font-black text-sm">„Çπ„Éà„É™„Éº„ÇØÊ∂àÊªÖ„Åæ„Åß„ÅÇ„Å®1ÊôÇÈñìÔºÅ</div>
                        <div className="text-xs text-red-200 font-bold">
                            {streak}Êó•ÈÄ£Á∂ö„ÇíÂÆà„ÇåÔºÅ‰ªä„Åô„Åê„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Åó„Çà„ÅÜ
                        </div>
                    </div>
                    <button
                        onClick={onDismiss}
                        className="text-red-200 hover:text-white font-bold text-lg ml-2"
                    >
                        √ó
                    </button>
                </div>
            </div>
        );

        // --- Context Menu ---
        const ContextMenu = ({ x, y, onDivide, onMerge, onPurge, showMerge, showPurge }) => (
            <div className="fixed z-[9999] bg-white border-2 border-gray-200 rounded-xl shadow-floating py-1 w-56 animate-scale-in" style={{ left: x, top: y }}>
                <button onClick={onDivide} className="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-2 font-bold text-gray-600 text-sm">
                    <Icons.Divide size={16} /> „Åì„Åì„ÅßÂå∫Âàá„Çã
                </button>
                {showMerge && (
                    <button onClick={onMerge} className="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-2 font-bold text-gray-600 text-sm">
                        <Icons.Merge size={16} /> Âå∫Âàá„Çä„ÇíÂâäÈô§
                    </button>
                )}
                {showPurge && (
                    <div className="border-t border-gray-100 mt-1 pt-1">
                        <button onClick={onPurge} className="w-full text-left px-4 py-3 hover:bg-red-50 flex items-center gap-2 font-bold text-red-500 text-sm">
                            <Icons.Trash size={16} /> Post-MVP„Å∏„Éë„Éº„Ç∏
                        </button>
                    </div>
                )}
            </div>
        );

        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
        const getAdjustedToday = () => {
            const d = new Date(); d.setHours(d.getHours() - 3); return d.toISOString().split('T')[0];
        };

        // üé∞ LDWSÁêÜË´ñÔºöÂ†±ÈÖ¨„ÉÜ„Ç£„Ç¢Ê±∫ÂÆöÈñ¢Êï∞ÔºàÊêçÂ§±„ÇíÂãùÂà©„Å´ÂÅΩË£ÖÔºâ
        const determineRewardTier = (pityCounter, isFeverMode) => {
            // Âü∫Êú¨Á¢∫ÁéáÔºàLDWSÊßãÈÄ†Ôºâ
            let whiffChance = 45;      // ÂÆåÂÖ®„Éè„Ç∫„É¨ÔºàÊÇî„Åó„ÅïÔºâ
            let smallChance = 35;      // Â∞èÂΩì„Åü„ÇäÔºàÂª∂ÂëΩÊé™ÁΩÆ„ÉªLDWsÔºâ
            let normalChance = 14;     // Ê∫ÄË∂≥ÊÑüÔºàÁøíÊÖ£ÂåñÔºâ
            let bigChance = 5;         // Âº∑„ÅÑÂø´Ê•ΩÔºà‰∏≠ÊØí„ÅÆÁ∂≠ÊåÅÔºâ
            let jackpotChance = 1;     // Á•ûË©±ÁöÑÊàêÂäüÔºàÂ∞ÑÂπ∏ÂøÉ„ÅÆÊ†∏ÂøÉÔºâ

            // Â§©‰∫ï„Ç∑„Çπ„ÉÜ„É†Ôºö„Çπ„Ç´„ÅåÁ∂ö„Åè„Å®Á¢∫Áéá‰∏äÊòá
            const pityBonus = Math.min(pityCounter * 2, 30); // ÊúÄÂ§ß30%„Éñ„Éº„Çπ„Éà
            jackpotChance += pityBonus * 0.5;
            bigChance += pityBonus * 0.5;
            whiffChance -= pityBonus;

            // „Éï„Ç£„Éº„Éê„Éº„É¢„Éº„ÉâÔºö„É¨„Ç¢Á¢∫Áéá2ÂÄç
            if (isFeverMode) {
                const originalBig = bigChance;
                const originalJackpot = jackpotChance;
                bigChance = Math.min(originalBig * 2, 40);
                jackpotChance = Math.min(originalJackpot * 2, 30);
                const boost = (bigChance - originalBig) + (jackpotChance - originalJackpot);
                whiffChance -= boost;
                smallChance = Math.max(smallChance - boost * 0.3, 10);
            }

            // ÊäΩÈÅ∏
            const roll = Math.random() * 100;
            if (roll < jackpotChance) return 'jackpot';
            if (roll < jackpotChance + bigChance) return 'big';
            if (roll < jackpotChance + bigChance + normalChance) return 'normal';
            if (roll < jackpotChance + bigChance + normalChance + smallChance) return 'small';
            return 'whiff';
        };

        const Confetti = ({ type, theme }) => {
            const performanceColors = ['bg-yellow-400', 'bg-yellow-300', 'bg-gray-300', 'bg-gray-200'];
            const colors = performanceColors;

            // Checkbox Ignition (Small Confetti)
            const isSmall = type === 'ignition';
            const particlesCount = isSmall ? 8 : (type === 'big' || type === 'performance' ? 45 : 12);

            const particles = Array.from({ length: particlesCount }).map((_, i) => ({
                id: i,
                tx: (Math.random() - 0.5) * (isSmall ? 60 : 240),
                ty: (Math.random() - 0.5) * (isSmall ? 60 : 240),
                size: Math.random() * (isSmall ? 3 : 7) + 2,
                color: colors[Math.floor(Math.random() * colors.length)],
                rotation: Math.random() * 360
            }));

            return (
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-50 overflow-visible">
                    {particles.map(p => (
                        <div key={p.id} className={`absolute rounded-full ${p.color}`}
                            style={{
                                width: p.size,
                                height: p.size,
                                '--tx': `${p.tx}px`, '--ty': `${p.ty}px`,
                                animation: 'confetti-explode 0.4s ease-out forwards',
                            }}
                        />
                    ))}
                </div>
            );
        };

        // --- ÂÆåÂÖ®‰æùÂ≠ò„É¨„Éô„É´Ôºö4ÊÆµÈöéÂ†±ÈÖ¨ÊºîÂá∫„Ç∑„Çπ„ÉÜ„É† ---

        // „Éã„Ç¢„Éü„ÇπÊºîÂá∫ÔºöÈáëËâ≤„ÅÆ„Éï„É©„ÉÉ„Ç∑„É•
        const NearMissFlash = () => {
            return (
                <div
                    className="fixed inset-0 pointer-events-none z-[300]"
                    style={{
                        background: 'radial-gradient(circle, rgba(255,215,0,0.6) 0%, rgba(255,165,0,0.3) 40%, transparent 70%)',
                        animation: 'near-miss-intense 0.4s ease-out forwards',
                    }}
                />
            );
        };

        // üé∞ ÁµêÊûú„ÉÜ„Ç≠„Çπ„ÉàÊºîÂá∫: ÁîªÈù¢‰∏≠Â§Æ„Å´Ê¥æÊâã„Å™„ÉÜ„Ç≠„Çπ„Éà
        const WinText = ({ tier, onComplete }) => {
            const [visible, setVisible] = useState(true);

            useEffect(() => {
                const timer = setTimeout(() => {
                    setVisible(false);
                    if (onComplete) onComplete();
                }, tier === 'jackpot' ? 2000 : tier === 'big' ? 1500 : 800);
                return () => clearTimeout(timer);
            }, [tier, onComplete]);

            const config = {
                whiff: { text: '...', color: 'text-gray-400', size: 'text-4xl', animate: '' },
                small: { text: 'SMALL WIN!', color: 'text-yellow-400', size: 'text-5xl', animate: 'animate-bounce' },
                normal: { text: 'WIN!', color: 'text-green-400', size: 'text-6xl', animate: 'animate-bounce' },
                big: { text: 'BIG WIN!!', color: 'text-orange-500', size: 'text-7xl', animate: 'animate-pulse' },
                jackpot: { text: 'üé∞ JACKPOT!!! üé∞', color: 'text-red-500', size: 'text-8xl', animate: 'animate-bounce' }
            };
            const c = config[tier] || config.whiff;

            if (!visible) return null;

            return (
                <div className="fixed inset-0 flex items-center justify-center pointer-events-none z-[400]">
                    <div className={`${c.size} font-black ${c.color} ${c.animate} drop-shadow-[0_4px_20px_rgba(0,0,0,0.8)]`}
                        style={{
                            textShadow: tier === 'jackpot' ? '0 0 40px #ff0000, 0 0 80px #ff6600' :
                                tier === 'big' ? '0 0 30px #ff8800, 0 0 60px #ffaa00' :
                                    tier === 'normal' ? '0 0 20px #00ff00' : 'none',
                            animation: tier === 'jackpot' ? 'jackpot-text 0.3s ease-in-out infinite' : undefined
                        }}>
                        {c.text}
                    </div>
                </div>
            );
        };

        // üé∞ „É¨„Ç¢‰∫àÂëäÁ¢∫Ë™ç„É¢„Éº„É°„É≥„Éà: Ëôπ/Ëµ§‰∫àÂëäÊôÇ„ÅÆÂÖ®ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•
        const RareForecastFlash = ({ forecast, onComplete }) => {
            useEffect(() => {
                // Ê¥æÊâã„Å™‰∫àÂëäÈü≥
                if (forecast === 'rainbow') {
                    AudioEngine.play([800, 1000, 1200, 1400, 1600], 'sine', 0.3, 0.05);
                } else if (forecast === 'red') {
                    AudioEngine.play([600, 800, 1000, 1200], 'sine', 0.25, 0.06);
                }
                const timer = setTimeout(() => {
                    if (onComplete) onComplete();
                }, forecast === 'rainbow' ? 800 : 600);
                return () => clearTimeout(timer);
            }, [forecast, onComplete]);

            const bgColor = forecast === 'rainbow'
                ? 'bg-gradient-to-br from-red-500 via-yellow-400 via-green-400 via-blue-500 to-purple-500'
                : 'bg-gradient-to-br from-red-600 to-orange-500';

            return (
                <div className={`fixed inset-0 pointer-events-none z-[450] ${bgColor} animate-pulse`}
                    style={{
                        opacity: 0.7,
                        animation: 'forecast-flash 0.3s ease-out forwards'
                    }}>
                    <div className="absolute inset-0 flex items-center justify-center">
                        <div className="text-white text-9xl font-black animate-bounce drop-shadow-lg">
                            {forecast === 'rainbow' ? 'üåà' : 'üî•'}
                        </div>
                        <div className="absolute text-white text-4xl font-black mt-40">
                            {forecast === 'rainbow' ? 'Ëôπ‰∫àÂëäÔºÅÔºÅ' : 'ÊøÄ„Ç¢„ÉÑ‰∫àÂëäÔºÅ'}
                        </div>
                    </div>
                </div>
            );
        };

        // üé∞ „Ç∏„Çß„É†Âê∏„ÅÑËæº„ÅøÊºîÂá∫: Áç≤ÂæóÊôÇ„Å´ÁîªÈù¢Âè≥‰∏ä„Å∏ËªåË∑°
        const GemAbsorb = ({ amount, startX, startY, onComplete }) => {
            const [gems, setGems] = useState([]);
            const [animating, setAnimating] = useState(false);

            useEffect(() => {
                // ÁõÆÊ®ô‰ΩçÁΩÆÔºàÁîªÈù¢Âè≥‰∏ä„ÅÆ„Ç∏„Çß„É†Ë°®Á§∫‰ªòËøëÔºâ
                const targetX = window.innerWidth - 80;
                const targetY = 50;

                // Ë§áÊï∞„ÅÆ„Ç∏„Çß„É†„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÇíÁîüÊàê
                const count = Math.min(amount, 10);
                const newGems = [];
                for (let i = 0; i < count; i++) {
                    const gemStartX = startX + (Math.random() - 0.5) * 100;
                    const gemStartY = startY + (Math.random() - 0.5) * 100;
                    newGems.push({
                        id: i,
                        startX: gemStartX,
                        startY: gemStartY,
                        targetX: targetX,
                        targetY: targetY,
                        delay: i * 80
                    });
                }
                setGems(newGems);

                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
                setTimeout(() => setAnimating(true), 100);

                // Âê∏„ÅÑËæº„ÅøÈü≥
                setTimeout(() => AudioEngine.play([800, 1000, 1200, 1400], 'sine', 0.2, 0.08), 300);

                // Âà∞ÁùÄÈü≥Ôºà„ÉÅ„É£„É™„É≥Ôºâ
                setTimeout(() => AudioEngine.play([2000, 2200], 'sine', 0.15, 0.05), 900);

                const timer = setTimeout(() => {
                    setGems([]);
                    if (onComplete) onComplete();
                }, 1200);
                return () => clearTimeout(timer);
            }, [amount, startX, startY, onComplete]);

            return (
                <>
                    {gems.map(g => (
                        <div
                            key={g.id}
                            className="fixed pointer-events-none z-[500]"
                            style={{
                                left: animating ? g.targetX : g.startX,
                                top: animating ? g.targetY : g.startY,
                                fontSize: animating ? '14px' : '28px',
                                opacity: animating ? 0 : 1,
                                transition: `all 0.8s ease-in ${g.delay}ms`,
                                filter: 'drop-shadow(0 0 8px rgba(100, 200, 255, 0.8))'
                            }}
                        >
                            üíé
                        </div>
                    ))}
                </>
            );
        };

        // üî• „Ç≥„É≥„ÉúÊºîÂá∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà - ÈÄ£Á∂öÂÆå‰∫Ü„ÅßË°®Á§∫
        const ComboDisplay = ({ comboCount, onComplete }) => {
            const [visible, setVisible] = useState(true);

            useEffect(() => {
                // „Ç≥„É≥„ÉúÊï∞„Å´Âøú„Åò„Åü„Çµ„Ç¶„É≥„Éâ
                const baseFreq = 600 + comboCount * 100;
                if (comboCount >= 5) {
                    // 5„Ç≥„É≥„Éú‰ª•‰∏ä: Ê¥æÊâã„Å™„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨
                    AudioEngine.play([baseFreq, baseFreq + 200, baseFreq + 400, baseFreq + 600], 'sine', 0.35, 0.08);
                } else if (comboCount >= 3) {
                    // 3-4„Ç≥„É≥„Éú: ‰∏äÊòáÈü≥Èöé
                    AudioEngine.play([baseFreq, baseFreq + 150, baseFreq + 300], 'sine', 0.25, 0.1);
                } else {
                    // 2„Ç≥„É≥„Éú: „Ç∑„É≥„Éó„É´„Å™Èü≥
                    AudioEngine.play([baseFreq, baseFreq + 100], 'sine', 0.2, 0.12);
                }

                const timer = setTimeout(() => {
                    setVisible(false);
                    if (onComplete) onComplete();
                }, comboCount >= 5 ? 1500 : 1000);
                return () => clearTimeout(timer);
            }, [comboCount, onComplete]);

            if (!visible) return null;

            // „Ç≥„É≥„ÉúÊï∞„Å´Âøú„Åò„ÅüË°®Á§∫„ÉÜ„Ç≠„Çπ„Éà„Å®„Çπ„Çø„Ç§„É´
            let text = 'COMBO!';
            let textClass = 'text-yellow-400';
            let sizeClass = 'text-5xl';
            let bgClass = '';

            if (comboCount >= 5) {
                text = `üî• ${comboCount}x UNSTOPPABLE! üî•`;
                textClass = 'text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-yellow-400 to-red-500';
                sizeClass = 'text-7xl';
                bgClass = 'animate-pulse';
            } else if (comboCount >= 3) {
                text = `‚ö° ${comboCount}x COMBO! ‚ö°`;
                textClass = 'text-orange-500';
                sizeClass = 'text-6xl';
            } else {
                text = `${comboCount}x COMBO!`;
            }

            return (
                <>
                    {/* ËÉåÊôØ„Éï„É©„ÉÉ„Ç∑„É•Ôºà„Ç≥„É≥„ÉúÊï∞„Å´Âøú„Åò„Å¶Âº∑ÂåñÔºâ */}
                    {comboCount >= 3 && (
                        <div
                            className={`fixed inset-0 pointer-events-none z-[350] ${bgClass}`}
                            style={{
                                background: comboCount >= 5
                                    ? 'radial-gradient(circle, rgba(255,100,0,0.4) 0%, rgba(255,50,0,0.2) 50%, transparent 100%)'
                                    : 'radial-gradient(circle, rgba(255,200,0,0.3) 0%, rgba(255,150,0,0.15) 50%, transparent 100%)',
                                animation: 'normal-flash 0.8s ease-out forwards',
                            }}
                        />
                    )}
                    {/* 5„Ç≥„É≥„Éú‰ª•‰∏ä„ÅßÁîªÈù¢ÊåØÂãï */}
                    {comboCount >= 5 && (
                        <div className="fixed inset-0 pointer-events-none z-[352]"
                            style={{ animation: 'screen-shake 0.5s ease-out forwards' }}
                        />
                    )}
                    {/* „Ç≥„É≥„Éú„ÉÜ„Ç≠„Çπ„Éà */}
                    <div className="fixed inset-0 flex items-center justify-center pointer-events-none z-[360]">
                        <div className={`${sizeClass} font-black ${textClass} animate-bounce drop-shadow-[0_4px_20px_rgba(0,0,0,0.8)]`}
                            style={{
                                textShadow: comboCount >= 5
                                    ? '0 0 40px rgba(255,100,0,1), 0 0 80px rgba(255,50,0,0.8)'
                                    : comboCount >= 3
                                        ? '0 0 30px rgba(255,150,0,0.8)'
                                        : '0 0 20px rgba(255,200,0,0.6)',
                            }}>
                            {text}
                        </div>
                    </div>
                    {/* ÂÄçÁéáË°®Á§∫ */}
                    <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 translate-y-16 pointer-events-none z-[360]">
                        <div className="text-2xl font-black text-white">
                            Â†±ÈÖ¨ {comboCount >= 5 ? '3' : comboCount >= 3 ? '2' : '1.5'}ÂÄç!
                        </div>
                    </div>
                </>
            );
        };

        // üåÄ Antigravity Button: ÈñãÁô∫Áí∞Â¢É„Å∏„ÅÆÊ¨°ÂÖÉË∑≥Ë∫ç
        const AntigravityButton = () => {
            const [isHovered, setIsHovered] = useState(false);
            const [isWarping, setIsWarping] = useState(false);

            const handleWarp = () => {
                if (isWarping) return;

                // URLË®≠ÂÆö„ÉÅ„Çß„ÉÉ„ÇØ
                let targetUrl = localStorage.getItem('antigravity_url');
                if (!targetUrl) {
                    const input = prompt("üöÄ „ÉØ„Éº„ÉóÂÖà„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n(‰æã: „Éñ„É©„Ç¶„Ç∂ÁâàAntigravity„ÅÆURL, Êú¨Áï™„Çµ„Ç§„Éà„ÅÆURL„Å™„Å©)", window.location.href);
                    if (input) {
                        targetUrl = input;
                        localStorage.setItem('antigravity_url', targetUrl);
                    } else {
                        return;
                    }
                }

                setIsWarping(true);

                // „ÉØ„Éº„Éó„ÉÅ„É£„Éº„Ç∏Èü≥
                AudioEngine.play([100, 200, 400, 800, 1600], 'sawtooth', 0.1, 0.05);

                // Âç≥ÊôÇÈÅ∑ÁßªÔºà„É¶„Éº„Ç∂„Éº„Ç∏„Çß„Çπ„ÉÅ„É£„ÉºÂÜÖ„ÅßÂÆüË°åÔºâ
                window.location.href = targetUrl;

                // „Éï„Çß„Ç§„É´„Çª„Éº„Éï: 5ÁßíÂæå„Å´Âæ©Â∏∞ÔºàÈÅ∑ÁßªÂ§±ÊïóÊôÇÁî®Ôºâ
                setTimeout(() => setIsWarping(false), 5000);
            };

            const handleContextMenu = (e) => {
                e.preventDefault();
                const currentUrl = localStorage.getItem('antigravity_url') || '';
                const input = prompt("‚öôÔ∏è „ÉØ„Éº„ÉóÂÖàURL„ÅÆÂ§âÊõ¥:", currentUrl);
                if (input !== null) {
                    localStorage.setItem('antigravity_url', input);
                    alert("‚úÖ „ÉØ„Éº„ÉóÂÖà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ");
                }
            };

            return (
                <>
                    {/* „ÉØ„Éº„ÉóÊºîÂá∫„Ç™„Éº„Éê„Éº„É¨„Ç§ */}
                    {isWarping && (
                        <div
                            className="fixed inset-0 z-[1000] flex items-center justify-center overflow-hidden cursor-pointer"
                            onClick={() => setIsWarping(false)}
                            title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Ç≠„É£„É≥„Çª„É´"
                        >
                            <div className="absolute inset-0 bg-black animate-[warp-fade-in_0.2s_ease-out_forwards]" />

                            {/* ÈõÜ‰∏≠Á∑ö */}
                            <div className="absolute inset-0 opacity-0 animate-[warp-lines_1.5s_ease-in_forwards]"
                                style={{
                                    background: 'repeating-conic-gradient(transparent 0deg, transparent 2deg, rgba(0, 255, 255, 0.5) 3deg, transparent 4deg)',
                                    transform: 'scale(2)',
                                }}
                            />

                            {/* Ê¨°ÂÖÉÊ≠™„Åø„É™„É≥„Ç∞ */}
                            <div className="absolute w-[200vw] h-[200vw] rounded-full border-[100px] border-purple-500 opacity-0 animate-[warp-ring_1.0s_ease-in_forwards]" />
                            <div className="absolute w-[100vw] h-[100vw] rounded-full border-[50px] border-blue-500 opacity-0 animate-[warp-ring_1.0s_ease-in_0.2s_forwards]" />

                            <div className="relative text-transparent text-9xl font-black italic tracking-tighter animate-[warp-text_0.5s_ease-in_0.8s_forwards]"
                                style={{ WebkitTextStroke: '2px white' }}>
                                WARP!!
                            </div>
                        </div>
                    )}

                    {/* „Éú„Çø„É≥Êú¨‰Ωì */}
                    <button
                        className={`fixed bottom-8 right-8 z-[100] group transition-all duration-300 ease-out ${isWarping ? 'scale-0 opacity-0' : 'scale-100 opacity-100'}`}
                        onMouseEnter={() => {
                            setIsHovered(true);
                            AudioEngine.play([100, 120], 'sawtooth', 0.05, 0.1); // ÈáçÂäõÈü≥
                        }}
                        onMouseLeave={() => setIsHovered(false)}
                        onClick={handleWarp}
                        onContextMenu={handleContextMenu}
                        title="Âè≥„ÇØ„É™„ÉÉ„ÇØ„Åß„ÉØ„Éº„ÉóÂÖàË®≠ÂÆö"
                    >
                        {/* Â§ñÈÉ®Áô∫ÂÖâÔºà„Ç™„Éº„É©Ôºâ */}
                        <div className="absolute inset-0 rounded-full bg-blue-500 blur-xl opacity-40 animate-pulse group-hover:opacity-80 group-hover:blur-2xl transition-all duration-500" />

                        {/* ÂÜÖÈÉ®ÂõûËª¢„É™„É≥„Ç∞ */}
                        <div className="absolute inset-[-4px] rounded-full border-2 border-transparent border-t-cyan-400 border-l-purple-500 animate-[spin_3s_linear_infinite] opacity-70" />
                        <div className="absolute inset-[-8px] rounded-full border border-transparent border-r-blue-500 border-b-pink-500 animate-[spin_5s_linear_infinite_reverse] opacity-50" />

                        {/* Êú¨‰Ωì */}
                        <div className="relative w-16 h-16 rounded-full bg-black flex items-center justify-center overflow-hidden border border-white/20 shadow-2xl group-hover:scale-110 transition-transform duration-300">
                            {/* ËÉåÊôØ„ÅÆÂÆáÂÆô */}
                            <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzAwMDAwMCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjEiIGZpbGw9IiNGRkZGRkYiLz48L3N2Zz4=')] opacity-50 animate-[spin_20s_linear_infinite]" />

                            {/* „Ç¢„Ç§„Ç≥„É≥ */}
                            <div className={`text-2xl transform transition-all duration-300 ${isHovered ? 'scale-125 rotate-180 text-cyan-300' : 'text-gray-400'}`}>
                                üöÄ
                            </div>
                        </div>

                        {/* „É©„Éô„É´Ôºà„Éõ„Éê„ÉºÊôÇ„ÅÆ„ÅøÔºâ */}
                        <div className={`absolute right-full mr-4 top-1/2 -translate-y-1/2 whitespace-nowrap text-cyan-400 font-bold tracking-widest text-sm
                            transition-all duration-300 ${isHovered ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-4'}`}>
                            ANTIGRAVITY
                        </div>
                    </button>
                </>
            );
        };
        const RewardWhiff = ({ onComplete, showNearMiss, nearMissIntensity = 'normal', consecutiveWhiff = 0 }) => {
            const [particles, setParticles] = useState([]);
            const [showText, setShowText] = useState(false);

            useEffect(() => {
                // ÈÄ£Á∂ö„Çπ„Ç´ÂõûÊï∞„Å´Âøú„Åò„Å¶ÊºîÂá∫Âº∑Âåñ
                const isConsecutive = consecutiveWhiff >= 3;
                const isLongStreak = consecutiveWhiff >= 5;

                // ÊÇî„Åó„ÅÑÊºîÂá∫ÔºöÊöó„ÅÑ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅåÊ∂à„Åà„ÇãÔºàÈÄ£Á∂ö„ÅßÂ¢óÂä†Ôºâ
                let particleCount = showNearMiss ? (nearMissIntensity === 'extreme' ? 40 : nearMissIntensity === 'strong' ? 25 : 20) : 15;
                particleCount += Math.min(consecutiveWhiff * 3, 30); // ÈÄ£Á∂ö„Éú„Éº„Éä„Çπ

                const newParticles = [];
                for (let i = 0; i < particleCount; i++) {
                    const angle = (Math.PI * 2 * i) / particleCount;
                    const speed = showNearMiss ? (nearMissIntensity === 'extreme' ? 150 : 100) : 80 + consecutiveWhiff * 5;
                    newParticles.push({
                        id: i,
                        x: window.innerWidth / 2,
                        y: window.innerHeight / 2,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        color: isLongStreak ? '#ff0000' : isConsecutive ? '#ff4444' : showNearMiss ? (nearMissIntensity === 'extreme' ? '#ff4444' : '#ffaa00') : '#888888',
                        size: showNearMiss ? 8 : 6 + Math.min(consecutiveWhiff, 5),
                    });
                }
                setParticles(newParticles);

                // üé∞ ÊÆãÂøµSE: ÈÄ£Á∂ö„Çπ„Ç´„ÅßÈü≥„ÅåÊÇ≤ÊÉ®„Å´
                if (isLongStreak) {
                    // 5ÈÄ£Á∂ö„Çπ„Ç´‰ª•‰∏ä: ÊÇ≤È≥¥„ÅÆ„Çà„ÅÜ„Å™Èü≥
                    AudioEngine.play([1500, 1200, 900, 600, 300, 100], 'sawtooth', 0.3, 0.1);
                    setShowText(true);
                } else if (isConsecutive) {
                    // 3ÈÄ£Á∂ö„Çπ„Ç´: Èáç„ÅÑËêΩËÉÜÈü≥
                    AudioEngine.play([800, 600, 400, 200, 100], 'sawtooth', 0.25, 0.12);
                    setShowText(true);
                } else if (showNearMiss) {
                    if (nearMissIntensity === 'extreme') {
                        AudioEngine.play([1200, 1400, 1600], 'sine', 0.2, 0.05);
                        setTimeout(() => AudioEngine.play([800, 600, 400, 200, 100, 50], 'sawtooth', 0.25, 0.15), 150);
                        setShowText(true);
                    } else if (nearMissIntensity === 'strong') {
                        AudioEngine.play([1000, 1200], 'sine', 0.18, 0.08);
                        setTimeout(() => AudioEngine.play([600, 500, 400, 300, 200, 100], 'sawtooth', 0.18, 0.15), 100);
                        setShowText(true);
                    } else {
                        AudioEngine.play([800, 1000], 'sine', 0.15, 0.1);
                        setTimeout(() => AudioEngine.play([500, 400, 300, 200, 150, 100], 'sawtooth', 0.15, 0.2), 100);
                    }
                } else {
                    AudioEngine.play([500, 400, 300, 200, 150, 100], 'sawtooth', 0.12, 0.18);
                }

                const duration = isLongStreak ? 1500 : (showNearMiss && nearMissIntensity === 'extreme') ? 1200 : 600;
                setTimeout(() => {
                    setParticles([]);
                    setShowText(false);
                    onComplete();
                }, duration);
            }, [onComplete]);

            // ÈÄ£Á∂ö„Çπ„Ç´„ÉÜ„Ç≠„Çπ„Éà
            const getStreakText = () => {
                if (consecutiveWhiff >= 7) return 'üî• „ÅÇ„Å®1Âõû„ÅßÂ§©‰∫ïÔºÅ';
                if (consecutiveWhiff >= 5) return 'üò≠ 5ÈÄ£Á∂ö„Çπ„Ç´...„Åß„ÇÇÂ§©‰∫ï„ÅåËøë„ÅÑÔºÅ';
                if (consecutiveWhiff >= 3) return 'üí¢ 3ÈÄ£Á∂ö„Çπ„Ç´...Ê¨°„Åì„ÅùÔºÅ';
                if (nearMissIntensity === 'extreme') return 'Ëôπ„Å†„Å£„Åü„ÅÆ„Å´...ÔºÅ';
                if (nearMissIntensity === 'strong') return 'ÊÉú„Åó„Åã„Å£„ÅüÔºÅ';
                return '';
            };

            // ÈÄ£Á∂ö„Çπ„Ç´„ÅßÁîªÈù¢„ÅåËµ§„Åè„Å™„ÇãÂ∫¶Âêà„ÅÑ
            const redIntensity = Math.min(consecutiveWhiff * 0.05, 0.3);

            return (
                <>
                    {showNearMiss && <NearMissFlash />}
                    {/* ÊöóËª¢„Ç®„Éï„Çß„ÇØ„ÉàÔºàÈÄ£Á∂ö„Çπ„Ç´„ÅßËµ§„Åè„Å™„ÇãÔºâ */}
                    <div
                        className={`fixed inset-0 pointer-events-none z-[290] ${nearMissIntensity === 'extreme' || consecutiveWhiff >= 5 ? 'animate-[screen-shake_0.3s_ease-in-out_3]' : ''}`}
                        style={{
                            background: consecutiveWhiff >= 5
                                ? `rgba(255, 0, 0, ${0.3 + redIntensity})`
                                : consecutiveWhiff >= 3
                                    ? `rgba(255, 50, 0, ${0.2 + redIntensity})`
                                    : showNearMiss && nearMissIntensity === 'extreme'
                                        ? 'rgba(255, 0, 0, 0.3)'
                                        : showNearMiss && nearMissIntensity === 'strong'
                                            ? 'rgba(255, 100, 0, 0.2)'
                                            : 'rgba(0, 0, 0, 0.3)',
                            animation: consecutiveWhiff >= 5 || nearMissIntensity === 'extreme'
                                ? 'whiff-darken 1.5s ease-out forwards'
                                : 'whiff-darken 0.6s ease-out forwards',
                        }}
                    />
                    {/* ÊÇî„Åó„ÅÑ„ÉÜ„Ç≠„Çπ„ÉàÔºàÈÄ£Á∂ö„Çπ„Ç´ or Âº∑„ÅÑ„Éã„Ç¢„Éü„ÇπÊôÇÔºâ */}
                    {showText && (
                        <div className="fixed inset-0 flex items-center justify-center pointer-events-none z-[300]">
                            <div className="text-center">
                                <div className={`text-4xl font-black ${consecutiveWhiff >= 5 ? 'text-red-600' : consecutiveWhiff >= 3 ? 'text-red-500' : nearMissIntensity === 'extreme' ? 'text-red-500' : 'text-yellow-500'} animate-pulse drop-shadow-lg`}>
                                    {getStreakText()}
                                </div>
                                <div className="text-lg text-white/80 mt-2">
                                    {consecutiveWhiff >= 7 ? 'Â§©‰∫ï„Åæ„Åß„ÅÇ„Å®1ÂõûÔºÅ' : consecutiveWhiff >= 3 ? 'Â§©‰∫ï„ÅåËøë„Å•„ÅÑ„Å¶„ÅÑ„Çã...' : '„ÅÇ„Å®Â∞ë„Åó„Å†„Å£„Åü...'}
                                </div>
                            </div>
                        </div>
                    )}
                    {/* ÊÇî„Åó„ÅÑ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */}
                    {particles.map(p => (
                        <div
                            key={p.id}
                            style={{
                                position: 'fixed',
                                left: p.x,
                                top: p.y,
                                width: `${p.size}px`,
                                height: `${p.size}px`,
                                backgroundColor: p.color,
                                borderRadius: '50%',
                                pointerEvents: 'none',
                                zIndex: 295,
                                animation: `whiff-fade ${showNearMiss && nearMissIntensity === 'extreme' ? '1s' : '0.6s'} ease-out forwards`,
                                '--vx': `${p.vx}px`,
                                '--vy': `${p.vy}px`,
                            }}
                        />
                    ))}
                </>
            );
        };

        // üé∞ Â∞èÂΩì„Åü„ÇäÊºîÂá∫Ôºà40%Ôºâ: LDWs + „Éã„Ç¢„Éü„Çπ„Éï„Çß„Ç§„É≥„Éà
        const RewardSmallWin = ({ onComplete, centerX, centerY }) => {
            const [particles, setParticles] = useState([]);
            const [phase, setPhase] = useState('feint'); // feint ‚Üí reveal

            useEffect(() => {
                // === „Éï„Çß„Ç§„É≥„Éà„Éï„Çß„Éº„Ç∫: ‰∏ÄÁû¨„ÄåBIG!?„Äç„Å®ÊÄù„Çè„Åõ„Çã ===
                // Ê¥æÊâã„Å™„Éï„É©„ÉÉ„Ç∑„É•Èü≥
                AudioEngine.play([400, 600, 800], 'sawtooth', 0.2, 0.05);

                // 0.4ÁßíÂæå„Å´ÂÆüÈöõ„ÅÆÁµêÊûú„Å∏
                setTimeout(() => {
                    setPhase('reveal');

                    // ËêΩËÉÜÈü≥Ôºà„Ç¨„ÉÉ„Ç´„É™Èü≥Á®ã‰∏ãÈôçÔºâ
                    AudioEngine.play([600, 400, 300], 'sine', 0.15, 0.08);

                    // Êéß„Åà„ÇÅ„Å™ÈáëËâ≤„Éë„Éº„ÉÜ„Ç£„ÇØ„É´Ôºà30ÂÄãÔºâ
                    const goldShades = ['#FFD700', '#FFC700', '#FFB700'];
                    const newParticles = [];
                    for (let i = 0; i < 30; i++) {
                        const fromLeft = i % 2 === 0;
                        const startX = fromLeft ? '5%' : '95%';
                        const startY = '5%';
                        const spreadX = (Math.random() - 0.5) * 200;
                        const spreadY = (Math.random() - 0.5) * 200;
                        newParticles.push({
                            id: i, startX, startY,
                            targetX: `${centerX + spreadX}px`, targetY: `${centerY + spreadY}px`,
                            color: goldShades[i % goldShades.length],
                            delay: Math.random() * 0.2, duration: 0.7 + Math.random() * 0.3,
                            size: 6 + Math.random() * 4,
                        });
                    }
                    setParticles(newParticles);

                    // Êéß„Åà„ÇÅ„Å™„ÉÅ„É™„É≥Èü≥
                    setTimeout(() => AudioEngine.play([1047], 'sine', 0.12, 0.06), 200);
                }, 400);

                setTimeout(() => {
                    setParticles([]);
                    onComplete();
                }, 1600);
            }, [centerX, centerY, onComplete]);

            return (
                <>
                    {/* „Éï„Çß„Ç§„É≥„Éà„Éï„Çß„Éº„Ç∫: ‰∏ÄÁû¨BIG„Åã„Å®ÊÄù„Çè„Åõ„Çã */}
                    {phase === 'feint' && (
                        <>
                            <div className="fixed inset-0 pointer-events-none z-[280]"
                                style={{
                                    background: 'radial-gradient(circle, rgba(255,140,0,0.4) 0%, rgba(255,100,0,0.3) 50%, transparent 100%)',
                                    animation: 'feint-flash 0.4s ease-out forwards',
                                }}
                            />
                            <div className="fixed top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-[290]">
                                <div className="text-5xl font-black text-orange-500 animate-pulse">BIG...!?</div>
                            </div>
                        </>
                    )}
                    {/* ÂÆüÈöõ„ÅÆÁµêÊûú„Éï„Çß„Éº„Ç∫ */}
                    {phase === 'reveal' && (
                        <>
                            <div className="fixed inset-0 pointer-events-none z-[280]"
                                style={{
                                    background: 'radial-gradient(circle, rgba(255,215,0,0.15) 0%, transparent 50%)',
                                    animation: 'normal-flash 0.5s ease-out forwards',
                                }}
                            />
                            {/* „ÄåÊÉú„Åó„ÅÑÔºÅ„Äç„ÉÜ„Ç≠„Çπ„Éà */}
                            <div className="fixed top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-[290]"
                                style={{ animation: 'near-miss-text 1s ease-out forwards' }}>
                                <div className="text-2xl font-black text-yellow-500">ÊÉú„Åó„ÅÑÔºÅ„ÅÇ„Å®Â∞ë„Åó„ÅßBIG...</div>
                            </div>
                            {particles.map(p => (
                                <CrackerConfettiParticle key={p.id} {...p} />
                            ))}
                        </>
                    )}
                </>
            );
        };

        // „Éé„Éº„Éû„É´ÊºîÂá∫Ôºà22%Ôºâ: ËôπËâ≤„ÇØ„É©„ÉÉ„Ç´„Éº
        const RewardNormal = ({ onComplete, centerX, centerY }) => {
            const [particles, setParticles] = useState([]);
            const [rings, setRings] = useState([]);

            useEffect(() => {
                // ËôπËâ≤„ÅÆ„ÇØ„É©„ÉÉ„Ç´„Éº„Éë„Éº„ÉÜ„Ç£„ÇØ„É´Ôºà100ÂÄãÔºâ
                const rainbowColors = ['#FF6B9D', '#C44569', '#F8B500', '#4ECDC4', '#95E1D3', '#38B6FF', '#A8E6CF'];
                const newParticles = [];
                for (let i = 0; i < 100; i++) {
                    const fromLeft = i % 2 === 0;

                    // Â∑¶‰∏ã„Åæ„Åü„ÅØÂè≥‰∏ã„Åã„Çâ„ÅÆÁô∫Â∞Ñ
                    const startX = fromLeft ? '5%' : '95%';
                    const startY = '5%';

                    // ‰∏≠Â§Æ‰ªòËøë„Å∏„ÅÆ„É©„É≥„ÉÄ„É†„Å™ÁùÄÂú∞ÁÇπ
                    const spreadX = (Math.random() - 0.5) * 500;
                    const spreadY = (Math.random() - 0.5) * 500;
                    const targetX = `${centerX + spreadX}px`;
                    const targetY = `${centerY + spreadY}px`;

                    newParticles.push({
                        id: i,
                        startX,
                        startY,
                        targetX,
                        targetY,
                        color: rainbowColors[i % rainbowColors.length],
                        delay: Math.random() * 0.3,
                        duration: 0.9 + Math.random() * 0.4,
                        size: 10 + Math.random() * 8,
                    });
                }
                setParticles(newParticles);

                // Êã°Êï£„É™„É≥„Ç∞3„Å§
                setRings([{ id: 1 }, { id: 2 }, { id: 3 }]);

                // üé∞ ÂΩì„Åü„ÇäSE: „Éô„É´Èü≥ ‚Üí „Ç≥„Ç§„É≥Èü≥ÈÄ£Á∂ö
                // „Éô„É´Èü≥Ôºà„ÉÅ„Éº„É≥ÔºÅÔºâ
                AudioEngine.play([2093, 2093], 'sine', 0.25, 0.12);
                // „Ç≥„Ç§„É≥„Åå„ÉÅ„É£„É™„É≥„ÉÅ„É£„É™„É≥ËêΩ„Å°„ÇãÈü≥
                setTimeout(() => AudioEngine.play([880, 1047], 'triangle', 0.18, 0.06), 150);
                setTimeout(() => AudioEngine.play([932, 1109], 'triangle', 0.16, 0.05), 250);
                setTimeout(() => AudioEngine.play([987, 1175], 'triangle', 0.14, 0.05), 340);
                setTimeout(() => AudioEngine.play([1047, 1245], 'triangle', 0.12, 0.04), 420);
                setTimeout(() => AudioEngine.play([1109, 1319], 'triangle', 0.1, 0.04), 490);

                setTimeout(() => {
                    setParticles([]);
                    setRings([]);
                    onComplete();
                }, 2000);
            }, [centerX, centerY, onComplete]);

            return (
                <>
                    {/* ËôπËâ≤„Éï„É©„ÉÉ„Ç∑„É• */}
                    <div
                        className="fixed inset-0 pointer-events-none z-[280]"
                        style={{
                            background: 'radial-gradient(circle, rgba(255,107,157,0.4) 0%, rgba(62,207,196,0.3) 50%, transparent 70%)',
                            animation: 'normal-flash 0.8s ease-out forwards',
                        }}
                    />
                    {/* Êã°Êï£„É™„É≥„Ç∞ */}
                    {rings.map((r, i) => (
                        <div
                            key={r.id}
                            style={{
                                position: 'fixed',
                                left: centerX,
                                top: centerY,
                                width: '50px',
                                height: '50px',
                                marginLeft: '-25px',
                                marginTop: '-25px',
                                border: '4px solid rgba(255, 107, 157, 0.8)',
                                borderRadius: '50%',
                                pointerEvents: 'none',
                                zIndex: 285,
                                animation: `ring-expand 1s ease-out ${i * 0.15}s forwards`,
                            }}
                        />
                    ))}
                    {/* ËôπËâ≤„ÇØ„É©„ÉÉ„Ç´„Éº„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */}
                    {particles.map(p => (
                        <CrackerConfettiParticle key={p.id} {...p} />
                    ))}
                </>
            );
        };

        // „Éì„ÉÉ„Ç∞ÊºîÂá∫Ôºà10%Ôºâ: ÂúßÂÄíÁöÑ„É¨„Ç§„É≥„Éú„ÉºÁàÜÁô∫ - ÊÆµÈöéÁöÑÁõõ„Çä‰∏ä„Åå„Çä
        const RewardBig = ({ onComplete }) => {
            const [particles, setParticles] = useState([]);
            const [explosions, setExplosions] = useState([]);
            const [lightBeams, setLightBeams] = useState([]);
            const [phase, setPhase] = useState('buildup'); // buildup ‚Üí explode

            useEffect(() => {
                // === „Éï„Çß„Éº„Ç∫1: „Éì„É´„Éâ„Ç¢„ÉÉ„ÉóÔºà„Éâ„Éâ„Éâ„Éâ...Ôºâ ===
                // ÁîªÈù¢„ÅåÂæê„ÄÖ„Å´Êòé„Çã„Åè„ÄÅÊåØÂãï„ÅåÂ¢ó„Åô
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        AudioEngine.play([100 + i * 30], 'sawtooth', 0.15 + i * 0.02, 0.03);
                    }, i * 100);
                }

                // 1ÁßíÂæå„Å´ÁàÜÁô∫„Éï„Çß„Éº„Ç∫„Å∏
                setTimeout(() => {
                    setPhase('explode');

                    // === „Éï„Çß„Éº„Ç∫2: ÁàÜÁô∫Ôºà„Éâ„É≥ÔºÅÔºâ ===
                    // Èáç‰ΩéÈü≥ + È´òÈü≥„ÅÆË°ùÊíÉ
                    AudioEngine.play([60, 80, 100], 'sawtooth', 0.4, 0.15);
                    AudioEngine.play([1500, 2000, 2500], 'sine', 0.3, 0.1);

                    // ÈÄ£Á∂öÁàÜÁô∫„Ç®„Éï„Çß„ÇØ„Éà
                    setExplosions([
                        { id: 1, delay: 0, x: '30%', y: '30%' },
                        { id: 2, delay: 0.1, x: '70%', y: '40%' },
                        { id: 3, delay: 0.2, x: '50%', y: '60%' },
                        { id: 4, delay: 0.3, x: '20%', y: '70%' },
                        { id: 5, delay: 0.4, x: '80%', y: '20%' },
                    ]);

                    // ÂÖâÁ∑ö„Ç®„Éï„Çß„ÇØ„Éà
                    setLightBeams([
                        { id: 1, angle: 0 }, { id: 2, angle: 60 }, { id: 3, angle: 120 },
                        { id: 4, angle: 180 }, { id: 5, angle: 240 }, { id: 6, angle: 300 },
                    ]);

                    // „É¨„Ç§„É≥„Éú„Éº„ÇØ„É©„ÉÉ„Ç´„ÉºÂ§ßÈáèÔºà300ÂÄãÔºâ
                    const rainbowColors = ['#FF0080', '#FF8C00', '#FFD700', '#00FF00', '#00CED1', '#4169E1', '#9370DB'];
                    const centerX = window.innerWidth / 2;
                    const centerY = window.innerHeight / 2;
                    const newParticles = [];
                    for (let i = 0; i < 300; i++) {
                        const fromLeft = i % 2 === 0;
                        const startX = fromLeft ? '5%' : '95%';
                        const startY = '5%';
                        const spreadX = (Math.random() - 0.5) * 700;
                        const spreadY = (Math.random() - 0.5) * 700;
                        newParticles.push({
                            id: i, startX, startY,
                            targetX: `${centerX + spreadX}px`, targetY: `${centerY + spreadY}px`,
                            color: rainbowColors[i % rainbowColors.length],
                            delay: Math.random() * 0.5, duration: 1 + Math.random() * 0.6,
                            size: 14 + Math.random() * 10,
                        });
                    }
                    setParticles(newParticles);

                    // „Éï„Ç°„É≥„Éï„Ç°„Éº„É¨
                    setTimeout(() => AudioEngine.play([523, 659, 784, 1047, 1319, 1568], 'triangle', 0.32, 0.2), 200);
                    setTimeout(() => AudioEngine.play([659, 784, 1047, 1319, 1568, 2093], 'sine', 0.3, 0.18), 400);

                    // „Éô„É´ÈÄ£Êâì
                    setTimeout(() => AudioEngine.play([2093], 'sine', 0.28, 0.08), 700);
                    setTimeout(() => AudioEngine.play([2349], 'sine', 0.3, 0.08), 850);
                    setTimeout(() => AudioEngine.play([2637], 'sine', 0.32, 0.08), 1000);
                    setTimeout(() => AudioEngine.play([2093, 2349, 2637], 'sine', 0.35, 0.12), 1150);
                }, 800);

                setTimeout(() => {
                    setParticles([]);
                    setExplosions([]);
                    setLightBeams([]);
                    onComplete();
                }, 4500);
            }, [onComplete]);

            return (
                <>
                    {/* „Éì„É´„Éâ„Ç¢„ÉÉ„Éó„Éï„Çß„Éº„Ç∫: ÁîªÈù¢„Ç™„É¨„É≥„Ç∏ + ÊåØÂãï */}
                    {phase === 'buildup' && (
                        <>
                            <div className="fixed inset-0 pointer-events-none z-[275]"
                                style={{
                                    background: 'radial-gradient(circle, rgba(255,140,0,0.3) 0%, rgba(255,100,0,0.2) 50%, transparent 100%)',
                                    animation: 'buildup-pulse 0.1s ease-in-out infinite',
                                }}
                            />
                            <div className="fixed top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-[290]"
                                style={{ animation: 'buildup-shake 0.1s ease-in-out infinite' }}>
                                <div className="text-6xl font-black text-orange-400 opacity-80">BIG...?</div>
                            </div>
                        </>
                    )}
                    {/* ÁàÜÁô∫„Éï„Çß„Éº„Ç∫: „É¨„Ç§„É≥„Éú„Éº„Éï„É©„ÉÉ„Ç∑„É• */}
                    {phase === 'explode' && (
                        <div
                            className="fixed inset-0 pointer-events-none z-[280]"
                            style={{
                                background: 'radial-gradient(circle, rgba(255,0,128,0.5) 0%, rgba(255,215,0,0.4) 30%, rgba(0,206,209,0.3) 60%, transparent 100%)',
                                animation: 'big-rainbow-flash 1.5s ease-out forwards',
                            }}
                        />
                    )}
                    {/* ÂÖâÁ∑ö */}
                    {lightBeams.map(b => (
                        <div
                            key={b.id}
                            style={{
                                position: 'fixed',
                                left: '50%',
                                top: '50%',
                                width: '1000px',
                                height: '8px',
                                marginLeft: '-500px',
                                marginTop: '-4px',
                                background: 'linear-gradient(90deg, transparent 0%, rgba(255,215,0,0.8) 50%, transparent 100%)',
                                transform: `rotate(${b.angle}deg)`,
                                transformOrigin: 'center',
                                pointerEvents: 'none',
                                zIndex: 285,
                                animation: 'beam-pulse 2s ease-in-out infinite',
                            }}
                        />
                    ))}
                    {/* ÈÄ£Á∂öÁàÜÁô∫ */}
                    {explosions.map(exp => (
                        <div
                            key={exp.id}
                            style={{
                                position: 'fixed',
                                left: exp.x,
                                top: exp.y,
                                width: '100px',
                                height: '100px',
                                marginLeft: '-50px',
                                marginTop: '-50px',
                                borderRadius: '50%',
                                background: 'radial-gradient(circle, rgba(255,215,0,0.9) 0%, rgba(255,0,128,0.6) 50%, transparent 100%)',
                                pointerEvents: 'none',
                                zIndex: 288,
                                animation: `explosion ${0.8}s ease-out ${exp.delay}s forwards`,
                            }}
                        />
                    ))}
                    {/* „É¨„Ç§„É≥„Éú„Éº„ÇØ„É©„ÉÉ„Ç´„Éº„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */}
                    {particles.map(p => (
                        <CrackerConfettiParticle key={p.id} {...p} />
                    ))}
                    {/* BIG!! „ÉÜ„Ç≠„Çπ„Éà */}
                    <div
                        className="fixed top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-[295]"
                        style={{ animation: 'big-text 2.5s ease-out forwards' }}
                    >
                        <div className="text-9xl font-black" style={{
                            background: 'linear-gradient(45deg, #FF0080, #FF8C00, #FFD700, #00FF00, #00CED1, #4169E1)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            textShadow: '0 0 40px rgba(255,215,0,0.8)',
                        }}>
                            BIG!!!
                        </div>
                    </div>
                </>
            );
        };

        // „Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÊºîÂá∫Ôºà5%Ôºâ: Á©∂Ê•µ„ÅÆÈªÑÈáëÁàÜÁô∫ - ÂÆåÂÖ®‰æùÂ≠ò„É¨„Éô„É´
        const RewardJackpot = ({ onComplete }) => {
            const [particles, setParticles] = useState([]);
            const [starBursts, setStarBursts] = useState([]);
            const [spirals, setSpirals] = useState([]);
            const [waves, setWaves] = useState([]);

            useEffect(() => {
                // ÁîªÈù¢ÊåØÂãïÔºàÂº∑ÁÉàÔºâ
                if (navigator.vibrate) {
                    navigator.vibrate([150, 50, 150, 50, 200, 50, 300]);
                }

                // ÊòüÂûã„Éê„Éº„Çπ„Éà
                const newStarBursts = [];
                for (let i = 0; i < 12; i++) {
                    const angle = (Math.PI * 2 * i) / 12;
                    newStarBursts.push({
                        id: i,
                        angle,
                        delay: i * 0.05,
                    });
                }
                setStarBursts(newStarBursts);

                // Ëû∫Êóã„Ç®„Éï„Çß„ÇØ„Éà
                setSpirals([
                    { id: 1, direction: 1, delay: 0 },
                    { id: 2, direction: -1, delay: 0.2 },
                    { id: 3, direction: 1, delay: 0.4 },
                ]);

                // Ê≥¢Âãï„Ç®„Éï„Çß„ÇØ„Éà
                setWaves([
                    { id: 1, delay: 0 },
                    { id: 2, delay: 0.3 },
                    { id: 3, delay: 0.6 },
                    { id: 4, delay: 0.9 },
                ]);

                // ÈáëËâ≤„ÇØ„É©„ÉÉ„Ç´„ÉºË∂ÖÂ§ßÈáèÔºà500ÂÄãÔºâ
                const goldShades = ['#FFD700', '#FFA500', '#FFDB58', '#FFE55C', '#FFF8DC'];
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const newParticles = [];
                for (let i = 0; i < 500; i++) {
                    const fromLeft = i % 2 === 0;
                    const startX = fromLeft ? '5%' : '95%';
                    const startY = '5%';

                    // ‰∏≠Â§Æ‰ªòËøë„Å∏„ÅÆÁùÄÂú∞ÁÇπÔºàË∂ÖÂ∫ÉÁØÑÂõ≤Ôºâ
                    const spreadX = (Math.random() - 0.5) * 900;
                    const spreadY = (Math.random() - 0.5) * 900;
                    const targetX = `${centerX + spreadX}px`;
                    const targetY = `${centerY + spreadY}px`;

                    newParticles.push({
                        id: i,
                        startX,
                        startY,
                        targetX,
                        targetY,
                        color: goldShades[i % goldShades.length],
                        delay: Math.random() * 0.6,
                        duration: 1.2 + Math.random() * 0.8,
                        size: 12 + Math.random() * 16,
                    });
                }
                setParticles(newParticles);

                // üé∞ JACKPOTÁ©∂Ê•µSE: „Çµ„Ç§„É¨„É≥ ‚Üí ÁàÜÁô∫ ‚Üí „Éï„Ç°„É≥„Éï„Ç°„Éº„É¨ ‚Üí „Éô„É´ÁãÇ‰π± ‚Üí 5ÁßíÈñìÈ≥¥„ÇäÁ∂ö„Åë„Çã
                // „Çµ„Ç§„É¨„É≥Èü≥Ôºà‰∏äÊòá‰∏ãÈôç„ÇíÁπ∞„ÇäËøî„ÅôÔºâ
                AudioEngine.play([400, 800], 'sawtooth', 0.3, 0.15);
                setTimeout(() => AudioEngine.play([800, 400], 'sawtooth', 0.3, 0.15), 150);
                setTimeout(() => AudioEngine.play([400, 900], 'sawtooth', 0.32, 0.15), 300);
                setTimeout(() => AudioEngine.play([900, 400], 'sawtooth', 0.32, 0.15), 450);

                // ÁàÜÁô∫Èü≥Ôºà„Éâ„Ç´„Éº„É≥ÔºÅÔºâ
                setTimeout(() => AudioEngine.play([100, 80, 60, 40], 'sawtooth', 0.4, 0.2), 600);

                // Á©∂Ê•µ„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨Ôºà3ÈÄ£Á∂ö‰∏äÊòáÈü≥ÈöéÔºâ
                setTimeout(() => AudioEngine.play([659, 784, 1047, 1319, 1568, 2093], 'sine', 0.38, 0.22), 850);
                setTimeout(() => AudioEngine.play([784, 1047, 1319, 1568, 2093, 2637], 'triangle', 0.36, 0.2), 1050);
                setTimeout(() => AudioEngine.play([1047, 1319, 1568, 2093, 2637, 3136], 'sine', 0.34, 0.18), 1250);

                // „Éô„É´ÁãÇ‰π±ÈÄ£ÊâìÔºà10Âõû‰ª•‰∏ä„ÅÆ„Éô„É´Èü≥Ôºâ
                setTimeout(() => AudioEngine.play([2093], 'sine', 0.35, 0.08), 1500);
                setTimeout(() => AudioEngine.play([2349], 'sine', 0.36, 0.08), 1620);
                setTimeout(() => AudioEngine.play([2637], 'sine', 0.37, 0.08), 1740);
                setTimeout(() => AudioEngine.play([2093, 2349], 'sine', 0.38, 0.09), 1860);
                setTimeout(() => AudioEngine.play([2349, 2637], 'sine', 0.38, 0.09), 1980);
                setTimeout(() => AudioEngine.play([2637, 3136], 'sine', 0.38, 0.09), 2100);
                setTimeout(() => AudioEngine.play([2093, 2349, 2637], 'sine', 0.39, 0.1), 2220);
                setTimeout(() => AudioEngine.play([2349, 2637, 3136], 'sine', 0.39, 0.1), 2340);
                setTimeout(() => AudioEngine.play([2093, 2637], 'sine', 0.4, 0.1), 2460);
                setTimeout(() => AudioEngine.play([2349, 3136], 'sine', 0.4, 0.1), 2580);
                setTimeout(() => AudioEngine.play([2093, 2349, 2637, 3136], 'sine', 0.42, 0.15), 2700);

                // ÊúÄÂæå„ÅÆÂ§ßÁàÜÁô∫Èü≥ÔºàË∂ÖÂº∑Ë™øÔºâ
                setTimeout(() => AudioEngine.play([3136, 2637, 2093, 1568, 1319, 1047], 'sine', 0.45, 0.3), 2900);

                setTimeout(() => {
                    setParticles([]);
                    setStarBursts([]);
                    setSpirals([]);
                    setWaves([]);
                    onComplete();
                }, 5000);
            }, [onComplete]);

            return (
                <>
                    {/* ÈªÑÈáë„Éï„É©„ÉÉ„Ç∑„É•ÔºàÂº∑ÁÉàÔºâ */}
                    <div
                        className="fixed inset-0 pointer-events-none z-[280]"
                        style={{
                            background: 'radial-gradient(circle, rgba(255,215,0,0.9) 0%, rgba(255,165,0,0.7) 30%, rgba(255,215,0,0.5) 60%, transparent 100%)',
                            animation: 'jackpot-mega-flash 2s ease-out forwards',
                        }}
                    />
                    {/* ÁîªÈù¢ÊåØÂãï„Ç®„Éï„Çß„ÇØ„ÉàÔºàÂº∑ÂåñÔºâ */}
                    <div
                        className="fixed inset-0 pointer-events-none z-[282]"
                        style={{ animation: 'screen-shake-intense 1s ease-out forwards' }}
                    />
                    {/* Ê≥¢Âãï„É™„É≥„Ç∞ */}
                    {waves.map(w => (
                        <div
                            key={w.id}
                            style={{
                                position: 'fixed',
                                left: '50%',
                                top: '50%',
                                width: '50px',
                                height: '50px',
                                marginLeft: '-25px',
                                marginTop: '-25px',
                                border: '6px solid rgba(255, 215, 0, 0.9)',
                                borderRadius: '50%',
                                pointerEvents: 'none',
                                zIndex: 285,
                                animation: `mega-wave-expand 2s ease-out ${w.delay}s forwards`,
                            }}
                        />
                    ))}
                    {/* Ëû∫Êóã */}
                    {spirals.map(sp => (
                        <div
                            key={sp.id}
                            style={{
                                position: 'fixed',
                                left: '50%',
                                top: '50%',
                                width: '2000px',
                                height: '2000px',
                                marginLeft: '-1000px',
                                marginTop: '-1000px',
                                background: 'conic-gradient(from 0deg, transparent 0%, rgba(255,215,0,0.3) 10%, transparent 20%, rgba(255,215,0,0.3) 30%, transparent 40%)',
                                borderRadius: '50%',
                                pointerEvents: 'none',
                                zIndex: 283,
                                animation: `spiral-rotate-${sp.direction > 0 ? 'cw' : 'ccw'} 3s linear ${sp.delay}s infinite`,
                            }}
                        />
                    ))}
                    {/* ÊòüÂûã„Éê„Éº„Çπ„Éà */}
                    {starBursts.map(sb => (
                        <div
                            key={sb.id}
                            style={{
                                position: 'fixed',
                                left: '50%',
                                top: '50%',
                                width: '2000px',
                                height: '20px',
                                marginLeft: '-1000px',
                                marginTop: '-10px',
                                background: 'linear-gradient(90deg, transparent 0%, rgba(255,215,0,0.9) 50%, transparent 100%)',
                                transform: `rotate(${sb.angle}rad)`,
                                transformOrigin: 'center',
                                pointerEvents: 'none',
                                zIndex: 288,
                                animation: `starburst-pulse 2s ease-out ${sb.delay}s forwards`,
                            }}
                        />
                    ))}
                    {/* ÈªÑÈáë„ÇØ„É©„ÉÉ„Ç´„Éº„Éë„Éº„ÉÜ„Ç£„ÇØ„É´Ë∂ÖÂ§ßÈáè */}
                    {particles.map(p => (
                        <CrackerConfettiParticle key={p.id} {...p} />
                    ))}
                    {/* JACKPOT!!! „ÉÜ„Ç≠„Çπ„ÉàÔºàÂ∑®Â§ßÔºÜËÑàÂãïÔºâ */}
                    <div
                        className="fixed top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-[295]"
                        style={{ animation: 'jackpot-mega-text 3s ease-out forwards' }}
                    >
                        <div className="text-[12rem] font-black" style={{
                            background: 'linear-gradient(45deg, #FFD700, #FFA500, #FFD700, #FFF8DC, #FFD700)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            textShadow: '0 0 60px rgba(255,215,0,1), 0 0 120px rgba(255,215,0,0.8), 0 0 180px rgba(255,165,0,0.6)',
                            filter: 'drop-shadow(0 0 40px rgba(255,215,0,1))',
                        }}>
                            JACKPOT!!!
                        </div>
                    </div>
                    {/* „Çµ„Éñ„ÉÜ„Ç≠„Çπ„Éà */}
                    <div
                        className="fixed top-1/2 left-1/2 transform -translate-x-1/2 translate-y-12 pointer-events-none z-[295]"
                        style={{ animation: 'jackpot-subtext 3s ease-out 0.5s forwards', opacity: 0 }}
                    >
                        <div className="text-4xl font-black text-yellow-300" style={{ textShadow: '0 0 20px rgba(255,215,0,1)' }}>
                            üî• FEVER MODE ACTIVATED üî•
                        </div>
                    </div>
                </>
            );
        };

        // --- „ÇØ„É©„ÉÉ„Ç´„ÉºÈ¢®Ëä±ÂêπÈõ™„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç∑„Çπ„ÉÜ„É†ÔºàÂÆùÁÆ±Áî®Ôºâ---
        const CrackerConfettiParticle = ({ startX, startY, targetX, targetY, color, delay, duration, size }) => {
            const randomRotation = Math.random() * 1080 - 540;

            return (
                <div
                    style={{
                        position: 'fixed',
                        left: startX,
                        bottom: startY,
                        width: `${size}px`,
                        height: `${size}px`,
                        backgroundColor: color,
                        opacity: 0.95,
                        borderRadius: '50%',
                        pointerEvents: 'none',
                        zIndex: 250,
                        animation: `cracker-shoot ${duration}s cubic-bezier(0.25, 0.46, 0.45, 0.94) ${delay}s forwards`,
                        transform: 'scale(1)',
                        boxShadow: color === '#FFD700' ? '0 0 15px rgba(255, 215, 0, 1)' : '0 0 15px rgba(192, 192, 192, 1)',
                        '--target-x': targetX,
                        '--target-y': targetY,
                        '--rotation': `${randomRotation}deg`,
                    }}
                />
            );
        };

        const ConfettiSystem = ({ rarity }) => {
            const [particles, setParticles] = useState([]);

            useEffect(() => {
                // „É¨„Ç¢„É™„ÉÜ„Ç£„Å´Âøú„Åò„Å¶„Éë„Éº„ÉÜ„Ç£„ÇØ„É´Êï∞„ÇíÊ±∫ÂÆö
                let count = 0;
                // let goldRatio = 0; // ‰Ωø„Çè„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅÁúÅÁï•ÂèØ

                if (rarity === 'common') {
                    count = 30;
                } else if (rarity === 'rare') {
                    count = 60;
                } else if (rarity === 'epic') {
                    count = 100;
                } else if (rarity === 'legendary') {
                    count = 200;
                } else if (rarity === 'mythic') {
                    count = 500;
                }

                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const newParticles = [];
                const colors = ['#FFD700', '#FFA500', '#FF6B9D', '#4ECDC4', '#A8E6CF'];

                for (let i = 0; i < count; i++) {
                    const fromLeft = i % 2 === 0;
                    const startX = fromLeft ? '5%' : '95%';
                    const startY = '5%';

                    const spreadX = (Math.random() - 0.5) * 600;
                    const spreadY = (Math.random() - 0.5) * 600;

                    newParticles.push({
                        id: i,
                        startX,
                        startY,
                        targetX: `${centerX + spreadX}px`,
                        targetY: `${centerY + spreadY}px`,
                        color: colors[i % colors.length],
                        delay: Math.random() * 0.5,
                        duration: 1 + Math.random() * 0.5,
                        size: 8 + Math.random() * 8,
                    });
                }
                setParticles(newParticles);

                // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                return () => setParticles([]);
            }, [rarity]);

            return (
                <>
                    {particles.map(p => (
                        <CrackerConfettiParticle key={p.id} {...p} />
                    ))}
                </>
            );
        };
        // --- ÂÆùÁÆ±„É¢„Éº„ÉÄ„É´ÔºàÂü∫Â∫ïÁä∂ÊÖãÔºöÈùôÂØÇ„Å®‰∫àÊÑü / ‰∏âÊÆµÈöé„ÅÆÂ§âÂπªÂÑÄÂºèÔºâ ---
        const ChestModal = ({ onClose, onReward, isWakeupChest = false }) => {
            const [state, setState] = useState('void');
            const [currentTier, setCurrentTier] = useState('void'); // void, bronze, gold, rainbow
            const [reward, setReward] = useState(null);
            const [mashProgress, setMashProgress] = useState(0);
            const [auraIntensity, setAuraIntensity] = useState(0);
            const [showGlitch, setShowGlitch] = useState(false);
            const [skipToGold, setSkipToGold] = useState(false);
            const [skipToRainbow, setSkipToRainbow] = useState(false);
            const mashTimerRef = useRef(null);
            const mashStartTimeRef = useRef(0);
            // ËøΩÂä†: 3ÊäûÂÆùÁÆ±„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
            const [selectionState, setSelectionState] = useState(isWakeupChest ? 'choosing' : 'selected');

            // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•ÂäõÔºàSpace„Ç≠„ÉºÔºâÂØæÂøú
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        handleInteraction();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                };
            }, [state, mashProgress]);

            // „Çø„Ç§„Éû„Éº„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            useEffect(() => {
                return () => {
                    if (mashTimerRef.current) {
                        clearInterval(mashTimerRef.current);
                    }
                };
            }, []);

            const handleInteraction = () => {
                if (state === 'freeze' || state === 'opened' || state === 'gemAnimation' || state === 'burnOverlay') return;

                // Step 1: void ‚Üí bronze/gold/rainbow
                if (state === 'void') {
                    const roll = Math.random() * 100;

                    if (roll < 2) {
                        // 2%: Ëôπ„Å∏Áõ¥Ë°åÔºàÂç≥„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÔºâ
                        setSkipToRainbow(true);
                        setCurrentTier('rainbow');
                        setState('step1');
                        setShowGlitch(true);
                        // „Ç∞„É™„ÉÉ„ÉÅÈü≥ + ËôπËâ≤Á¢∫ÂÆöÈü≥
                        AudioEngine.play([100, 1000, 200, 1500, 300, 2000], 'sawtooth', 0.5, 0.1);
                        AudioEngine.play([523, 659, 784, 1047], 'sine', 0.4, 0.2);

                        setTimeout(() => {
                            setShowGlitch(false);
                            proceedToFreeze();
                        }, 1000);
                    } else if (roll < 20) {
                        // 18%: Èáë„Å∏È£õ„Å≥Á¥öÔºàStep 2„Çπ„Ç≠„ÉÉ„ÉóÔºâ
                        setSkipToGold(true);
                        setCurrentTier('gold');
                        setState('step1');
                        // ÈáëÊòáÊ†ºÈü≥
                        AudioEngine.play([400, 500, 600, 700, 800], 'sine', 0.3, 0.15);

                        setTimeout(() => {
                            proceedToStep3();
                        }, 800);
                    } else {
                        // 80%: ÈäÖËâ≤ÔºàÈÄöÂ∏∏ÈÄ≤Ë°åÔºâ
                        setCurrentTier('bronze');
                        setState('step1');
                        // „Ç™„Éº„É©Âº∑Â∫¶„Çí„É©„É≥„ÉÄ„É†„Å´Ë®≠ÂÆöÔºàÂæå„ÅÆÊòáÊ†ºÁéá„Å´ÂΩ±ÈüøÔºâ
                        const intensity = Math.random();
                        setAuraIntensity(intensity);
                        // ‰∏çÂçîÂíåÈü≥Ôºà‰ΩéÂüüÔºâ
                        AudioEngine.play([80, 90, 100, 85, 95], 'sawtooth', 0.25, 0.2);

                        setTimeout(() => {
                            proceedToStep2();
                        }, 800);
                    }
                    return;
                }

                // ÈÄ£Êâì„É¢„Éº„Éâ‰∏≠„ÅÆÂá¶ÁêÜ
                if (state === 'mashMode') {
                    const now = Date.now();
                    const elapsed = now - mashStartTimeRef.current;

                    if (elapsed < 5000) {
                        const progress = Math.min(1, mashProgress + 0.1);
                        setMashProgress(progress);
                        // „Éè„Éº„Éà„Éì„Éº„ÉàÈü≥
                        AudioEngine.play([100 + progress * 300, 120 + progress * 360], 'square', 0.15 + progress * 0.2, 0.05);
                    }

                    if (elapsed >= 5000 || mashProgress >= 1) {
                        clearInterval(mashTimerRef.current);
                        // ÈÄ£ÊâìÂÆå‰∫Ü ‚Üí Èáë„Å∏ÊòáÊ†º
                        setCurrentTier('gold');
                        setState('step2_complete');
                        AudioEngine.play([400, 500, 600, 700, 800], 'sine', 0.3, 0.15);

                        setTimeout(() => {
                            proceedToStep3();
                        }, 800);
                    }
                    return;
                }

                // Step 2‰ª•Èôç„ÅØËá™ÂãïÈÄ≤Ë°å„Å™„ÅÆ„Åß„ÇØ„É™„ÉÉ„ÇØ‰∏çË¶Å
            };

            const proceedToStep2 = () => {
                // Step 2: ÊòáÊ†º„ÅÆË©¶Á∑¥Ôºà40%„ÅßÈáë„Å∏„ÄÅ15%„ÅßÈÄ£Êâì„É¢„Éº„ÉâÔºâ
                const roll = Math.random();
                const upgradeChance = 0.4 + (auraIntensity * 0.2); // „Ç™„Éº„É©„ÅåÂº∑„ÅÑ„Å®ÊòáÊ†ºÁéáUP

                if (roll < 0.15) {
                    // 15%: ÈÄ£Êâì„É¢„Éº„ÉâÁô∫Áîü
                    setState('mashMode');
                    setMashProgress(0);
                    mashStartTimeRef.current = Date.now();
                    // ÈÄ£ÊâìÈñãÂßãÈü≥
                    AudioEngine.play([200, 250, 300], 'square', 0.2, 0.1);

                    // 5Áßí„Çø„Ç§„Éû„Éº
                    mashTimerRef.current = setInterval(() => {
                        const elapsed = Date.now() - mashStartTimeRef.current;
                        if (elapsed >= 5000) {
                            clearInterval(mashTimerRef.current);
                            // „Çø„Ç§„É†„Ç¢„ÉÉ„Éó ‚Üí Èáë„Å∏ÊòáÊ†º
                            setCurrentTier('gold');
                            setState('step2_complete');
                            AudioEngine.play([400, 500, 600, 700, 800], 'sine', 0.3, 0.15);

                            setTimeout(() => {
                                proceedToStep3();
                            }, 800);
                        }
                    }, 100);
                } else if (roll < upgradeChance) {
                    // 40%Ôºà+„Ç™„Éº„É©„Éú„Éº„Éä„ÇπÔºâ: Èáë„Å∏ÊòáÊ†º
                    setState('step2');
                    setTimeout(() => {
                        setCurrentTier('gold');
                        // Èè°Èù¢„Ç¥„Éº„É´„Éâ„Å∏Â§âÂåñ + „Éï„É©„ÉÉ„Ç∑„É•
                        AudioEngine.play([400, 500, 600, 700, 800], 'sine', 0.3, 0.15);

                        setTimeout(() => {
                            proceedToStep3();
                        }, 800);
                    }, 500);
                } else {
                    // ÈäÖ„ÅÆ„Åæ„Åæ ‚Üí Step 3„Å∏
                    setState('step2');
                    AudioEngine.play([200, 180, 160], 'square', 0.15, 0.1);

                    setTimeout(() => {
                        proceedToStep3();
                    }, 800);
                }
            };

            const proceedToStep3 = () => {
                // Step 3: ÊúÄÁµÇÂØ©Âà§Ôºà10%„ÅßËôπ„Å∏Ôºâ
                setState('step3');

                setTimeout(() => {
                    if (currentTier === 'gold') {
                        const roll = Math.random();
                        if (roll < 0.1) {
                            // 10%: ËôπËâ≤„Å∏ÊòáÊ†ºÔºÅ
                            setCurrentTier('rainbow');
                            setShowGlitch(true);
                            // „Ç∞„É™„ÉÉ„ÉÅÈü≥ + ËôπËâ≤Á¢∫ÂÆöÈü≥
                            AudioEngine.play([100, 1000, 200, 1500, 300, 2000], 'sawtooth', 0.5, 0.1);
                            AudioEngine.play([523, 659, 784, 1047], 'sine', 0.4, 0.2);

                            setTimeout(() => {
                                setShowGlitch(false);
                                proceedToFreeze();
                            }, 800);
                        } else {
                            // 90%: Èáë„ÅÆ„Åæ„Åæ
                            proceedToFreeze();
                        }
                    } else {
                        // ÈäÖ„ÅÆ„Åæ„Åæ
                        proceedToFreeze();
                    }
                }, 500);
            };

            const proceedToFreeze = () => {
                // 0.7Áßí„ÅÆÂÆåÂÖ®ÂÅúÊ≠¢ÔºàThe FreezeÔºâ
                setState('freeze');

                // ÂøÉÈü≥SE
                const heartbeatInterval = setInterval(() => {
                    AudioEngine.play([60, 80], 'sine', 0.15, 0.08);
                }, 400);

                setTimeout(() => {
                    clearInterval(heartbeatInterval);
                    openChest();
                }, 700);
            };

            const openChest = () => {
                // „É¨„Ç¢„É™„ÉÜ„Ç£„Å´Âøú„Åò„ÅüÂ†±ÈÖ¨ÁîüÊàê
                let result = {};
                const roll = Math.random() * 100;

                if (currentTier === 'rainbow') {
                    // MythicÁ¢∫ÂÆö
                    result = {
                        type: 'gems',
                        amount: 777,
                        text: 'üíé 777 JACKPOT!!!',
                        icon: Icons.Gem,
                        rarity: 'mythic',
                        rarityText: 'MYTHIC'
                    };
                } else if (currentTier === 'gold') {
                    // Epic~Legendary
                    if (roll < 50) {
                        result = {
                            type: 'gems',
                            amount: 120,
                            text: 'üíé 120 Gems!!',
                            icon: Icons.Gem,
                            rarity: 'epic',
                            rarityText: 'EPIC'
                        };
                    } else {
                        result = {
                            type: 'gems',
                            amount: 300,
                            text: 'üíé 300 Gems!!!',
                            icon: Icons.Gem,
                            rarity: 'legendary',
                            rarityText: 'LEGENDARY'
                        };
                    }
                } else {
                    // Bronze: Common~Rare
                    if (roll < 60) {
                        result = {
                            type: 'gems',
                            amount: 15,
                            text: 'üíé 15 Gems',
                            icon: Icons.Gem,
                            rarity: 'common',
                            rarityText: 'COMMON'
                        };
                    } else {
                        result = {
                            type: 'gems',
                            amount: 50,
                            text: 'üíé 50 Gems!',
                            icon: Icons.Gem,
                            rarity: 'rare',
                            rarityText: 'RARE'
                        };
                    }
                }

                setReward(result);
                setState('opened');

                // „É¨„Ç¢„É™„ÉÜ„Ç£„Å´Âøú„Åò„ÅüÂäπÊûúÈü≥
                if (result.rarity === 'mythic') {
                    AudioEngine.play([600, 800, 1000, 1200, 1500], 'sine', 0.4, 0.2);
                } else if (result.rarity === 'legendary') {
                    AudioEngine.play([500, 700, 900, 1100], 'sine', 0.3, 0.15);
                } else {
                    AudioEngine.play([400, 600, 800], 'sine', 0.2, 0.12);
                }

                onReward(result, isWakeupChest);
            };

            const handleClose = () => {
                if (isWakeupChest && reward?.type === 'gems') {
                    // „Ç∏„Çß„É†„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ ‚Üí ÁáÉÁÑºÈñãÂßã„Ç™„Éº„Éê„Éº„É¨„Ç§ ‚Üí Section 1„Çπ„ÇØ„É≠„Éº„É´
                    setState('gemAnimation');

                    setTimeout(() => {
                        setState('burnOverlay');

                        setTimeout(() => {
                            // Section 1„Å∏„Çπ„ÇØ„É≠„Éº„É´
                            const section1 = document.querySelector('[data-section="1"]');
                            if (section1) {
                                section1.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                            onClose();
                        }, 1000);
                    }, 1500);
                } else {
                    onClose();
                }
            };

            const getRarityColor = (rarity) => {
                if (rarity === 'common') return 'text-gray-300';
                if (rarity === 'rare') return 'text-blue-400';
                if (rarity === 'epic') return 'text-purple-400';
                if (rarity === 'legendary') return 'text-yellow-400';
                if (rarity === 'mythic') return 'text-red-500';
                return 'text-white';
            };

            const getAuraColor = () => {
                if (currentTier === 'rainbow') return 'rgba(255, 0, 255, 0.9)';
                if (currentTier === 'gold') return 'rgba(255, 215, 0, 0.7)';
                if (currentTier === 'bronze') return `rgba(139, 69, 19, ${0.3 + auraIntensity * 0.4})`;
                return 'rgba(0, 0, 0, 0.5)'; // void
            };

            const getTierClassName = () => {
                if (currentTier === 'rainbow') return 'tier-rainbow';
                if (currentTier === 'gold') return 'tier-gold';
                if (currentTier === 'bronze') return 'tier-bronze';
                return 'tier-void';
            };

            // ÂÆùÁÆ±„Éì„Ç∏„É•„Ç¢„É´
            const ChestVisual = () => {
                const isShaking = state === 'mashMode' || state === 'step3';
                const shakeIntensity = currentTier === 'rainbow' ? 5 : currentTier === 'gold' ? 3 : 1;
                const auraColor = getAuraColor();
                const tierClass = getTierClassName();

                return (
                    <div
                        className="relative w-48 h-48 flex items-center justify-center"
                        style={{
                            transform: isShaking ? `translate(${Math.random() * 10 * shakeIntensity - 5 * shakeIntensity}px, ${Math.random() * 10 * shakeIntensity - 5 * shakeIntensity}px)` : 'none',
                            transition: 'transform 0.05s',
                            willChange: 'transform'
                        }}
                    >
                        {/* Èªí„ÅÑÈúß„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÔºàvoidÁä∂ÊÖãÔºâ */}
                        {state === 'void' && (
                            <div className="absolute inset-0 pointer-events-none">
                                {Array.from({ length: 15 }, (_, i) => (
                                    <div
                                        key={i}
                                        className="absolute w-2 h-2 rounded-full bg-black/30"
                                        style={{
                                            top: `${Math.random() * 100}%`,
                                            left: `${Math.random() * 100}%`,
                                            animation: `float-particle ${3 + Math.random() * 2}s ease-in-out infinite`,
                                            animationDelay: `${Math.random() * 2}s`
                                        }}
                                    />
                                ))}
                            </div>
                        )}

                        {/* „Ç™„Éº„É©„Ç®„Éï„Çß„ÇØ„Éà */}
                        {state !== 'void' && (
                            <div
                                className="absolute inset-0 rounded-full blur-3xl animate-pulse"
                                style={{
                                    backgroundColor: auraColor,
                                    opacity: 0.8,
                                    willChange: 'opacity',
                                    animation: currentTier === 'bronze' && auraIntensity > 0.7 ? 'aura-intense 1s ease-in-out infinite' : 'pulse 2s ease-in-out infinite'
                                }}
                            />
                        )}

                        {/* „Ç∞„É™„ÉÉ„ÉÅ„Ç®„Éï„Çß„ÇØ„Éà */}
                        {showGlitch && (
                            <div
                                className="absolute inset-0"
                                style={{
                                    animation: 'glitch 0.6s steps(10)',
                                    background: 'repeating-linear-gradient(0deg, red 0px, green 2px, blue 4px)',
                                    mixBlendMode: 'difference',
                                    willChange: 'transform, opacity'
                                }}
                            />
                        )}

                        {/* ÂÆùÁÆ±Êú¨‰Ωì */}
                        <div
                            className={`relative w-32 h-32 transition-all duration-500 ${tierClass}`}
                            style={{
                                filter: currentTier === 'rainbow'
                                    ? 'drop-shadow(0 0 20px rgba(255,0,255,1)) drop-shadow(0 0 40px rgba(255,0,255,0.8)) drop-shadow(0 0 60px rgba(255,0,255,0.6))'
                                    : currentTier === 'gold'
                                        ? 'drop-shadow(0 0 20px rgba(255,215,0,0.8)) drop-shadow(0 0 40px rgba(255,215,0,0.6))'
                                        : currentTier === 'bronze'
                                            ? 'drop-shadow(0 0 10px rgba(139,69,19,0.5))'
                                            : 'drop-shadow(0 0 8px rgba(90, 60, 30, 0.6)) opacity(0.9)',
                                transformStyle: 'preserve-3d',
                                willChange: 'filter',
                                animation: state === 'void' ? 'float-chest 3s ease-in-out infinite' : 'none'
                            }}
                        >
                            {/* Ëìã */}
                            <div
                                className="absolute top-0 left-0 w-full h-16 rounded-t-2xl overflow-hidden"
                                style={{
                                    background: currentTier === 'rainbow'
                                        ? 'linear-gradient(135deg, #ff0080 0%, #ff8c00 20%, #ffd700 40%, #00ff00 60%, #0080ff 80%, #8000ff 100%)'
                                        : currentTier === 'gold'
                                            ? 'linear-gradient(135deg, #ffd700 0%, #ffed4e 25%, #ffd700 50%, #ffb700 75%, #ffa500 100%)'
                                            : currentTier === 'bronze'
                                                ? 'linear-gradient(135deg, #cd7f32 0%, #b87333 25%, #cd7f32 50%, #8b4513 75%, #654321 100%)'
                                                : 'linear-gradient(135deg, #5c4033 0%, #8b6914 25%, #6b4423 50%, #4a3520 75%, #3d2814 100%)',
                                    boxShadow: currentTier === 'void'
                                        ? '0 4px 12px rgba(0,0,0,0.95), inset 0 2px 6px rgba(255,255,255,0.05)'
                                        : '0 4px 12px rgba(0,0,0,0.9), inset 0 2px 6px rgba(255,255,255,0.2)',
                                    border: currentTier === 'void' ? '3px solid #0a0a0a' : '3px solid #333',
                                    transformOrigin: 'bottom',
                                    transform: state === 'opened' ? 'rotateX(-120deg)' : 'rotateX(0deg)',
                                    transition: 'transform 0.6s ease-out, background 0.5s ease'
                                }}
                            >
                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-gradient-to-br from-gray-200 via-gray-300 to-gray-400">
                                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xs">
                                        {currentTier === 'void' ? '?' : 'üíé'}
                                    </div>
                                </div>
                            </div>

                            {/* Êú¨‰Ωì */}
                            <div
                                className="absolute bottom-0 left-0 w-full h-20 rounded-b-2xl"
                                style={{
                                    background: currentTier === 'rainbow'
                                        ? 'linear-gradient(135deg, #ff0080 0%, #ff8c00 20%, #ffd700 40%, #00ff00 60%, #0080ff 80%, #8000ff 100%)'
                                        : currentTier === 'gold'
                                            ? 'linear-gradient(135deg, #ffd700 0%, #ffed4e 25%, #ffd700 50%, #ffb700 75%, #ffa500 100%)'
                                            : currentTier === 'bronze'
                                                ? 'linear-gradient(135deg, #cd7f32 0%, #b87333 25%, #cd7f32 50%, #8b4513 75%, #654321 100%)'
                                                : 'linear-gradient(135deg, #4a3520 0%, #6b4423 25%, #5c4033 50%, #3d2814 75%, #2b1810 100%)',
                                    boxShadow: currentTier === 'void'
                                        ? '0 8px 20px rgba(0,0,0,0.98), inset 0 2px 6px rgba(255,255,255,0.03)'
                                        : '0 8px 20px rgba(0,0,0,0.95), inset 0 2px 6px rgba(255,255,255,0.15)',
                                    border: currentTier === 'void' ? '3px solid #0a0a0a' : '3px solid #2a2a2a',
                                    transition: 'background 0.5s ease'
                                }}
                            >
                                <div className="absolute top-1/2 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gray-400 to-transparent opacity-70" />
                            </div>

                            {/* ÈñãÂ∞ÅÊôÇ„ÅÆÂÖâ */}
                            {state === 'opened' && (
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-24 h-64 -translate-y-32 pointer-events-none">
                                    <div
                                        className="absolute inset-0 bg-gradient-to-t from-blue-200 via-white to-transparent opacity-90"
                                        style={{
                                            animation: 'chest-burst-open 0.6s ease-out forwards',
                                            filter: 'blur(8px)'
                                        }}
                                    />
                                </div>
                            )}
                        </div>

                        {/* Â†±ÈÖ¨„Ç¢„Ç§„Ç≥„É≥ */}
                        {state === 'opened' && reward && (
                            <div
                                className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none"
                                style={{
                                    animation: 'reward-emerge 0.8s ease-out forwards',
                                    opacity: 0
                                }}
                            >
                                <div className="text-7xl">
                                    {reward.icon && <reward.icon size={80} className="text-white drop-shadow-[0_0_20px_rgba(255,215,0,1)]" fill="currentColor" />}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // „Ç∏„Çß„É†Êï£‰π±‚ÜíÂê∏Âèé„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            const GemAbsorptionEffect = () => {
                const gemCount = 20;
                const gems = Array.from({ length: gemCount }, (_, i) => ({
                    id: i,
                    delay: i * 0.05,
                    x: (Math.random() - 0.5) * 400,
                    y: (Math.random() - 0.5) * 400
                }));

                return (
                    <div className="fixed inset-0 pointer-events-none z-[250]">
                        {gems.map(gem => (
                            <div
                                key={gem.id}
                                className="absolute top-1/2 left-1/2"
                                style={{
                                    animation: `gem-scatter-absorb 1.5s cubic-bezier(0.4, 0, 0.2, 1) ${gem.delay}s forwards`,
                                    '--scatter-x': `${gem.x}px`,
                                    '--scatter-y': `${gem.y}px`
                                }}
                            >
                                üíé
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div
                    className="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center backdrop-blur-sm"
                    style={{
                        animation: state === 'mashMode' || currentTier === 'rainbow' ? 'screen-shake 0.1s infinite' : 'none'
                    }}
                >
                    {/* ConfettiSystem */}
                    {state === 'opened' && reward && <ConfettiSystem rarity={reward.rarity} />}
                    {/* --- „Åì„Åì„Åã„ÇâËøΩÂä†Ôºö3ÊäûÂÆùÁÆ±„ÅÆÈÅ∏ÊäûÁîªÈù¢ --- */}
                    {isWakeupChest && selectionState === 'choosing' && (
                        <div className="absolute inset-0 bg-black/95 z-[310] flex flex-col items-center justify-center backdrop-blur-xl animate-scale-in">
                            <div className="text-center mb-10">
                                <h2 className="text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-amber-500 to-yellow-300 text-4xl font-black mb-4 tracking-tighter animate-pulse filter drop-shadow-[0_0_10px_rgba(255,215,0,0.5)]">
                                    CHOOSE YOUR DESTINY
                                </h2>
                                <p className="text-gray-400 font-bold text-sm tracking-widest">
                                    <span className="text-red-500 animate-pulse">MYTHIC</span> ÂèçÂøú„ÅÇ„Çä... Áõ¥ÊÑü„Çí‰ø°„Åò„Çç
                                </p>
                            </div>

                            <div className="flex gap-8 items-end justify-center perspective-[1000px]">
                                {[0, 1, 2].map(i => (
                                    <div
                                        key={i}
                                        onClick={() => {
                                            // Ê±∫ÂÆöÊôÇ„ÅÆÈáçÂéö„Å™SE
                                            AudioEngine.play([100, 200, 400], 'square', 0.3, 0.1);
                                            setSelectionState('selected');
                                        }}
                                        className="group relative w-32 h-32 flex flex-col items-center justify-end cursor-pointer transition-all duration-300 hover:scale-110 active:scale-95"
                                        style={{ animation: `float-chest ${3 + i * 0.5}s ease-in-out infinite` }}
                                    >
                                        {/* ÂÆùÁÆ±„ÅÆËÉåÂæå„ÅÆÊÄ™„Åó„ÅÑÂÖâ */}
                                        <div className="absolute bottom-4 left-1/2 -translate-x-1/2 w-20 h-20 bg-yellow-500/20 rounded-full blur-xl group-hover:bg-yellow-400/40 transition-all duration-500" />

                                        {/* ÂÆùÁÆ±„Ç¢„Ç§„Ç≥„É≥ */}
                                        <div className="relative z-10 text-gray-700 group-hover:text-yellow-400 transition-colors duration-300 filter drop-shadow-2xl">
                                            <Icons.Chest size={80} strokeWidth={1.5} />
                                        </div>

                                        {/* Âè∞Â∫ß„ÅÆ„Çà„ÅÜ„Å™Ë£ÖÈ£æ */}
                                        <div className="mt-2 w-24 h-2 bg-black/50 rounded-full blur-sm group-hover:w-20 transition-all duration-300" />

                                        {/* ÁñëÂïèÁ¨¶ */}
                                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white/20 text-4xl font-black opacity-0 group-hover:opacity-100 group-hover:-translate-y-full transition-all duration-300">
                                            ?
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-16 text-gray-600 text-xs font-black uppercase tracking-[0.2em] animate-pulse">
                                Select One Chest
                            </div>
                        </div>
                    )}

                    {/* „Ç∏„Çß„É†Âê∏Âèé„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */}
                    {state === 'gemAnimation' && <GemAbsorptionEffect />}

                    {/* ÁáÉÁÑºÈñãÂßã„Ç™„Éº„Éê„Éº„É¨„Ç§ */}
                    {state === 'burnOverlay' && (
                        <div
                            className="fixed inset-0 bg-gradient-to-br from-red-600 to-orange-500 z-[250] flex items-center justify-center"
                            style={{
                                animation: 'burn-overlay 1s ease-out forwards'
                            }}
                        >
                            <div className="text-9xl font-black text-white animate-pulse">
                                üî• ÁáÉÁÑºÈñãÂßã üî•
                            </div>
                        </div>
                    )}

                    <div className="flex flex-col items-center">
                        <div
                            className="relative mb-8 cursor-pointer"
                            onClick={handleInteraction}
                        >
                            <ChestVisual />
                        </div>

                        <div className="text-white text-center min-h-[120px]">
                            {state === 'void' && (
                                <div className="animate-pulse">
                                    <p className="text-3xl font-black mb-2 text-gray-400">
                                        {isWakeupChest ? '‚ú® „Åä„Åã„Åà„Çä ‚ú®' : 'üéâ „Çª„ÇØ„Ç∑„Éß„É≥ÂÆå‰∫Ü üéâ'}
                                    </p>
                                    <p className="text-xl font-bold text-gray-500">
                                        „ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØSpace„Ç≠„Éº„ÅßÈñãÂ∞Å
                                    </p>
                                    <p className="text-sm text-gray-600 mt-2">
                                        ÈùôÂØÇ„Å®‰∫àÊÑü...
                                    </p>
                                </div>
                            )}
                            {state === 'step1' && !skipToGold && !skipToRainbow && (
                                <div>
                                    <p className={`text-4xl font-black mb-2 ${auraIntensity > 0.7 ? 'text-amber-600 animate-pulse' : 'text-amber-700'}`}>
                                        üü´ BRONZE üü´
                                    </p>
                                    <p className="text-lg text-gray-300">
                                        {auraIntensity > 0.7 ? 'Âº∑„ÅÑ„Ç™„Éº„É©ÔºÅÊúüÂæÖÂ∫¶UP...' : 'Â§âÂπª„ÅÆÂÑÄÂºè„ÅåÂßã„Åæ„Çã...'}
                                    </p>
                                </div>
                            )}
                            {state === 'step1' && skipToGold && (
                                <div>
                                    <p className="text-5xl font-black mb-2 text-yellow-400 animate-pulse">
                                        üü® GOLD SKIP! üü®
                                    </p>
                                    <p className="text-lg text-yellow-300">
                                        Èáë„Å∏È£õ„Å≥Á¥öÔºÅ
                                    </p>
                                </div>
                            )}
                            {state === 'step1' && skipToRainbow && (
                                <div>
                                    <p className="text-6xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 to-purple-500 animate-pulse">
                                        üåà RAINBOW DIRECT! üåà
                                    </p>
                                    <p className="text-lg text-white">
                                        Ëôπ„Å∏Áõ¥Ë°åÔºÅÂç≥„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÔºÅ
                                    </p>
                                </div>
                            )}
                            {(state === 'step2' || state === 'step2_complete') && (
                                <div>
                                    <p className={`text-4xl font-black mb-2 ${currentTier === 'gold' ? 'text-yellow-400' : 'text-amber-700'}`}>
                                        {currentTier === 'gold' ? 'üü® GOLD UPGRADE! üü®' : 'üü´ BRONZE üü´'}
                                    </p>
                                    <p className="text-lg text-gray-300">
                                        {currentTier === 'gold' ? 'Èè°Èù¢„Ç¥„Éº„É´„Éâ„Å∏ÊòáÊ†ºÔºÅ' : 'ÊòáÊ†ºÂ§±Êïó...'}
                                    </p>
                                </div>
                            )}
                            {state === 'mashMode' && (
                                <div>
                                    <p className="text-4xl font-black text-cyan-400 mb-2 animate-pulse">
                                        ‚ö° ÈÄ£Êâì„Åõ„ÇàÔºÅ ‚ö°
                                    </p>
                                    <div className="w-64 h-4 bg-gray-700 rounded-full overflow-hidden mt-4">
                                        <div
                                            className="h-full bg-gradient-to-r from-cyan-400 to-blue-500 transition-all"
                                            style={{ width: `${mashProgress * 100}%` }}
                                        />
                                    </div>
                                    <p className="text-sm text-gray-400 mt-2">
                                        ÊÆã„Çä {Math.max(0, Math.ceil((5000 - (Date.now() - mashStartTimeRef.current)) / 1000))} Áßí
                                    </p>
                                </div>
                            )}
                            {state === 'step3' && (
                                <div>
                                    <p className="text-5xl font-black mb-2 text-white animate-pulse">
                                        ÊúÄÁµÇÂØ©Âà§...
                                    </p>
                                </div>
                            )}
                            {state === 'freeze' && (
                                <div className="animate-pulse">
                                    <p className="text-6xl font-black text-white">
                                        üíì
                                    </p>
                                </div>
                            )}
                            {state === 'opened' && reward && (
                                <div className="animate-in zoom-in duration-500">
                                    <p className={`text-base font-black uppercase tracking-widest mb-2 ${getRarityColor(reward.rarity)}`}>
                                        ‚ú¶ {reward.rarityText} ‚ú¶
                                    </p>
                                    <p className="text-5xl font-black mb-8">{reward.text}</p>
                                    <button
                                        onClick={handleClose}
                                        className="bg-gradient-to-b from-white to-gray-100 text-gray-800 px-10 py-4 rounded-2xl font-black text-xl border-4 border-white shadow-2xl active:scale-95 transition-all hover:scale-110"
                                    >
                                        üéÅ Âèó„ÅëÂèñ„Çã
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };


        const TaskItem = ({ task, onToggle, onUpdate, onDelete, onDragStart, isDragging, isMobile, onXpGain, isDeadlineView, activeTheme, onContextMenu, isFocusedSection = true, isLastInSection = false, setRewardEffect, stats, setStats, setToastMessage }) => {
            const [isCompleting, setIsCompleting] = useState(false);
            const [isStarting, setIsStarting] = useState(false);
            const [confettiType, setConfettiType] = useState(null);
            const [challengeTimeLeft, setChallengeTimeLeft] = useState(null);
            const [animateCheckbox, setAnimateCheckbox] = useState(false);
            const [isEditingTime, setIsEditingTime] = useState(false);
            const [editTimeValue, setEditTimeValue] = useState('9.5');
            const [currentForecast, setCurrentForecast] = useState(null); // ‰∫àÂëäÊû†Ëâ≤
            const [hoverPreview, setHoverPreview] = useState(null); // üéØ „Éõ„Éê„ÉºÊôÇ‰∫àÂëä„Ç¢„Ç§„Ç≥„É≥
            const buttonRef = useRef(null);

            useEffect(() => {
                if (!task.challengeEndTime || task.completed) { setChallengeTimeLeft(null); return; }
                const update = () => {
                    const diff = task.challengeEndTime - Date.now();
                    const sec = diff <= 0 ? 0 : Math.ceil(diff / 1000);
                    setChallengeTimeLeft(sec);
                };
                update();
                const timer = setInterval(update, 1000);
                return () => clearInterval(timer);
            }, [task.challengeEndTime, task.completed]);

            // üé∞ „ÇÆ„É£„É≥„Éñ„É´„Éá„Ç∂„Ç§„É≥ÊúÄÂ§ßÂåñ: handleToggle
            // ‰∫àÂëäÊºîÂá∫„ÄÅÈü≥Â§âÂåñ„ÄÅ„Éã„Ç¢„Éü„ÇπÂº∑Âåñ„ÄÅÈÄ£Ëçò„ÄÅÂ§©‰∫ïÂèØË¶ñÂåñ„ÄÅThe Freeze„ÇíÁµ±Âêà
            const handleToggle = async (e) => {
                e.stopPropagation();

                // Êó¢„Å´ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂçòÁ¥î„Å´„Éà„Ç∞„É´ÔºàÊú™ÂÆå‰∫Ü„Å´Êàª„ÅôÔºâ
                if (task.completed) return onToggle(task);
                if (isCompleting || isStarting) return;

                const rect = buttonRef.current ? buttonRef.current.getBoundingClientRect() : null;
                const centerX = rect ? rect.left + rect.width / 2 : window.innerWidth / 2;
                const centerY = rect ? rect.top + rect.height / 2 : window.innerHeight / 2;

                // --- ÂÖ±ÈÄöÊºîÂá∫„É≠„Ç∏„ÉÉ„ÇØÔºàÈñãÂßã„ÉªÂÆå‰∫Ü„Åß‰ΩøÁî®Ôºâ ---
                const runGamblingSequence = async (isStartPhase) => {
                    const isFeverMode = stats.feverEndTime > Date.now();
                    const isRensouMode = stats.rensouCount > 0;

                    // üé∞ 1. ‰∫àÂëäÊû†Ëâ≤„ÇíÂÖà„Å´Ê±∫ÂÆöÔºàÁµêÊûú„Å®„ÅØÁã¨Á´ãÔºâ
                    // ‰∫àÂëä„ÅØÁµêÊûú„ÇíÁ§∫ÂîÜ„Åô„Çã„Åå„ÄÅÁ¢∫ÂÆö„Åß„ÅØ„Å™„ÅÑÔºàË£èÂàá„Çä„ÅÇ„ÇäÔºâ
                    const forecastRoll = Math.random() * 100;
                    let forecast = 'white'; // ÁôΩ=ÈÄöÂ∏∏
                    if (forecastRoll < 3) {
                        forecast = 'rainbow'; // Ëôπ=ÊøÄ„Ç¢„ÉÑ
                    } else if (forecastRoll < 10) {
                        forecast = 'red'; // Ëµ§=„ÉÅ„É£„É≥„ÇπÂ§ß
                    } else if (forecastRoll < 25) {
                        forecast = 'gold'; // Èáë=„ÉÅ„É£„É≥„Çπ
                    } else if (forecastRoll < 45) {
                        forecast = 'green'; // Á∑ë=„Å°„Çá„ÅÑ„Ç¢„ÉÑ
                    }

                    // ÈÄ£Ëçò‰∏≠„ÅØ‰∫àÂëä„ÅåËâØ„Åè„Å™„Çä„ÇÑ„Åô„ÅÑ
                    if (isRensouMode && forecast === 'white' && Math.random() < 0.4) {
                        forecast = 'green';
                    }

                    // üé∞ 2. ‰∫àÂëäÊºîÂá∫„ÅÆË°®Á§∫ÔºàÊû†Ëâ≤Â§âÂåñÔºâ
                    setAnimateCheckbox(true);
                    setCurrentForecast(forecast); // Êû†Ëâ≤„ÇíUI„Å´ÂèçÊò†

                    // ‰∫àÂëäÈü≥ÔºàÊû†Ëâ≤„Å´Âøú„Åò„Å¶Â§âÂåñÔºâ
                    if (forecast === 'rainbow') {
                        AudioEngine.play([1200, 1400, 1600, 1800], 'sine', 0.15, 0.08);
                        // Ëôπ‰∫àÂëäÁ¢∫Ë™ç: ÂÖ®ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•
                        setRewardEffect(<RareForecastFlash forecast="rainbow" onComplete={() => setRewardEffect(null)} />);
                        await new Promise(resolve => setTimeout(resolve, 800));
                    } else if (forecast === 'red') {
                        AudioEngine.play([800, 1000, 1200], 'sine', 0.12, 0.06);
                        // Ëµ§‰∫àÂëäÁ¢∫Ë™ç: ÂÖ®ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•
                        setRewardEffect(<RareForecastFlash forecast="red" onComplete={() => setRewardEffect(null)} />);
                        await new Promise(resolve => setTimeout(resolve, 600));
                    } else if (forecast === 'gold') {
                        AudioEngine.play([800, 1000, 1200], 'sine', 0.12, 0.06);
                    } else if (forecast === 'green') {
                        AudioEngine.play([600, 800], 'sine', 0.1, 0.05);
                    } else {
                        AudioEngine.play([1200, 600], 'square', 0.08, 0.02);
                    }

                    // üé∞ 3. „Éâ„É©„É†„É≠„Éº„É´ÔºàÊû†Ëâ≤„Å®ÁµêÊûú„Å´Âøú„Åò„Å¶Èü≥Á®ãÂ§âÂåñÔºâ
                    // Èü≥Á®ã„ÅåÊÆµÈöéÁöÑ„Å´Â§âÂåñ„Åó„ÄÅÁµêÊûú„Çí‰∫àÊ∏¨„Åï„Åõ„Å™„ÅÑ
                    const tier = determineRewardTier(stats.pityCounter, isFeverMode || isRensouMode);
                    const isGoodResult = tier === 'big' || tier === 'jackpot';
                    const isMediumResult = tier === 'normal' || tier === 'small';

                    // „Éâ„É©„É†„É≠„Éº„É´Èü≥ÔºàÈÄî‰∏≠„Åß„Éï„Çß„Ç§„É≥„Éà„ÅÇ„ÇäÔºâ
                    const basePitch = 500;
                    for (let i = 0; i < 10; i++) {
                        const time = i * 80;
                        const pitch = basePitch + (i * 30);
                        // ÈÄî‰∏≠„ÅßÈü≥Á®ã„Åå‰∏ã„Åå„ÇãÔºà„Éï„Çß„Ç§„É≥„ÉàÔºâ
                        const fakeDown = (i === 5 || i === 6) && Math.random() < 0.3;
                        const finalPitch = fakeDown ? pitch - 200 : pitch;
                        setTimeout(() => AudioEngine.play([finalPitch], 'square', 0.05 + i * 0.005, 0.025), time);
                    }

                    await new Promise(resolve => setTimeout(resolve, 800));

                    // üé∞ 4. The FreezeÔºàÁµêÊûúÁô∫Ë°®Áõ¥Ââç„ÅÆÈùôÂØÇÔºâ
                    // 0.3Áßí„ÅÆÂÆåÂÖ®ÂÅúÊ≠¢ + ÂøÉÈü≥
                    AudioEngine.play([60, 80], 'sine', 0.1, 0.15);
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // „É™„Éº„É´ÂÅúÊ≠¢Èü≥ÔºàÁµêÊûú„Å´Âøú„Åò„Å¶Â§âÂåñÔºâ
                    if (isGoodResult) {
                        // Èáç‰ΩéÈü≥ + ÈáëÂ±ûÈü≥
                        AudioEngine.play([100, 150], 'sawtooth', 0.25, 0.1);
                        AudioEngine.play([1500, 2000], 'sine', 0.15, 0.05);
                    } else {
                        AudioEngine.play([300, 200], 'square', 0.18, 0.08);
                    }

                    // üé∞ 5. Â§©‰∫ï„Ç´„Ç¶„É≥„Çø„ÉºÂèØË¶ñÂåñ
                    const newPityCounter = tier === 'whiff' ? stats.pityCounter + 1 : 0;
                    if (newPityCounter >= 5) {
                        setToastMessage(`‚ö° Â§©‰∫ï„Åæ„ÅßÊÆã„Çä${8 - newPityCounter}ÂõûÔºÅ`);
                    }

                    // üé∞ 6. „Éã„Ç¢„Éü„ÇπÂà§ÂÆöÔºàÂº∑ÂåñÁâàÔºâ
                    // ‰∫àÂëä„ÅåËâØ„ÅÑ„ÅÆ„Å´ÁµêÊûú„ÅåÊÇ™„ÅÑ = Âº∑„ÅÑ„Éã„Ç¢„Éü„ÇπÊºîÂá∫
                    let showNearMiss = false;
                    let nearMissIntensity = 'normal';
                    if (tier === 'whiff') {
                        if (forecast === 'rainbow' || forecast === 'red') {
                            showNearMiss = true;
                            nearMissIntensity = 'extreme'; // Ëôπ‰∫àÂëä‚Üí„Çπ„Ç´ = Ë∂ÖÊÇî„Åó„ÅÑ
                        } else if (forecast === 'gold' && Math.random() < 0.5) {
                            showNearMiss = true;
                            nearMissIntensity = 'strong';
                        } else if (forecast === 'green' && Math.random() < 0.3) {
                            showNearMiss = true;
                        } else if (Math.random() < 0.1) {
                            showNearMiss = true;
                        }
                    }

                    // üé∞ 7. ÈÄ£Ëçò„É¢„Éº„ÉâÂá¶ÁêÜ
                    let newRensouCount = stats.rensouCount;
                    if (tier === 'normal' || tier === 'big' || tier === 'jackpot') {
                        // ÂΩì„Åü„ÇäÊôÇ„ÄÅ20%„ÅßÈÄ£ËçòÁ™ÅÂÖ•/Á∂ôÁ∂ö
                        if (Math.random() < 0.2) {
                            newRensouCount = isRensouMode ? stats.rensouCount + 1 : 3;
                            if (isRensouMode) {
                                setToastMessage(`üî• ÈÄ£ËçòÁ∂ôÁ∂öÔºÅÊÆã„Çä${newRensouCount}ÂõûÔºÅ`);
                            } else {
                                setToastMessage('üé∞ ÈÄ£Ëçò„É¢„Éº„ÉâÁ™ÅÂÖ•ÔºÅÊ¨°„ÅÆ3Âõû„ÄÅbigÁ¢∫Áéá2ÂÄçÔºÅ');
                            }
                        }
                    }
                    if (isRensouMode && !isStartPhase) {
                        newRensouCount = Math.max(0, stats.rensouCount - 1);
                        if (newRensouCount === 0) {
                            setToastMessage('üíî ÈÄ£ËçòÁµÇ‰∫Ü...');
                            AudioEngine.play([400, 300, 200], 'sine', 0.15, 0.1);
                        }
                    }

                    return { tier, showNearMiss, nearMissIntensity, newPityCounter, newRensouCount, forecast };
                };

                // === 1ÂõûÁõÆ„ÇØ„É™„ÉÉ„ÇØ: ÈñãÂßã ===
                if (!task.started) {
                    setIsStarting(true);

                    const result = await runGamblingSequence(true);
                    const { tier, showNearMiss, nearMissIntensity, forecast } = result;

                    // ÈñãÂßãÁä∂ÊÖã„Å´Êõ¥Êñ∞
                    onUpdate(task.id, { started: true, startedAt: Date.now() });

                    // Â†±ÈÖ¨ÊºîÂá∫„ÅÆÁô∫ÁÅ´ÔºàÈñãÂßãÊôÇÔºâ
                    const effectComplete = () => {
                        setRewardEffect(null);
                        setIsStarting(false);
                        setAnimateCheckbox(false);
                        setCurrentForecast(null); // Êû†Ëâ≤„É™„Çª„ÉÉ„Éà
                    };

                    // WinText + Â†±ÈÖ¨ÊºîÂá∫„ÇíÂêåÊôÇË°®Á§∫
                    if (tier === 'whiff') {
                        setRewardEffect(<><WinText tier={tier} /><RewardWhiff onComplete={effectComplete} showNearMiss={showNearMiss} nearMissIntensity={nearMissIntensity} consecutiveWhiff={stats.pityCounter} /></>);
                    } else if (tier === 'small') {
                        setRewardEffect(<><WinText tier={tier} /><RewardSmallWin onComplete={effectComplete} centerX={centerX} centerY={centerY} /></>);
                    } else if (tier === 'normal') {
                        setRewardEffect(<><WinText tier={tier} /><RewardNormal onComplete={effectComplete} centerX={centerX} centerY={centerY} /></>);
                    } else if (tier === 'big') {
                        setRewardEffect(<><WinText tier={tier} /><RewardBig onComplete={effectComplete} /></>);
                        setToastMessage('üöÄ START BIG!! ÊúüÂæÖ„ÅåÈ´ò„Åæ„ÇãÔºÅ');
                    } else if (tier === 'jackpot') {
                        setRewardEffect(<><WinText tier={tier} /><RewardJackpot onComplete={effectComplete} /></>);
                        setToastMessage('üé∞ JACKPOT START!!! ÂÆå‰∫ÜÊôÇ„Å´„Åï„Çâ„Å™„ÇãÂ†±ÈÖ¨„ÅåÔºÅ');
                    }

                    return;
                }

                // === ÈñãÂßãÂèñ„ÇäÊ∂à„ÅóÔºàAlt+„ÇØ„É™„ÉÉ„ÇØÔºâ ===
                if (task.started && e.altKey) {
                    onUpdate(task.id, { started: false, startedAt: null });
                    AudioEngine.play([300, 250, 200], 'sine', 0.1, 0.05);
                    setToastMessage('‚Ü©Ô∏è „Çø„Çπ„ÇØÈñãÂßã„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü');
                    return;
                }

                // === 2ÂõûÁõÆ„ÇØ„É™„ÉÉ„ÇØ: ÂÆå‰∫Ü ===
                setIsCompleting(true);

                const result = await runGamblingSequence(false);
                const { tier, showNearMiss, nearMissIntensity, newPityCounter, newRensouCount } = result;

                // „Çø„Çπ„ÇØÂÆå‰∫ÜÂá¶ÁêÜ
                onToggle(task);
                onXpGain(task, rect, setConfettiType);

                // Â†±ÈÖ¨ÊºîÂá∫„ÅÆÁô∫ÁÅ´
                const effectComplete = () => {
                    setRewardEffect(null);
                    setIsCompleting(false);
                    setAnimateCheckbox(false);
                    setCurrentForecast(null); // Êû†Ëâ≤„É™„Çª„ÉÉ„Éà
                };

                // WinText + Â†±ÈÖ¨ÊºîÂá∫ + „Ç∏„Çß„É†Âê∏„ÅÑËæº„ÅøÊºîÂá∫„ÇíÂêåÊôÇË°®Á§∫
                const gemAmounts = { whiff: 0, small: 3, normal: 5, big: 10, jackpot: 20 };
                let gemCount = gemAmounts[tier] || 0;

                // üî• „Ç≥„É≥„ÉúÂà§ÂÆö: 3ÂàÜ‰ª•ÂÜÖ„ÅÆÈÄ£Á∂öÂÆå‰∫Ü„Åß„Ç≥„É≥„ÉúÁô∫Âãï
                const now = Date.now();
                const COMBO_WINDOW = 180000; // 3ÂàÜÔºà„Çø„Çπ„ÇØÁ≤íÂ∫¶„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥Ôºâ
                const timeSinceLast = now - (stats.lastCompletionTime || 0);
                const isCombo = timeSinceLast < COMBO_WINDOW && stats.lastCompletionTime > 0;

                let newComboCount = 0;
                let comboMultiplier = 1;

                if (tier !== 'whiff') { // „Çπ„Ç´„Åß„ÅØ„Ç≥„É≥„ÉúÁ∂ôÁ∂ö„Åó„Å™„ÅÑ
                    if (isCombo) {
                        newComboCount = stats.comboCount + 1;
                        // „Ç≥„É≥„ÉúÂÄçÁéá: 2=1.5x, 3-4=2x, 5+=3x
                        if (newComboCount >= 5) {
                            comboMultiplier = 3;
                        } else if (newComboCount >= 3) {
                            comboMultiplier = 2;
                        } else {
                            comboMultiplier = 1.5;
                        }
                        gemCount = Math.floor(gemCount * comboMultiplier);
                    } else {
                        newComboCount = 1; // „Ç≥„É≥„ÉúÈñãÂßã
                    }
                }

                // „Ç≥„É≥„ÉúÊºîÂá∫„ÇíËøΩÂä†Ôºà2„Ç≥„É≥„Éú‰ª•‰∏ä„ÅßË°®Á§∫Ôºâ
                const showCombo = newComboCount >= 2;

                if (tier === 'whiff') {
                    setRewardEffect(<><WinText tier={tier} /><RewardWhiff onComplete={effectComplete} showNearMiss={showNearMiss} nearMissIntensity={nearMissIntensity} consecutiveWhiff={newPityCounter} /></>);
                    setStats(prev => ({ ...prev, pityCounter: newPityCounter, rensouCount: newRensouCount, comboCount: 0, lastCompletionTime: now }));
                } else if (tier === 'small') {
                    setRewardEffect(<><WinText tier={tier} /><RewardSmallWin onComplete={effectComplete} centerX={centerX} centerY={centerY} /><GemAbsorb amount={gemCount} startX={centerX} startY={centerY} />{showCombo && <ComboDisplay comboCount={newComboCount} />}</>);
                    setStats(prev => ({ ...prev, pityCounter: 0, rensouCount: newRensouCount, gems: prev.gems + gemCount, comboCount: newComboCount, lastCompletionTime: now }));
                    if (showCombo) setToastMessage(`üî• ${newComboCount}x COMBO! +${gemCount}üíé`);
                } else if (tier === 'normal') {
                    setRewardEffect(<><WinText tier={tier} /><RewardNormal onComplete={effectComplete} centerX={centerX} centerY={centerY} /><GemAbsorb amount={gemCount} startX={centerX} startY={centerY} />{showCombo && <ComboDisplay comboCount={newComboCount} />}</>);
                    setStats(prev => ({ ...prev, pityCounter: 0, rensouCount: newRensouCount, gems: prev.gems + gemCount, comboCount: newComboCount, lastCompletionTime: now }));
                    if (showCombo) setToastMessage(`üî• ${newComboCount}x COMBO! +${gemCount}üíé`);
                } else if (tier === 'big') {
                    setRewardEffect(<><WinText tier={tier} /><RewardBig onComplete={effectComplete} /><GemAbsorb amount={gemCount} startX={window.innerWidth / 2} startY={window.innerHeight / 2} />{showCombo && <ComboDisplay comboCount={newComboCount} />}</>);
                    const feverEnd = Date.now() + 3 * 60 * 1000;
                    setStats(prev => ({ ...prev, pityCounter: 0, feverEndTime: feverEnd, rensouCount: newRensouCount, gems: prev.gems + gemCount, comboCount: newComboCount, lastCompletionTime: now }));
                    setToastMessage(showCombo ? `üî• ${newComboCount}x COMBO! FEVER MODE!! +${gemCount}üíé` : 'üî• FEVER MODE!! 3ÂàÜÈñì„É¨„Ç¢Á¢∫Áéá2ÂÄçÔºÅ');
                } else if (tier === 'jackpot') {
                    setRewardEffect(<><WinText tier={tier} /><RewardJackpot onComplete={effectComplete} /><GemAbsorb amount={gemCount} startX={window.innerWidth / 2} startY={window.innerHeight / 2} />{showCombo && <ComboDisplay comboCount={newComboCount} />}</>);
                    const feverEnd = Date.now() + 3 * 60 * 1000;
                    setStats(prev => ({ ...prev, pityCounter: 0, feverEndTime: feverEnd, rensouCount: newRensouCount, gems: prev.gems + gemCount, comboCount: newComboCount, lastCompletionTime: now }));
                    setToastMessage(showCombo ? `üé∞ ${newComboCount}x COMBO! JACKPOT!!! +${gemCount}üíé` : 'üé∞ JACKPOT!!! üî• FEVER MODE Áô∫ÂãïÔºÅ');
                }
            };

            const springClass = isCompleting ? "animate-spring" : "";
            const checkboxPop = animateCheckbox ? "animate-checkbox-pop" : "";
            const anticipationGlow = animateCheckbox ? "animate-anticipation-glow animate-anticipation-pulse" : "";
            // Section 1‰ª•Â§ñ„ÅØ„ÇØ„É™„ÉÉ„ÇØ‰∏çÂèØ (pointer-events-none)
            const disabledClass = !isFocusedSection && !task.completed ? "pointer-events-none opacity-50 grayscale" : "";

            return (
                <div
                    className={`group flex items-start py-5 px-5 border-b-2 transition-all ${springClass} ${disabledClass} ${isDragging ? 'opacity-50 bg-blue-50' : ''} ${task.completed
                        ? 'bg-gray-50 opacity-60 border-gray-100'
                        : isFocusedSection
                            ? 'bg-white border-gray-200 hover:bg-gray-50'
                            : 'bg-gray-100 border-gray-200'
                        }`}
                    draggable={!task.completed}
                    onDragStart={(e) => {
                        if (!task.completed && onDragStart) {
                            onDragStart(e, task);
                        }
                    }}
                    onContextMenu={(e) => onContextMenu && onContextMenu(e, task)}
                >
                    {/* „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´ */}
                    {!task.completed && (
                        <div className="pt-0.5 pr-2 flex-shrink-0 cursor-move text-gray-300 hover:text-gray-500 transition-colors">
                            <Icons.GripVertical size={18} />
                        </div>
                    )}

                    <div className="pt-0.5 pr-4 flex-shrink-0 relative" ref={buttonRef}
                        onClick={(e) => handleToggle(e)}
                        onMouseEnter={() => {
                            // üéØ „Éõ„Éê„ÉºÊôÇ‰∫àÂëä: ÂÆå‰∫ÜÊ∏à„Åø„Åß„Å™„Åë„Çå„Å∞„É©„É≥„ÉÄ„É†‰∫àÂëä„ÇíË°®Á§∫
                            if (!task.completed && !isCompleting && !isStarting && isFocusedSection) {
                                const roll = Math.random() * 100;
                                let preview = '???';
                                if (roll < 5) {
                                    preview = 'üåà';
                                    AudioEngine.play([1200, 1400], 'sine', 0.08, 0.05);
                                } else if (roll < 15) {
                                    preview = 'üíé';
                                    AudioEngine.play([800, 1000], 'sine', 0.06, 0.05);
                                } else if (roll < 30) {
                                    preview = 'üéÅ';
                                    AudioEngine.play([600, 800], 'sine', 0.05, 0.05);
                                } else if (roll < 50) {
                                    preview = '‚ú®';
                                } else {
                                    preview = '???';
                                }
                                setHoverPreview(preview);
                            }
                        }}
                        onMouseLeave={() => setHoverPreview(null)}
                    >
                        {(isCompleting || confettiType === 'ignition') && <Confetti type={confettiType} theme={activeTheme} />}
                        {/* ‰∫àÂëäÊû†Ëâ≤„Ç™„Éº„É©ÔºàÊºîÂá∫‰∏≠„ÅÆ„ÅøË°®Á§∫Ôºâ */}
                        {currentForecast && currentForecast !== 'white' && (
                            <div className={`absolute inset-0 rounded-xl animate-pulse ${currentForecast === 'rainbow' ? 'bg-gradient-to-r from-red-500 via-yellow-400 via-green-400 via-blue-500 to-purple-500' :
                                currentForecast === 'red' ? 'bg-red-500' :
                                    currentForecast === 'gold' ? 'bg-yellow-400' :
                                        'bg-green-400'
                                }`} style={{ opacity: 0.4, transform: 'scale(1.5)' }} />
                        )}
                        {/* üéØ „Éõ„Éê„Éº‰∫àÂëä„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */}
                        {hoverPreview && !currentForecast && !task.completed && !isCompleting && (
                            <div className="absolute -top-8 left-1/2 -translate-x-1/2 animate-bounce z-50">
                                <div className={`px-2 py-1 rounded-lg font-black text-sm whitespace-nowrap shadow-lg ${hoverPreview === 'üåà' ? 'bg-gradient-to-r from-red-500 via-yellow-400 to-blue-500 text-white' :
                                    hoverPreview === 'üíé' ? 'bg-blue-500 text-white' :
                                        hoverPreview === 'üéÅ' ? 'bg-yellow-400 text-gray-800' :
                                            hoverPreview === '‚ú®' ? 'bg-orange-400 text-white' :
                                                'bg-gray-600 text-white'
                                    }`}>
                                    {hoverPreview}
                                </div>
                            </div>
                        )}
                        <div className={`relative w-6 h-6 rounded-xl flex items-center justify-center transition-all ${checkboxPop} ${anticipationGlow} ${currentForecast && currentForecast !== 'white'
                            ? `border-4 scale-125 ${currentForecast === 'rainbow' ? 'border-purple-500 bg-gradient-to-br from-pink-200 to-yellow-200' :
                                currentForecast === 'red' ? 'border-red-500 bg-red-100' :
                                    currentForecast === 'gold' ? 'border-yellow-500 bg-yellow-100' :
                                        'border-green-500 bg-green-100'
                            }`
                            : hoverPreview
                                ? `border-2 scale-110 ${hoverPreview === 'üåà' ? 'border-purple-400 bg-purple-50' :
                                    hoverPreview === 'üíé' ? 'border-blue-400 bg-blue-50' :
                                        hoverPreview === 'üéÅ' ? 'border-yellow-400 bg-yellow-50' :
                                            'border-gray-400 bg-gray-50'}`
                                : task.completed || isCompleting
                                    ? 'bg-duo-blue border-duo-blue border-2 scale-110'
                                    : (task.started || isStarting)
                                        ? 'bg-green-100 border-green-500 border-[3px]'
                                        : isFocusedSection
                                            ? 'border-gray-300 border-2 bg-white text-white group-hover:bg-gray-50'
                                            : 'border-gray-300 border-2 bg-gray-200'
                            }`}>
                            {/* Ëôπ‰∫àÂëäÊôÇ„ÅÆÁâπÊÆä„Ç¢„Ç§„Ç≥„É≥ */}
                            {currentForecast === 'rainbow' && <span className="text-xs">üåà</span>}
                            {currentForecast === 'red' && !task.completed && !isCompleting && <span className="text-xs">üî•</span>}
                            {currentForecast === 'gold' && !task.completed && !isCompleting && <span className="text-xs">‚ú®</span>}
                            {currentForecast === 'green' && !task.completed && !isCompleting && <span className="text-xs">‚ö°</span>}
                            {!currentForecast && (task.completed || isCompleting) && <Icons.Check size={16} className="text-gray-500" strokeWidth={4} />}
                            {!currentForecast && (task.started || isStarting) && !task.completed && !isCompleting && <Icons.Play size={12} className="text-green-600" fill="currentColor" />}
                        </div>
                    </div>
                    <div className="flex-grow min-w-0 pr-2 pt-0.5">
                        <div className={`text-lg font-black leading-tight ${task.completed
                            ? 'text-gray-400 line-through'
                            : isFocusedSection
                                ? 'text-gray-900'
                                : 'text-gray-500'
                            }`}>{task.title}</div>
                    </div>
                    <div className="flex items-center gap-1">
                        {/* Âà∂ÈôêÊôÇÈñìË°®Á§∫: Â∏∏„Å´Ë°®Á§∫„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊôÇ„ÅØ„Éî„É≥„ÇØ„ÄÅÈùû„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊôÇ„ÅØËñÑ„ÅÑ„Ç∞„É¨„Éº */}
                        {!task.completed && (
                            <div className="flex items-center gap-1">
                                {challengeTimeLeft !== null ? (
                                    <span className={`text-[11px] font-black px-3 py-1 rounded-xl border-b-2 shadow-sm ${challengeTimeLeft > 0 ? 'bg-duo-pink text-white border-duo-pinkBorder animate-pulse' : 'bg-gray-200 text-gray-500 border-gray-300'}`}>
                                        {challengeTimeLeft > 0 ? `${Math.floor(challengeTimeLeft / 60)}:${(challengeTimeLeft % 60).toString().padStart(2, '0')}` : 'TIME OVER'}
                                    </span>
                                ) : (
                                    <span
                                        className="text-[11px] font-bold px-3 py-1 rounded-xl bg-gray-50 text-gray-400 border border-gray-200 cursor-pointer hover:bg-gray-100 hover:border-gray-300 transition-colors"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setEditTimeValue(String(task.challengeDuration || 9.5));
                                            setIsEditingTime(true);
                                        }}
                                    >
                                        {task.challengeDuration || 9.5}min
                                    </span>
                                )}
                                {/* ÊôÇÈñìÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ */}
                                {isEditingTime && (
                                    <div className="fixed inset-0 bg-black/50 z-[300] flex items-center justify-center" onClick={() => setIsEditingTime(false)}>
                                        <div className="bg-white rounded-2xl p-6 shadow-floating w-80 animate-scale-in" onClick={(e) => e.stopPropagation()}>
                                            <h3 className="text-lg font-black mb-4 text-gray-700">Set Time Limit</h3>
                                            <div className="flex items-center gap-2 mb-4">
                                                <input
                                                    type="number"
                                                    step="0.5"
                                                    min="0.5"
                                                    value={editTimeValue}
                                                    onChange={(e) => setEditTimeValue(e.target.value)}
                                                    className="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl font-bold text-lg text-center"
                                                />
                                                <span className="font-bold text-gray-500">min</span>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        onUpdate(task.id, { challengeDuration: parseFloat(editTimeValue) });
                                                        setIsEditingTime(false);
                                                    }}
                                                    className="flex-1 bg-duo-blue text-white font-black py-2 rounded-xl hover:scale-105 active:scale-95 transition-transform"
                                                >
                                                    Save
                                                </button>
                                                <button
                                                    onClick={() => setIsEditingTime(false)}
                                                    className="flex-1 bg-gray-200 text-gray-600 font-black py-2 rounded-xl hover:scale-105 active:scale-95 transition-transform"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* „Éú„Çø„É≥Áæ§: Â∏∏„Å´Ë°®Á§∫ */}
                        {!task.completed && (
                            <div className="flex items-center gap-1">
                                {/* ÊåëÊà¶„Éú„Çø„É≥: Â∏∏„Å´Ë°®Á§∫ */}
                                <IconButton
                                    icon={Icons.Flame}
                                    size={18}
                                    className={challengeTimeLeft !== null ? "text-orange-500" : "text-gray-300 hover:text-orange-400 hover:bg-orange-50"}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        const duration = (task.challengeDuration || 9.5) * 60 * 1000;
                                        onUpdate(task.id, { challengeEndTime: Date.now() + duration });

                                        // Morning Burn: Stop burning and save gems when starting a task
                                        if (stats.isBurning && stats.tempGems > 0) {
                                            const savedGems = stats.tempGems;
                                            setStats(prev => ({
                                                ...prev,
                                                gems: prev.gems + savedGems,
                                                tempGems: 0,
                                                initialTempGems: 0,
                                                isBurning: false,
                                                devLogs: [...(prev.devLogs || []), `‚úÖ „Çø„Çπ„ÇØÁùÄÊâãÔºÅ${savedGems}üíé„ÇíÁç≤Âæó„Åó„Åæ„Åó„Åü„ÄÇÊúù„ÅÆÂãùË≤†„Å´ÂãùÂà©ÔºÅ`]
                                            }));
                                            setToastMessage(`üéâ ${savedGems}üíé „ÇíÁç≤ÂæóÔºÅÊúù„ÅÆÂãùË≤†„Å´ÂãùÂà©„Åó„Åæ„Åó„ÅüÔºÅ`);
                                            AudioEngine.play([200, 300, 400, 500], 'sine', 0.2, 0.3);
                                        }
                                    }}
                                />
                                {/* „Åù„ÅÆ‰ªñ„ÅÆ„Éú„Çø„É≥Ôºà„Éõ„Éê„ÉºÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ */}
                                <div className={`flex items-center gap-1 transition-opacity duration-200 ${isMobile ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                                    <IconButton icon={Icons.Trash2} size={18} className="text-gray-300 hover:text-duo-pink hover:bg-red-50" onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} />
                                </div>
                            </div>
                        )}

                        {/* ÂÆå‰∫ÜÊ∏à„Åø„Çø„Çπ„ÇØ„ÅÆ„Éú„Çø„É≥ */}
                        {task.completed && (
                            <div className={`flex items-center gap-1 transition-opacity duration-200 ${isMobile ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                                <IconButton icon={Icons.Trash2} size={18} className="text-gray-300 hover:text-duo-pink" onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- „É°„Ç§„É≥„Ç¢„Éó„É™ ---
        const App = () => {
            const load = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } };
            const [tasks, setTasks] = useState(() => load('duo_v18_tasks', []));
            const [stats, setStats] = useState(() => load('duo_v18_stats', {
                xp: 0, level: 1, gems: 100, streak: 0, lastDate: null, streakFreeze: 0,
                wager: { active: false },
                focusPotion: false,
                resurrectionTickets: 0,
                themes: ['default'], currentTheme: 'default',
                streakBroken: false, savedStreak: 0,
                completedSections: 0,
                devLogs: [],
                mvpScrutinizerActive: true, // „Éá„Éï„Ç©„É´„Éà„ÅßÊúâÂäπ
                devOathActive: false,
                flowCapacitorEndTime: 0,
                tasksCreated: 0,
                tasksPurged: 0,
                lastWakeupChestTime: 0, // ÊúÄÂæå„Å´„Çπ„É™„Éº„ÉóÂæ©Â∏∞ÂÆùÁÆ±„ÇíÈñã„Åë„ÅüÊôÇÂàª
                pityCounter: 0, // Â§©‰∫ï„Ç´„Ç¶„É≥„Çø„ÉºÔºà„Çπ„Ç´„ÅåÁ∂ö„Åè„Å®‰∏äÊòáÔºâ
                feverEndTime: 0, // „Éï„Ç£„Éº„Éê„Éº„É¢„Éº„ÉâÁµÇ‰∫ÜÊôÇÂàª
                rensouCount: 0, // ÈÄ£Ëçò„É¢„Éº„ÉâÊÆã„ÇäÂõûÊï∞
                tempGems: 0,
                initialTempGems: 0,
                isBurning: false,
                burnStartTime: 0,
                // üåÖ „É¢„Éº„Éã„É≥„Ç∞„Éú„Éº„Éä„ÇπÂÆùÁÆ±Áî®
                morningChestClaimedDate: null, // ÊúÄÂæå„Å´„É¢„Éº„Éã„É≥„Ç∞ÂÆùÁÆ±„ÇíÈñã„Åë„ÅüÊó•‰ªò
                // üíé Áù°Áú†„ÉÅ„É£„Éº„Ç∏Áî®
                lastCloseTime: Date.now(), // ÊúÄÂæå„Å´„Ç¢„Éó„É™„ÇíÈñâ„Åò„ÅüÊôÇÂàª
                sleepChargeCollected: false, // ‰ªäÊó•„ÅÆ„Çπ„É™„Éº„Éó„ÉÅ„É£„Éº„Ç∏„ÇíÂõûÂèéÊ∏à„Åø„Åã
                sleepChargeCollectedDate: null, // ÊúÄÂæå„Å´„Çπ„É™„Éº„Éó„ÉÅ„É£„Éº„Ç∏„ÇíÂõûÂèé„Åó„ÅüÊó•‰ªò
                // üî• „Ç≥„É≥„Éú„Ç∑„Çπ„ÉÜ„É†Áî®
                comboCount: 0, // ÁèæÂú®„ÅÆ„Ç≥„É≥„ÉúÊï∞
                lastCompletionTime: 0, // ÊúÄÂæå„ÅÆ„Çø„Çπ„ÇØÂÆå‰∫ÜÊôÇÂàª
            }));

            const SECTION_SIZE = 4;

            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeListId, setActiveListId] = useState('default');
            const [isShopOpen, setIsShopOpen] = useState(false);
            const [isDoubleChance, setIsDoubleChance] = useState(false);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [timerState, setTimerState] = useState({ active: false, time: 52 * 60, mode: 'work' });
            const [isCompletedOpen, setIsCompletedOpen] = useState(false);
            const [toastMessage, setToastMessage] = useState(null);
            const [showChestModal, setShowChestModal] = useState({ show: false, isWakeup: false });
            const [levelGlow, setLevelGlow] = useState(false);
            const [progressGlow, setProgressGlow] = useState(false);
            const [showIgnition, setShowIgnition] = useState(false);
            const [floatingTexts, setFloatingTexts] = useState([]);

            // ‰∏≠ÊØíÊÄßMAXÔºöÂ†±ÈÖ¨ÊºîÂá∫„Ç∑„Çπ„ÉÜ„É†„ÅÆstate
            const [rewardEffect, setRewardEffect] = useState(null);

            // üåÖ „É¢„Éº„Éã„É≥„Ç∞„Éú„Éº„Éä„ÇπÂÆùÁÆ±Áî®state
            const [showMorningChest, setShowMorningChest] = useState(false);
            // üíé Áù°Áú†„ÉÅ„É£„Éº„Ç∏Áî®state
            const [sleepChargeAmount, setSleepChargeAmount] = useState(0);
            const [showSleepChargeModal, setShowSleepChargeModal] = useState(false);
            // üî• „Çπ„Éà„É™„Éº„ÇØË≠¶ÂëäÁî®state
            const [showStreakWarning, setShowStreakWarning] = useState(false);

            // üîî ÈÄöÁü•Ë®±ÂèØÁä∂ÊÖãÔºàgranted/denied/defaultÔºâ
            const [notificationPermission, setNotificationPermission] = useState(
                typeof Notification !== 'undefined' ? Notification.permission : 'default'
            );

            const [contextMenu, setContextMenu] = useState(null);

            // Progress Bar Animation State
            const [progressBounce, setProgressBounce] = useState(false);

            // Drag & Drop State
            const [draggedTaskId, setDraggedTaskId] = useState(null);
            const [dragOverTaskId, setDragOverTaskId] = useState(null);

            const closeToast = useCallback(() => {
                setToastMessage(null);
            }, []);

            useEffect(() => {
                if (!stats.isBurning || stats.tempGems <= 0) return;

                const Ê∂àÊªÖ„Åæ„Åß„ÅÆÁßíÊï∞ = 150; // 2ÂàÜ30Áßí = 150Áßí

                const ÁáÉÁÑº„Çø„Ç§„Éû„Éº = setInterval(() => {
                    setStats(prev => {
                        if (!prev.isBurning || prev.tempGems <= 0) return prev;

                        const ÁèæÂú®ÊôÇÂàª = Date.now();
                        const ÁµåÈÅéÁßíÊï∞ = Math.floor((ÁèæÂú®ÊôÇÂàª - prev.burnStartTime) / 1000);

                        // ÊÆãÈáè = ÂàùÊúüÈ°ç √ó (1 - ÁµåÈÅéÁßí / 150)
                        const ÊÆã„Çä„ÅÆ„ÉÄ„Ç§„É§ = Math.max(0, Math.floor(
                            prev.initialTempGems * (1 - ÁµåÈÅéÁßíÊï∞ / Ê∂àÊªÖ„Åæ„Åß„ÅÆÁßíÊï∞)
                        ));

                        if (ÊÆã„Çä„ÅÆ„ÉÄ„Ç§„É§ === 0) {
                            AudioEngine.play([100, 80, 60, 40], 'sawtooth', 0.3, 0.3);
                            return {
                                ...prev,
                                tempGems: 0,
                                isBurning: false,
                                devLogs: [{ id: Date.now(), text: "üíÄ Â†±ÈÖ¨„ÅåÂÆåÂÖ®„Å´ÁáÉ„ÅàÂ∞Ω„Åç„Åæ„Åó„Åü„ÄÇÊúù„ÅÆÂãùË≤†„Å´ÊïóÂåó„ÄÇ", colorClass: "text-red-600 font-black" }, ...prev.devLogs]
                            };
                        }

                        return { ...prev, tempGems: ÊÆã„Çä„ÅÆ„ÉÄ„Ç§„É§ };
                    });

                    AudioEngine.play([80, 100], 'sine', 0.05, 0.1);
                }, 1000);

                return () => clearInterval(ÁáÉÁÑº„Çø„Ç§„Éû„Éº);
            }, [stats.isBurning]);

            useEffect(() => {
                const h = () => { const m = window.innerWidth < 768; setIsMobile(m); if (!m) setIsSidebarOpen(true); };
                window.addEventListener('resize', h); return () => window.removeEventListener('resize', h);
            }, []);

            useEffect(() => {
                const handleClick = () => setContextMenu(null);
                window.addEventListener('click', handleClick);
                return () => window.removeEventListener('click', handleClick);
            }, []);

            // „Éá„Éê„ÉÉ„Ç∞Áî®„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
            // F12: „Çπ„É™„Éº„ÉóÂÆùÁÆ±, F11: Áù°Áú†„ÉÅ„É£„Éº„Ç∏, F10: „É¢„Éº„Éã„É≥„Ç∞„Éú„Éº„Éä„Çπ
            useEffect(() => {
                const handleDebugKeys = (e) => {
                    if (e.key === 'F12') {
                        e.preventDefault();
                        console.log('[Debug] F12 pressed - Showing wakeup chest!');
                        setShowChestModal({ show: true, isWakeup: true });
                    }
                    if (e.key === 'F11') {
                        e.preventDefault();
                        console.log('[Debug] F11 pressed - Showing sleep charge modal!');
                        setSleepChargeAmount(40);
                        setShowSleepChargeModal(true);
                    }
                    if (e.key === 'F10') {
                        e.preventDefault();
                        console.log('[Debug] F10 pressed - Showing morning bonus chest!');
                        setShowMorningChest(true);
                    }
                };
                window.addEventListener('keydown', handleDebugKeys);
                return () => window.removeEventListener('keydown', handleDebugKeys);
            }, []);

            // „Çπ„É™„Éº„ÉóÊ§úÁü•Ôºö„Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Áä∂ÊÖã„ÅßPC„Çπ„É™„Éº„Éó„ÇíÊ§úÁü•
            useEffect(() => {
                let lastCheckTime = Date.now();
                let intervalId = null;
                let lastWakeupShownTime = 0; // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥Áî®

                const startMonitoring = () => {
                    // „Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™ÊôÇ„ÅÆ„ÅøÁõ£Ë¶ñ
                    if (document.visibilityState === 'visible') {
                        lastCheckTime = Date.now();
                        console.log('[Sleep Detection] Monitoring started at', new Date().toLocaleTimeString());

                        intervalId = setInterval(() => {
                            const now = Date.now();
                            const timeSinceLastCheck = now - lastCheckTime;

                            // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞Ôºà10Áßí„Åî„Å®Ôºâ
                            if (Math.floor(now / 10000) !== Math.floor(lastCheckTime / 10000)) {
                                console.log('[Sleep Detection] Still monitoring... Last check was', timeSinceLastCheck, 'ms ago');
                            }

                            // 1Áßí‰ª•‰∏ä„ÅÆÈÅÖÂª∂ = PC„Çπ„É™„Éº„Éó„Å®Âà§ÂÆö
                            // Ôºà„Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÅÆ„Åß„ÄÅ„Çø„ÉñÂàá„ÇäÊõø„Åà„Åß„ÅØ„Å™„ÅÑÔºâ
                            if (timeSinceLastCheck > 1000) {
                                const timeSinceLastWakeup = now - lastWakeupShownTime;
                                console.log('[Sleep Detection] Sleep detected!', timeSinceLastCheck, 'ms gap. Last wakeup chest:', timeSinceLastWakeup, 'ms ago');

                                // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥ÔºöÂâçÂõû„Åã„Çâ30ÂàÜ‰ª•‰∏äÁµåÈÅé„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                                if (timeSinceLastWakeup > 1800000) {
                                    console.log('[Sleep Detection] Showing wakeup chest!');
                                    setShowChestModal({ show: true, isWakeup: true });
                                    lastWakeupShownTime = now;
                                } else {
                                    const remainingMinutes = Math.ceil((1800000 - timeSinceLastWakeup) / 60000);
                                    console.log('[Sleep Detection] Cooldown active, not showing chest. Need', remainingMinutes, 'more minutes');
                                }
                            }

                            lastCheckTime = now;
                        }, 1000);
                    }
                };

                const stopMonitoring = () => {
                    if (intervalId) {
                        console.log('[Sleep Detection] Monitoring stopped');
                        clearInterval(intervalId);
                        intervalId = null;
                    }
                };

                const handleVisibilityChange = () => {
                    console.log('[Sleep Detection] Visibility changed to:', document.visibilityState);
                    if (document.visibilityState === 'visible') {
                        startMonitoring();
                    } else {
                        stopMonitoring();
                    }
                };

                // ÂàùÊúüÂåñÔºö„Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÇâÁõ£Ë¶ñÈñãÂßã
                startMonitoring();
                document.addEventListener('visibilitychange', handleVisibilityChange);

                return () => {
                    stopMonitoring();
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                };
            }, []);

            useEffect(() => {
                localStorage.setItem('duo_v18_tasks', JSON.stringify(tasks));
                localStorage.setItem('duo_v18_stats', JSON.stringify(stats));
            }, [tasks, stats]);

            // üåÖ „É¢„Éº„Éã„É≥„Ç∞„Éú„Éº„Éä„ÇπÂÆùÁÆ±„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç¢„Éó„É™Ëµ∑ÂãïÊôÇÔºâ
            useEffect(() => {
                const now = new Date();
                const currentHour = now.getHours();
                const today = getAdjustedToday();

                // 12:00„Äú16:00„ÅÆÊôÇÈñìÂ∏Ø„Åã„Å§„ÄÅ‰ªäÊó•„Åæ„Å†Èñã„Åë„Å¶„ÅÑ„Å™„ÅÑ
                const isMorningWindow = currentHour >= 12 && currentHour < 16;
                const notClaimedToday = stats.morningChestClaimedDate !== today;

                if (isMorningWindow && notClaimedToday) {
                    console.log('[Morning Bonus] Morning window active! Showing morning chest.');
                    // 2ÁßíÂæå„Å´Ë°®Á§∫Ôºà„Ç¢„Éó„É™Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
                    const timer = setTimeout(() => {
                        setShowMorningChest(true);
                        AudioEngine.play([523, 659, 784, 880, 1047], 'sine', 0.2, 0.12);
                    }, 2000);
                    return () => clearTimeout(timer);
                }
            }, []);

            // üíé Áù°Áú†„ÉÅ„É£„Éº„Ç∏Ë®àÁÆóÔºà„Ç¢„Éó„É™Ëµ∑ÂãïÊôÇÔºâ- 8ÊôÇÈñì‰ª•‰∏ä„Åß40üíé„ÅÆ„Åø
            useEffect(() => {
                const today = getAdjustedToday();
                const lastClose = stats.lastCloseTime || Date.now();
                const now = Date.now();
                const hoursAsleep = (now - lastClose) / (1000 * 60 * 60);

                // 8ÊôÇÈñì‰ª•‰∏äÈõ¢„Çå„Å¶„ÅÑ„Å¶„ÄÅ‰ªäÊó•„Åæ„Å†ÂõûÂèé„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø
                const notCollectedToday = stats.sleepChargeCollectedDate !== today;

                if (hoursAsleep >= 8 && notCollectedToday) {
                    // 8ÊôÇÈñì‰ª•‰∏ä„Å™„ÇâÂõ∫ÂÆö40üíé
                    const charge = 40;
                    setSleepChargeAmount(charge);

                    console.log('[Sleep Charge] Full sleep detected!', hoursAsleep.toFixed(1), 'hours. Reward: 40üíé');

                    // 5ÁßíÂæå„Å´Ë°®Á§∫Ôºà„É¢„Éº„Éã„É≥„Ç∞ÂÆùÁÆ±„Çà„ÇäÂæåÔºâ
                    const timer = setTimeout(() => {
                        // „É¢„Éº„Éã„É≥„Ç∞ÂÆùÁÆ±„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø
                        if (!showMorningChest) {
                            setShowSleepChargeModal(true);
                            AudioEngine.play([400, 500, 600], 'sine', 0.15, 0.1);
                        }
                    }, 5000);
                    return () => clearTimeout(timer);
                }
            }, []);

            // üî• „Çπ„Éà„É™„Éº„ÇØË≠¶Âëä„ÉÅ„Çß„ÉÉ„ÇØÔºàÊØéÂàÜ„ÉÅ„Çß„ÉÉ„ÇØÔºâ
            useEffect(() => {
                const checkStreakDanger = () => {
                    if (!stats.lastDate || stats.streakBroken || stats.streak === 0) return;

                    const now = new Date();
                    const lastActivity = new Date(stats.lastDate + 'T03:00:00'); // 3AM reset
                    const nextReset = new Date(lastActivity);
                    nextReset.setDate(nextReset.getDate() + 1);

                    const msUntilReset = nextReset.getTime() - now.getTime();
                    const hoursUntilReset = msUntilReset / (1000 * 60 * 60);

                    // ÊÆã„Çä1ÊôÇÈñì‰ª•‰∏ã„ÅßË≠¶Âëä
                    if (hoursUntilReset <= 1 && hoursUntilReset > 0) {
                        setShowStreakWarning(true);
                        console.log('[Streak Warning] Only', Math.ceil(hoursUntilReset * 60), 'minutes left!');
                    } else {
                        setShowStreakWarning(false);
                    }
                };

                checkStreakDanger();
                const interval = setInterval(checkStreakDanger, 60000); // 1ÂàÜ„Åî„Å®
                return () => clearInterval(interval);
            }, [stats.lastDate, stats.streakBroken, stats.streak]);

            // üì¥ „Ç¢„Éó„É™„ÇíÈñâ„Åò„ÇãÊôÇ„Å´ÊôÇÂàª„Çí‰øùÂ≠ò
            useEffect(() => {
                const handleBeforeUnload = () => {
                    const updatedStats = { ...stats, lastCloseTime: Date.now() };
                    localStorage.setItem('duo_v18_stats', JSON.stringify(updatedStats));
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [stats]);

            useEffect(() => {
                const today = getAdjustedToday();
                // Dev's Oath Check
                if (stats.devOathActive && stats.lastDate !== today) {
                    // Logic for oath check would go here
                }

                if (stats.lastDate && stats.lastDate !== today) {
                    const last = new Date(stats.lastDate); const curr = new Date(today);
                    const diff = (curr - last) / (1000 * 60 * 60 * 24);
                    if (diff > 1 && stats.streak > 0 && !stats.streakBroken) {
                        if (stats.streakFreeze > 0) {
                            setStats(s => ({ ...s, streakFreeze: s.streakFreeze - 1, lastDate: today }));
                            setToastMessage("„Éï„É™„Éº„Ç∫Áô∫ÂãïÔºÅStreak„ÅØÂÆà„Çâ„Çå„Åæ„Åó„Åü‚ùÑÔ∏è");
                        } else {
                            setStats(s => ({ ...s, streakBroken: true, savedStreak: s.streak, streak: 0 }));
                        }
                    }
                }
            }, []);

            // Antigravity Integration - Auto-create tasks from URL parameters
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);

                // Support multiple task parameters: ?task=A&task=B&task=C
                // Also split each parameter by semicolons or pipes: ?task=A;B||C
                const taskParams = params.getAll('task')
                    .flatMap(t => t.split(/[;|]+/).map(s => s.trim()).filter(s => s));

                // Support comma-separated tasks: ?tasks=A,B,C
                // Also split by semicolons or pipes: ?tasks=A,B;C||D
                const tasksParam = params.get('tasks');
                const tasksFromComma = tasksParam
                    ? tasksParam.split(/[,;|]+/).map(t => t.trim()).filter(t => t)
                    : [];

                // Combine all tasks
                const allTasks = [...taskParams, ...tasksFromComma];

                if (allTasks.length > 0) {
                    const newTasks = [];
                    let addedCount = 0;
                    let skippedCount = 0;

                    allTasks.forEach((taskTitle, index) => {
                        // Check if task already exists to avoid duplicates
                        const taskExists = tasks.some(t => t.title === taskTitle);

                        if (!taskExists) {
                            const newTask = {
                                id: (Date.now() + index).toString(),
                                title: taskTitle,
                                completed: false,
                                listId: activeListId,
                                createdAt: Date.now() + index,
                                isSectionHead: tasks.length === 0 && newTasks.length === 0
                            };
                            newTasks.push(newTask);
                            addedCount++;
                        } else {
                            skippedCount++;
                        }
                    });

                    if (newTasks.length > 0) {
                        setTasks(prevTasks => [...prevTasks, ...newTasks]);
                        setStats(s => ({ ...s, tasksCreated: s.tasksCreated + newTasks.length }));

                        if (newTasks.length === 1) {
                            setToastMessage(`‚ú® Task added from Antigravity: ${newTasks[0].title}`);
                        } else {
                            setToastMessage(`‚ú® ${newTasks.length} tasks added from Antigravity`);
                        }
                    }

                    if (skippedCount > 0 && addedCount === 0) {
                        setToastMessage(`‚ö†Ô∏è All tasks already exist (${skippedCount} skipped)`);
                    }

                    // Clear URL parameters to avoid re-adding on refresh
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, []);

            useEffect(() => {
                let timer = null;
                if (timerState.active && timerState.time > 0) {
                    timer = setInterval(() => setTimerState(s => ({ ...s, time: s.time - 1 })), 1000);
                } else if (timerState.time === 0) {
                    const isWork = timerState.mode === 'work';
                    setTimerState({ active: false, mode: isWork ? 'break' : 'work', time: isWork ? 17 * 60 : 52 * 60 });
                    AudioEngine.play([880, 440], 'sine', 0.15, 0.2);

                    setStats(s => {
                        if (s.wager.active) {
                            setToastMessage("ÂÄç„ÅãÁÑ°„Åã... Â§±Êïó üò¢");
                            return { ...s, wager: { active: false } };
                        }
                        return s;
                    });
                }
                return () => clearInterval(timer);
            }, [timerState.active, timerState.time]);

            const switchTimerMode = (mode) => {
                const time = mode === 'work' ? 52 * 60 : 17 * 60;
                setTimerState({ active: false, mode, time });
                if (mode === 'break') {
                    setStats(s => {
                        if (s.wager.active) {
                            setToastMessage("ÂÄç„ÅãÁÑ°„Åã... Â§±Êïó üò¢");
                            return { ...s, wager: { active: false } };
                        }
                        return s;
                    });
                }
            };

            const resurrectStreak = () => {
                if (stats.resurrectionTickets > 0 && stats.streakBroken) {
                    setStats(s => ({
                        ...s,
                        streak: s.savedStreak,
                        streakBroken: false,
                        resurrectionTickets: s.resurrectionTickets - 1,
                        lastDate: getAdjustedToday()
                    }));
                    setToastMessage("StreakÂæ©Ê¥ªÔºÅüî•");
                    AudioEngine.play([523, 659, 784, 1046], 'sine', 0.2, 0.1);
                }
            };

            const handleContextMenu = (e, task) => {
                e.preventDefault();
                setContextMenu({ x: e.clientX, y: e.clientY, task });
            };

            const toggleSectionBreak = () => {
                if (!contextMenu) return;
                const currentIndex = tasks.findIndex(t => t.id === contextMenu.task.id);
                if (currentIndex === -1 || currentIndex === tasks.length - 1) return;

                const nextTask = tasks[currentIndex + 1];
                const isHead = nextTask.isSectionHead;

                setTasks(tasks.map((t, idx) =>
                    idx === currentIndex + 1 ? { ...t, isSectionHead: !isHead } : t
                ));
                setContextMenu(null);
            };

            // MVP Scrutinizer: „Éë„Éº„Ç∏Ê©üËÉΩ
            const purgeTask = () => {
                if (!contextMenu) return;
                const taskToPurge = contextMenu.task;

                // „Çø„Çπ„ÇØ„ÇíÊú´Â∞æ„Å∏ÁßªÂãï
                const newTasks = tasks.filter(t => t.id !== taskToPurge.id);
                newTasks.push(taskToPurge);

                setTasks(newTasks);
                setContextMenu(null);

                // „Éë„Éº„Ç∏Â†±ÈÖ¨: MVPÊúÄÈÅ©ÂåñË°åÂãï„Å™„ÅÆ„ÅßÈ´òÂ†±ÈÖ¨
                const purgeReward = 25;
                setStats(s => ({
                    ...s,
                    gems: s.gems + purgeReward,
                    tasksPurged: s.tasksPurged + 1
                }));

                setToastMessage(`‚ú® MVPÊúÄÈÅ©ÂåñÔºÅ+${purgeReward}üíé`);
                AudioEngine.play([400, 600, 800], 'sine', 0.15, 0.08);
            };

            const checkSectionCompletion = (completedTaskId) => {
                let sectionTasks = [];
                let currentSection = [];

                for (let i = 0; i < tasks.length; i++) {
                    const t = tasks[i];
                    if (i > 0 && t.isSectionHead) {
                        if (currentSection.length > 0) sectionTasks.push(currentSection);
                        currentSection = [];
                    }
                    currentSection.push(t);
                }
                if (currentSection.length > 0) sectionTasks.push(currentSection);

                const targetSection = sectionTasks.find(section => section.some(t => t.id === completedTaskId));

                if (targetSection) {
                    const allCompleted = targetSection.every(t => t.id === completedTaskId || t.completed);
                    if (allCompleted) {
                        return true;
                    }
                }
                return false;
            };

            const handleXpGain = (task, rect, setConfettiType, manualXp = 0) => {
                const today = getAdjustedToday();
                const now = new Date();
                const currentHour = now.getHours();

                // Section 1Âà§ÂÆö
                let section1Tasks = [];
                for (let t of tasks) {
                    if (section1Tasks.length > 0 && t.isSectionHead) break;
                    section1Tasks.push(t);
                }
                const isSection1Task = section1Tasks.some(t => t.id === task.id);

                // 1. Determine Reward Type & Amount
                let rewardAmount = 2; // Default: Focus (Normal)
                let rewardType = 'normal'; // normal, velocity, morning, milestone, mvpSprint
                let logText = "";

                // Milestone (100üíé): Section 1 Complete - ÊúÄÈ´òÂ†±ÈÖ¨
                const isSectionComplete = checkSectionCompletion(task.id);
                if (isSectionComplete && isSection1Task) {
                    rewardAmount = 100;
                    rewardType = 'milestone';
                    logText = "[üöÄ MVP SPRINT] Section 1„ÇØ„É™„Ç¢ÔºÅMVPÊ©üËÉΩ„ÅåÂÆåÊàê„Åó„Åæ„Åó„Åü„ÄÇ";
                } else if (isSectionComplete) {
                    rewardAmount = 50;
                    rewardType = 'milestone';
                    logText = "[Milestone] Section „ÇØ„É™„Ç¢„ÄÇ";
                }

                // Morning Ignition (30üíé): Before 13PM & First Task
                const isFirstTaskToday = stats.lastDate !== today;
                if (currentHour < 13 && isFirstTaskToday && rewardAmount < 30) {
                    rewardAmount = 30;
                    rewardType = 'morning';
                    logText = `[Early Bird] Êúù„ÅÆÁùÄÁÅ´ÊàêÂäü„ÄÇ${task.title} „ÇíÂÆå‰∫Ü„ÄÇ`;
                }

                // High Velocity (20üíé for Section 1, 15üíé for others)
                const isChallenge = task.challengeEndTime && task.challengeEndTime > Date.now();
                const isFlowActive = Date.now() < stats.flowCapacitorEndTime;

                if ((isChallenge || isFlowActive) && rewardAmount < 15) {
                    rewardAmount = isSection1Task ? 20 : 15;
                    rewardType = 'velocity';
                    logText = isSection1Task
                        ? `[‚ö° MVP Focus] ${task.title} „ÇíÊúÄÈÄü„ÅßÂÆåÈÅÇ„ÄÇ„É™„É™„Éº„Çπ„ÅåËøë„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ`
                        : `[High Velocity] „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØÊàêÂäü„ÄÇ${task.title} „ÇíÊúÄÁü≠Â∑•Êï∞„ÅßÂÆåÈÅÇ„Åó„Åæ„Åó„Åü„ÄÇ`;
                }

                // MVP Task Bonus: Section 1„ÅÆ„Çø„Çπ„ÇØ„ÅØÂü∫Á§éÂ†±ÈÖ¨Â¢óÂä†
                if (isSection1Task && rewardAmount < 10) {
                    rewardAmount = 10;
                    rewardType = 'mvpFocus';
                    logText = `[MVP Task] ${task.title} ÂÆå‰∫Ü„ÄÇMVPÈñãÁô∫„ÇíÂâçÈÄ≤„Åï„Åõ„Åæ„Åó„Åü„ÄÇ`;
                }

                // Normal log if not specified
                if (!logText) {
                    logText = `[Focus] ${task.title} ÂÆå‰∫Ü„ÄÇ`;
                }

                let wagerBonus = 0;
                let wagerComplete = false;

                // Progress Bar Shimmer & Bounce
                setLevelGlow(true);
                setProgressBounce(true);
                setTimeout(() => setLevelGlow(false), 500);
                setTimeout(() => setProgressBounce(false), 500);

                setProgressGlow(true);
                setTimeout(() => setProgressGlow(false), 700);

                // Confetti & Floating Text Setup
                if (setConfettiType) {
                    // Always show small sparks (ignition) for normal
                    // Show performance confetti for higher rewards
                    if (rewardAmount >= 15) {
                        setConfettiType('performance');
                        AudioEngine.play([440, 554, 659, 880], 'square', 0.2, 0.1);
                    } else {
                        setConfettiType('ignition');
                    }
                }

                setStats(prev => {
                    const isFirstTaskToday = prev.lastDate !== today;
                    if (isFirstTaskToday) {
                        setShowIgnition(true);
                        setTimeout(() => setShowIgnition(false), 2000);
                        AudioEngine.play([100, 150, 200, 300, 500], 'sawtooth', 0.2, 0.1);
                    }

                    // Dev's Oath Success
                    let oathBonus = 0;
                    if (isFirstTaskToday && prev.devOathActive) {
                        oathBonus = 100;
                        setToastMessage("Dev's Oath ÈÅîÊàêÔºÅ100üíéËøîÈÇÑÔºÅ");
                    }

                    // XPÂä†ÁÆóÂâäÈô§
                    let newXp = prev.xp;
                    let newLevel = prev.level;
                    let newStreak = prev.streak;
                    let newWager = { ...prev.wager };
                    let newGems = prev.gems + rewardAmount; // Use calculated reward

                    if (isFirstTaskToday) {
                        if (!prev.lastDate) {
                            newStreak = 1;
                        } else {
                            const last = new Date(prev.lastDate); const curr = new Date(today);
                            const diff = (curr - last) / (1000 * 60 * 60 * 24);

                            if (diff <= 1) {
                                newStreak++;
                            } else {
                                newStreak = 1;
                            }
                        }
                    }

                    // Wager Logic (Simplified: Active & Challenge Success = Win)
                    if (prev.wager.active && (isChallenge || isFlowActive)) {
                        wagerBonus = 100;
                        wagerComplete = true;
                        newWager = { active: false };
                    }

                    if (wagerBonus > 0) newGems += wagerBonus;
                    if (oathBonus > 0) newGems += oathBonus;

                    if (wagerComplete) setToastMessage("ÂÄç„ÅãÁÑ°„ÅãÈÅîÊàêÔºÅ100üíéÁç≤ÂæóÔºÅ");

                    // Floating Text Style Logic
                    let floatColor = "text-slate-400 text-sm";
                    let floatScale = "scale-100";
                    let floatText = `+${rewardAmount}üíé`;

                    if (rewardAmount >= 100) {
                        floatColor = "text-yellow-400 font-black";
                        floatScale = "scale-[2] animate-bounce-hard";
                        floatText = `üöÄ +${rewardAmount}üíé`;
                    } else if (rewardAmount >= 50) {
                        floatColor = "text-fuchsia-500 font-black";
                        floatScale = "scale-150 animate-bounce-hard";
                    } else if (rewardAmount >= 30) {
                        floatColor = "text-amber-500 font-bold";
                        floatScale = "scale-125";
                    } else if (rewardAmount >= 15) {
                        floatColor = "text-cyan-400 font-bold";
                        floatScale = "scale-110";
                    } else if (rewardAmount >= 10) {
                        floatColor = "text-blue-400 font-bold";
                        floatScale = "scale-105";
                    }

                    // Log Logic
                    let newLogs = prev.devLogs || [];
                    // Log Color based on reward type for display logic later
                    let logColorClass = "text-gray-600";
                    if (rewardType === 'milestone') logColorClass = "text-yellow-600 font-black";
                    else if (rewardType === 'morning') logColorClass = "text-amber-600 font-bold";
                    else if (rewardType === 'velocity') logColorClass = "text-cyan-600 font-bold";
                    else if (rewardType === 'mvpFocus') logColorClass = "text-blue-600 font-bold";

                    // Prepend timestamp to text for simple display or store structure
                    const logEntry = {
                        id: Date.now(),
                        text: logText,
                        date: new Date().toLocaleTimeString(),
                        colorClass: logColorClass
                    };
                    newLogs = [logEntry, ...newLogs].slice(0, 20);

                    // Add Floating Text
                    if (rect) {
                        const id = Date.now();
                        setFloatingTexts(prev => [...prev, { id, x: rect.left + 50, y: rect.top - 20, text: floatText, color: floatColor, scale: floatScale }]);
                        setTimeout(() => setFloatingTexts(prev => prev.filter(t => t.id !== id)), 1000);
                    }

                    return {
                        ...prev, xp: newXp, level: newLevel, gems: newGems, streak: newStreak, lastDate: today,
                        wager: newWager,
                        streakBroken: false,
                        devLogs: newLogs,
                        devOathActive: oathBonus > 0 ? false : prev.devOathActive
                    };
                });
            };

            const buyItem = (cost, action) => {
                if (stats.gems < cost) {
                    setToastMessage("„Ç∏„Çß„É†„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅüíé");
                    AudioEngine.play([150, 100], 'sawtooth', 0.1, 0.1);
                    return;
                }
                setStats(prev => ({ ...prev, gems: prev.gems - cost }));
                action();
                AudioEngine.play([783, 1046], 'sine', 0.1, 0.1);
            };

            const handleReward = (reward, isWakeupChest = false) => {
                if (reward.type === 'gems') {
                    if (isWakeupChest) {
                        setStats(prev => ({
                            ...prev,
                            tempGems: reward.amount,
                            initialTempGems: reward.amount,
                            isBurning: true,
                            burnStartTime: Date.now(),
                            devLogs: [{ id: Date.now(), text: `‚ö†Ô∏è ${reward.amount}üíé„Çí‰ªÆÁç≤Âæó„ÄÇ150Áßí‰ª•ÂÜÖ„Å´ÁùÄÊâã„Åõ„ÇàÔºÅ`, colorClass: "text-orange-600 font-bold" }, ...prev.devLogs]
                        }));
                        setToastMessage(`üî• ${reward.text} „Çí‰ªÆÁç≤ÂæóÔºÅ„Åô„Åê„Å´ÁùÄÊâã„Åó„Å™„ÅÑ„Å®ÁáÉ„ÅàÂ∞Ω„Åç„Åæ„ÅôÔºÅ`);
                    } else {
                        setStats(prev => ({ ...prev, gems: prev.gems + reward.amount }));
                        setToastMessage(`${reward.text} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`);
                    }
                } else if (reward.itemId === 'freeze') {
                    setStats(prev => ({ ...prev, streakFreeze: prev.streakFreeze + 1 }));
                    setToastMessage(`${reward.text} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`);
                } else if (reward.itemId === 'ticket') {
                    setStats(prev => ({ ...prev, resurrectionTickets: prev.resurrectionTickets + 1 }));
                    setToastMessage(`${reward.text} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`);
                }
            };

            const unlockTheme = (themeName, cost) => {
                if (stats.themes.includes(themeName)) {
                    setStats(s => ({ ...s, currentTheme: themeName }));
                    setToastMessage("„ÉÜ„Éº„Éû„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åüüé®");
                } else {
                    buyItem(cost, () => {
                        setStats(s => ({ ...s, themes: [...s.themes, themeName], currentTheme: themeName }));
                        setToastMessage("Êñ∞„ÉÜ„Éº„ÉûÁç≤ÂæóÔºÅ‚ú®");
                    });
                }
            };

            const updateTask = (id, updates) => setTasks(tasks.map(t => t.id === id ? { ...t, ...updates } : t));

            // „Çø„Çπ„ÇØ„ÅÆ‰∏¶„Å≥Êõø„ÅàÊ©üËÉΩ
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÈñ¢Êï∞
            const handleDragStart = (e, task) => {
                setDraggedTaskId(task.id);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, task) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverTaskId(task.id);
            };

            const handleDrop = (e, dropTask) => {
                e.preventDefault();

                if (!draggedTaskId || draggedTaskId === dropTask.id) {
                    setDraggedTaskId(null);
                    setDragOverTaskId(null);
                    return;
                }

                const draggedIndex = tasks.findIndex(t => t.id === draggedTaskId);
                const dropIndex = tasks.findIndex(t => t.id === dropTask.id);

                if (draggedIndex === -1 || dropIndex === -1) {
                    setDraggedTaskId(null);
                    setDragOverTaskId(null);
                    return;
                }

                const newTasks = [...tasks];
                const [draggedTask] = newTasks.splice(draggedIndex, 1);
                newTasks.splice(dropIndex, 0, draggedTask);

                setTasks(newTasks);
                setDraggedTaskId(null);
                setDragOverTaskId(null);
            };

            const handleDragEnd = () => {
                setDraggedTaskId(null);
                setDragOverTaskId(null);
            };

            const visibleTasks = tasks.filter(t => activeListId === 'default' ? !t.listId || t.listId === 'default' : t.listId === activeListId);
            const incomplete = visibleTasks.filter(t => !t.completed);
            const completed = visibleTasks.filter(t => t.completed);

            const totalTasks = tasks.length;
            const completedTasksCount = tasks.filter(t => t.completed).length;
            const completionRate = totalTasks === 0 ? 0 : Math.round((completedTasksCount / totalTasks) * 100);

            // Calculate Section 1 completion for Rocket Pulse
            let section1Tasks = [];
            for (let t of tasks) {
                if (section1Tasks.length > 0 && t.isSectionHead) break;
                section1Tasks.push(t);
            }
            const section1Total = section1Tasks.length;
            const section1Completed = section1Tasks.filter(t => t.completed).length;
            const section1Rate = section1Total === 0 ? 0 : section1Completed / section1Total;
            // Pulse speed depends on rate. 0.2s (fast) to 2s (slow)
            const pulseDuration = section1Rate > 0 ? Math.max(0.2, 2 - (section1Rate * 1.8)) + 's' : '0s';


            const btn3DClass = "transition-all active:translate-y-[4px] active:border-b-0 border-b-[4px] hover:scale-105 active:scale-95 duration-150";

            const isStreakActive = stats.lastDate === getAdjustedToday();

            let sectionCounter = 0;

            // Helper to determine if a task is the last in its section (of incomplete tasks)
            const isLastTaskInSection = (index) => {
                const nextTask = incomplete[index + 1];
                return !nextTask || nextTask.isSectionHead;
            };

            return (
                <div className="flex h-screen w-full bg-white overflow-hidden relative selection:bg-duo-green/20 font-bold text-duo-text">

                    {/* Header */}
                    <header className="fixed top-0 left-0 right-0 h-16 bg-white border-b-2 border-gray-100 z-[100] flex items-center justify-between px-6">
                        {/* Left: Menu Button */}
                        <div className="flex-shrink-0 z-20">
                            <IconButton icon={Icons.Menu} onClick={() => setIsSidebarOpen(!isSidebarOpen)} />
                        </div>

                        {/* Center: Project Progress Bar (MVP Progress) */}
                        <div className="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-[500px] px-4 hidden md:block">
                            <div className={`relative h-8 bg-gray-100 rounded-full overflow-hidden border-2 border-gray-200 shadow-inner ${levelGlow ? 'animate-pulse' : ''}`}>
                                <div className={`h-full bg-gradient-to-r from-duo-green to-duo-greenHighlight transition-all duration-700 ease-out relative ${levelGlow ? 'progress-glow brightness-125' : ''}`} style={{ width: `${completionRate}%` }}>
                                    <div className="absolute inset-0 bg-white/20 animate-shimmer" style={{ backgroundSize: '200% 100%' }} />
                                </div>
                                <div className={`absolute inset-0 flex items-center justify-center gap-2 z-10 transition-transform ${progressBounce ? 'scale-110' : ''}`}>
                                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest opacity-40" style={{ textShadow: '0 1px 0 rgba(255,255,255,0.8)' }}>MVP Progress</span>
                                    <span className={`text-xs font-black ${progressBounce ? 'text-duo-green' : 'text-slate-600'}`} style={{ textShadow: '0 1px 0 rgba(255,255,255,0.6)' }}>{completionRate}%</span>
                                </div>
                                <div className="absolute right-2 top-1/2 transform -translate-y-1/2 text-lg z-20" style={{ animation: section1Rate > 0 && section1Rate < 1 ? `pulse ${pulseDuration} cubic-bezier(0.4, 0, 0.6, 1) infinite` : 'none', color: section1Rate > 0.8 ? '#ef4444' : 'currentColor', filter: 'drop-shadow(0 1px 1px rgba(0,0,0,0.1))' }}>üöÄ</div>
                            </div>
                        </div>

                        {/* Right: Reward Units (Streak & Gem) */}
                        <div className="flex items-center gap-2 z-20">
                            {/* Streak Unit */}
                            <div className="relative">
                                <button className={`flex items-center gap-1.5 px-3 py-1.5 rounded-2xl transition-all group ${isStreakActive ? 'hover:bg-gray-50' : ''}`}>
                                    <Icons.Flame
                                        size={26}
                                        fill="currentColor"
                                        className={`transition-colors duration-500 ${!stats.streakBroken && isStreakActive ? "text-duo-orange" : "text-[#e5e5e5]"}`}
                                    />
                                    <span className={`text-lg font-black transition-colors duration-500 ${!stats.streakBroken && isStreakActive ? "text-duo-orange" : "text-[#e5e5e5]"}`}>
                                        {stats.streakBroken ? 0 : stats.streak}
                                    </span>
                                </button>
                                {stats.streakBroken && stats.resurrectionTickets > 0 && (
                                    <button onClick={resurrectStreak} className={`absolute -bottom-8 left-1/2 -translate-x-1/2 bg-duo-blue text-white text-xs font-black px-3 py-1 rounded-xl whitespace-nowrap animate-bounce border-b-4 border-duo-blueBorder ${btn3DClass} z-50`}>
                                        Âæ©Ê¥ªÔºÅ
                                    </button>
                                )}
                            </div>

                            {/* Gem Unit */}
                            <button className={`flex items-center gap-1.5 px-3 py-1.5 rounded-2xl transition-all group ${isStreakActive ? 'hover:bg-gray-50' : ''}`}>
                                <Icons.Gem
                                    size={26}
                                    fill="currentColor"
                                    className={`transition-transform duration-500 ${!stats.streakBroken && isStreakActive ? "text-cyan-400" : "text-[#e5e5e5]"}`}
                                />
                                <span className={`text-lg font-black transition-colors duration-500 ${!stats.streakBroken && isStreakActive ? "text-cyan-400" : "text-[#e5e5e5]"}`}>
                                    {stats.gems}
                                </span>
                            </button>

                            {/* Morning Burn Counter */}
                            {stats.isBurning && stats.tempGems > 0 && (
                                <div className="flex items-center gap-2 px-3 py-1.5 bg-red-500 text-white rounded-2xl animate-pulse shadow-lg">
                                    <span className="text-lg">üî•</span>
                                    <span className="text-lg font-black">{stats.tempGems}üíé</span>
                                    <span className="text-xs font-bold">ÁáÉÁÑº‰∏≠</span>
                                </div>
                            )}
                        </div>
                    </header>

                    {/* üé∞ Â§©‰∫ï„ÉªÈÄ£Ëçò„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº */}
                    {(stats.pityCounter >= 3 || stats.rensouCount > 0 || stats.feverEndTime > Date.now()) && (
                        <div className="fixed top-16 left-0 right-0 z-[70] px-4 py-2 flex justify-center gap-3 pointer-events-none">
                            {/* Â§©‰∫ï„Ç´„Ç¶„É≥„Çø„ÉºÔºà3Âõû‰ª•‰∏ä„ÅÆ„Çπ„Ç´„ÅßË°®Á§∫Ôºâ */}
                            {stats.pityCounter >= 3 && (
                                <div className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-2xl shadow-lg animate-pulse pointer-events-auto">
                                    <div className="flex items-center gap-2">
                                        <span className="text-lg">‚ö°</span>
                                        <div>
                                            <div className="text-xs font-bold opacity-80">Â§©‰∫ï„Åæ„Åß</div>
                                            <div className="text-lg font-black">{8 - stats.pityCounter}Âõû</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {/* ÈÄ£Ëçò„É¢„Éº„ÉâË°®Á§∫ */}
                            {stats.rensouCount > 0 && (
                                <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-2xl shadow-lg animate-bounce pointer-events-auto">
                                    <div className="flex items-center gap-2">
                                        <span className="text-lg">üé∞</span>
                                        <div>
                                            <div className="text-xs font-bold opacity-80">ÈÄ£Ëçò„É¢„Éº„Éâ</div>
                                            <div className="text-lg font-black">ÊÆã„Çä{stats.rensouCount}Âõû</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {/* „Éï„Ç£„Éº„Éê„Éº„É¢„Éº„ÉâË°®Á§∫ */}
                            {stats.feverEndTime > Date.now() && (
                                <div className="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-2 rounded-2xl shadow-lg animate-pulse pointer-events-auto">
                                    <div className="flex items-center gap-2">
                                        <span className="text-lg">üî•</span>
                                        <div>
                                            <div className="text-xs font-bold opacity-80">FEVER</div>
                                            <div className="text-lg font-black">Á¢∫Áéá2ÂÄç</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Sidebar */}
                    {isMobile && isSidebarOpen && <div className="fixed inset-0 bg-black/40 z-[80] backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)} />}
                    <aside className={`fixed inset-y-0 left-0 transform transition-all duration-300 z-[90] w-72 bg-white border-r-2 border-duo-gray pt-20 flex flex-col ${isSidebarOpen ? 'translate-x-0 shadow-xl' : '-translate-x-full'}`}>
                        {/* Streak Section */}
                        <div className="p-4 mb-2">
                            <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-3">‰ªäÊó•„ÅÆË®òÈå≤</h3>
                            <div className={`flex items-center gap-4 p-3 rounded-2xl border-2 transition-colors duration-500 ${isStreakActive ? 'bg-orange-50 border-orange-100' : 'bg-gray-50 border-gray-200'}`}>
                                <div className="relative group cursor-pointer transition-transform hover:scale-110">
                                    <Icons.Flame size={32} className={`transition-colors duration-1000 ${isStreakActive ? "text-duo-orange" : "text-gray-300"}`} fill="currentColor" />
                                    {stats.streakBroken && stats.resurrectionTickets > 0 && (
                                        <button onClick={resurrectStreak} className="absolute -bottom-2 -right-4 bg-duo-blue text-white text-[10px] font-black px-2 py-0.5 rounded-lg whitespace-nowrap animate-bounce shadow-sm">
                                            Âæ©Ê¥ªÔºÅ
                                        </button>
                                    )}
                                </div>
                                <div>
                                    <div className={`text-xl font-black transition-colors duration-1000 ${isStreakActive ? "text-duo-orange" : "text-gray-400"}`}>
                                        {stats.streakBroken ? 0 : stats.streak}Êó•ÈÄ£Á∂ö
                                    </div>
                                    <div className="text-xs text-gray-400 font-bold">{isStreakActive ? "Keep it burning!" : "„Çø„Çπ„ÇØÂÆå‰∫Ü„ÅßÁùÄÁÅ´ÔºÅ"}</div>
                                </div>
                            </div>
                        </div>

                        {/* Compact Focus Bar (Moved to Sidebar) */}
                        <div className="px-4 mb-6">
                            <div className="w-full bg-white border-2 border-gray-200 border-b-4 rounded-2xl p-2 flex items-center justify-between shadow-sm hover:shadow-md transition-all">
                                <button onClick={() => setTimerState(s => ({ ...s, active: !s.active }))}
                                    className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${btn3DClass} ${timerState.active ? 'bg-gray-100 text-gray-400 border-gray-300' : 'bg-duo-blue text-white border-duo-blueBorder'}`}>
                                    {timerState.active ? <Icons.Pause size={18} fill="currentColor" /> : <Icons.Play size={18} fill="currentColor" className="ml-0.5" />}
                                </button>
                                <div className="text-xl font-black font-mono tracking-tighter text-duo-text">
                                    {Math.floor(timerState.time / 60)}:{(timerState.time % 60).toString().padStart(2, '0')}
                                </div>
                                <div className="flex flex-col gap-1">
                                    <button onClick={() => switchTimerMode('work')} className={`text-[9px] font-black px-2 py-0.5 rounded ${timerState.mode === 'work' ? 'bg-duo-blue/10 text-duo-blue' : 'text-gray-400'}`}>ÈõÜ‰∏≠</button>
                                    <button onClick={() => switchTimerMode('break')} className={`text-[9px] font-black px-2 py-0.5 rounded ${timerState.mode === 'break' ? 'bg-duo-green/10 text-duo-green' : 'text-gray-400'}`}>‰ºëÊÜ©</button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-6 border-t-2 border-duo-gray">
                            <div className="space-y-3">
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest px-2">Lists</h3>
                                <button className={`w-full p-4 flex items-center gap-4 rounded-2xl font-black ${btn3DClass} ${activeListId === 'default' ? 'bg-duo-blue/10 text-duo-blue border-duo-blue/20' : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-500'}`} onClick={() => { setActiveListId('default'); if (isMobile) setIsSidebarOpen(false); }}><Icons.Check size={24} />„Éû„Ç§„Çø„Çπ„ÇØ</button>
                                <button className={`w-full p-4 flex items-center gap-4 rounded-2xl font-black ${btn3DClass} ${activeListId === 'deadline' ? 'bg-duo-pink/10 text-duo-pink border-duo-pink/20' : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-500'}`} onClick={() => { setActiveListId('deadline'); if (isMobile) setIsSidebarOpen(false); }}><Icons.Calendar size={24} />Á∑†Âàá„É™„Çπ„Éà</button>
                            </div>

                            {/* MVP Stats */}
                            <div className="mb-4">
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2 px-2">MVPÈñãÁô∫ÊåáÊ®ô</h3>
                                <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 border-2 border-blue-200 space-y-2">
                                    <div className="flex justify-between items-center">
                                        <span className="text-xs font-bold text-gray-600">üéØ ‰ΩúÊàê„Çø„Çπ„ÇØÊï∞</span>
                                        <span className="text-sm font-black text-blue-600">{stats.tasksCreated || 0}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-xs font-bold text-gray-600">‚ú® ÊúÄÈÅ©ÂåñÂõûÊï∞</span>
                                        <span className="text-sm font-black text-purple-600">{stats.tasksPurged || 0}</span>
                                    </div>
                                    <div className="mt-3 pt-2 border-t border-blue-200">
                                        <div className="text-[10px] font-bold text-gray-500 text-center">
                                            {stats.tasksPurged >= 3 ? "üèÜ „Éû„Çπ„Çø„ÉºÁ¥ö„ÅÆÊúÄÈÅ©ÂåñÔºÅ" : stats.tasksPurged >= 1 ? "üëç MVPÊÄùËÄÉ„ÅåË∫´„Å´„Å§„ÅÑ„Å¶„ÅÑ„Åæ„Åô" : "üí° ‰∏çË¶Å„Å™„Çø„Çπ„ÇØ„ÅØ„Éë„Éº„Ç∏„Åó„Çà„ÅÜ"}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Dev Log Moved Here (Above Gem Shop) */}
                            <div>
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2 px-2">ÈñãÁô∫„É≠„Ç∞</h3>
                                <div className="bg-white rounded-xl p-4 border-2 border-gray-200 h-56 overflow-y-auto space-y-3">
                                    {stats.devLogs && stats.devLogs.length > 0 ? (
                                        stats.devLogs.map((log, i) => (
                                            <div key={log.id} className={`text-xs font-medium leading-relaxed border-l-4 border-l-gray-300 pl-3 py-2 ${i === 0 ? 'animate-log-fade bg-blue-50' : 'bg-gray-50'} rounded-r ${log.colorClass}`}>
                                                <span className="text-gray-500 block mb-1 font-bold text-[11px]">{log.date}</span>
                                                <span className="block">{log.text}</span>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="text-xs text-gray-500 text-center py-6 font-medium">„É≠„Ç∞„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                                    )}
                                </div>
                            </div>

                            <div className="pt-6 border-t-2 border-duo-gray/50 pb-20">
                                <button onClick={() => setIsShopOpen(!isShopOpen)} className={`w-full flex items-center justify-between px-4 py-3 rounded-2xl transition-all font-black text-gray-500 bg-white border-2 border-transparent hover:bg-gray-50 ${isShopOpen ? 'text-duo-text' : ''} ${juicyBtnClass}`}>
                                    <div className="flex items-center gap-2 text-xs uppercase tracking-widest"><Icons.ShoppingBag size={18} /> Gem Shop</div>
                                    {isShopOpen ? <Icons.ChevronDown size={18} /> : <Icons.ChevronRight size={18} />}
                                </button>
                                {isShopOpen && (
                                    <div className="mt-4 space-y-3 animate-in fade-in slide-in-from-top-1 pb-20 px-1">
                                        <div className={`p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all bg-white hover:scale-105 active:scale-95`} onClick={() => buyItem(200, () => setStats(s => ({ ...s, streakFreeze: s.streakFreeze + 1 })))}>
                                            <div className="text-left"><div className="font-black text-sm text-duo-blue flex items-center gap-1"><Icons.Snowflake size={16} /> ÈÄ£Á∂ö„Éï„É™„Éº„Ç∫ ({stats.streakFreeze})</div><div className="text-[10px] text-gray-400 font-bold">Streak„Çí1Êó•ÂÆà„Çã</div></div>
                                            <div className="text-duo-pink font-black text-sm">200üíé</div>
                                        </div>

                                        {/* MVP Scrutinizer */}
                                        <div className={`p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${stats.mvpScrutinizerActive ? 'bg-blue-50 border-blue-200' : 'bg-white'}`}
                                            onClick={() => !stats.mvpScrutinizerActive && buyItem(100, () => setStats(s => ({ ...s, mvpScrutinizerActive: true })))}>
                                            <div className="text-left">
                                                <div className="font-black text-sm text-duo-blue flex items-center gap-1"><Icons.Search size={16} /> MVP Scrutinizer</div>
                                                <div className="text-[10px] text-gray-400 font-bold">Âè≥„ÇØ„É™„ÉÉ„ÇØ„Åß„Çø„Çπ„ÇØ„Çí„Éë„Éº„Ç∏</div>
                                            </div>
                                            {!stats.mvpScrutinizerActive ? <div className="text-duo-pink font-black text-sm">100üíé</div> : <div className="text-[10px] font-black text-blue-600 bg-blue-100 px-2 py-1 rounded-lg">ON</div>}
                                        </div>

                                        {/* Dev's Oath */}
                                        <div className={`p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${stats.devOathActive ? 'bg-purple-50 border-purple-200' : 'bg-white'}`}
                                            onClick={() => !stats.devOathActive && buyItem(50, () => setStats(s => ({ ...s, devOathActive: true })))}>
                                            <div className="text-left">
                                                <div className="font-black text-sm text-purple-600 flex items-center gap-1"><Icons.Shield size={16} /> Dev's Oath</div>
                                                <div className="text-[10px] text-gray-400 font-bold">ÊòéÊó•„ÅÆ„Çø„Çπ„ÇØÂÆå‰∫Ü„ÇíË™ì„ÅÜ</div>
                                            </div>
                                            {!stats.devOathActive ? <div className="text-duo-pink font-black text-sm">50üíé</div> : <div className="text-[10px] font-black text-purple-600 bg-purple-100 px-2 py-1 rounded-lg">Ë™ìÁ¥ÑÊ∏à</div>}
                                        </div>

                                        {/* Flow Capacitor */}
                                        <div className={`p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${Date.now() < stats.flowCapacitorEndTime ? 'bg-yellow-50 border-yellow-200' : 'bg-white'}`}
                                            onClick={() => Date.now() > stats.flowCapacitorEndTime && buyItem(150, () => setStats(s => ({ ...s, flowCapacitorEndTime: Date.now() + 15 * 60 * 1000 })))}>
                                            <div className="text-left">
                                                <div className="font-black text-sm text-yellow-600 flex items-center gap-1"><Icons.Zap size={16} /> Flow Capacitor</div>
                                                <div className="text-[10px] text-gray-400 font-bold">15ÂàÜÈñì„ÄÅÊºîÂá∫Á¢∫Áéá100%</div>
                                            </div>
                                            {Date.now() > stats.flowCapacitorEndTime ? <div className="text-duo-pink font-black text-sm">150üíé</div> : <div className="text-[10px] font-black text-yellow-600 bg-yellow-100 px-2 py-1 rounded-lg">Active</div>}
                                        </div>

                                        <div className="p-3 border-2 border-gray-200 border-b-4 rounded-2xl flex justify-between items-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all bg-white hover:scale-105 active:scale-95" onClick={() => buyItem(150, () => setStats(s => ({ ...s, resurrectionTickets: s.resurrectionTickets + 1 })))}>
                                            <div className="text-left"><div className="font-black text-sm text-gray-600 flex items-center gap-1"><Icons.Ticket size={16} /> ËòáÁîü„ÉÅ„Ç±„ÉÉ„Éà ({stats.resurrectionTickets})</div><div className="text-[10px] text-gray-400 font-bold">StreakÂàá„Çå„ÇíÂæ©Ê¥ª</div></div>
                                            <div className="text-duo-pink font-black text-sm">150üíé</div>
                                        </div>

                                        <div className="mt-4 text-[10px] font-black text-gray-400 px-2 uppercase tracking-widest">THEMES</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className={`p-3 border-2 border-b-4 rounded-2xl text-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${stats.currentTheme === 'cherry' ? 'border-pink-400 bg-pink-50' : 'border-gray-200 bg-white'}`} onClick={() => unlockTheme('cherry', 500)}>
                                                <Icons.Cherry size={24} className="mx-auto text-pink-400 mb-2" />
                                                <div className="text-[10px] font-bold text-gray-600">Ê°úÂêπÈõ™</div>
                                                {!stats.themes.includes('cherry') && <div className="text-duo-pink text-xs font-black mt-1">500üíé</div>}
                                            </div>
                                            <div className={`p-3 border-2 border-b-4 rounded-2xl text-center cursor-pointer active:border-b-2 active:translate-y-[2px] transition-all hover:scale-105 active:scale-95 ${stats.currentTheme === 'fireworks' ? 'border-blue-400 bg-blue-50' : 'border-gray-200 bg-white'}`} onClick={() => unlockTheme('fireworks', 500)}>
                                                <Icons.Sparkles size={24} className="mx-auto text-blue-400 mb-2" />
                                                <div className="text-[10px] font-bold text-gray-600">Ëä±ÁÅ´</div>
                                                {!stats.themes.includes('fireworks') && <div className="text-duo-pink text-xs font-black mt-1">500üíé</div>}
                                            </div>
                                        </div>

                                    </div>
                                )}
                            </div>
                        </div>
                    </aside>

                    {/* Main Area */}
                    <main className={`flex-1 pt-20 transition-all duration-300 ${isSidebarOpen && !isMobile ? 'pl-72' : 'pl-0'}`}>
                        <div className="h-full overflow-y-auto px-6 md:px-20 lg:px-32 pb-40">
                            <div className="max-w-2xl mx-auto pt-8">
                                <div className="flex items-center gap-3 mb-6">
                                    <h1 className="text-lg font-bold tracking-tight text-gray-500">{activeListId === 'default' ? '„Éû„Ç§„Çø„Çπ„ÇØ' : 'Á∑†Âàá„É™„Çπ„Éà'}</h1>
                                    {notificationPermission !== 'granted' && (
                                        <button
                                            onClick={async () => {
                                                if (window.requestNotificationPermission) {
                                                    await window.requestNotificationPermission();
                                                    // Ë®±ÂèØÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                                                    if (typeof Notification !== 'undefined') {
                                                        setNotificationPermission(Notification.permission);
                                                    }
                                                }
                                            }}
                                            className="ml-auto p-2 bg-blue-50 text-blue-500 rounded-full hover:bg-blue-100 transition-colors"
                                            title="ÈÄöÁü•„ÇíË®±ÂèØ"
                                        >
                                            <Icons.Bell size={18} />
                                        </button>
                                    )}
                                </div>

                                {/* Â¥áÈ´ò„Å™ÊÑèÂë≥Ôºö1%ÊàêÈï∑„É°„ÉÉ„Çª„Éº„Ç∏ */}
                                <div className="mb-3 px-2">
                                    <p className="text-xs text-gray-500">
                                        {stats.streak > 0 ? (
                                            <>
                                                <span className="text-green-600 font-bold">üìà Day {stats.streak}:</span>
                                                {' '}<span className="font-bold text-gray-700">{Math.pow(1.01, stats.streak).toFixed(2)}ÂÄç</span>„ÅÆËá™ÂàÜ„ÄÇ
                                                „ÅÇ„Å®<span className="text-blue-600 font-bold">{365 - stats.streak > 0 ? 365 - stats.streak : 0}Êó•</span>„Åß37ÂÄç„ÄÇ
                                            </>
                                        ) : (
                                            <>
                                                üìà ÊØéÊó•1%„ÅÆÊàêÈï∑„Åß„ÄÅ1Âπ¥Âæå<span className="font-bold text-green-600">37ÂÄç</span>„ÄÇ‰ªäÊó•„Åã„ÇâÂßã„ÇÅ„Çà„ÅÜ„ÄÇ
                                            </>
                                        )}
                                    </p>
                                </div>

                                {/* „Çø„Çπ„ÇØÂÖ•Âäõ„Ç®„É™„Ç¢ */}
                                <div className={`mb-8 bg-gray-100 border-2 border-gray-200 rounded-xl p-1 shadow-sm ${btn3DClass} focus-within:translate-y-[4px] focus-within:border-b-0`}>
                                    <div className="w-full h-full flex items-center px-3 py-2 gap-2">
                                        <Icons.Plus className="text-gray-400 opacity-80" size={20} />
                                        <textarea
                                            className="bg-transparent outline-none flex-1 font-medium text-base text-gray-700 placeholder-gray-400 resize-none min-h-[32px] max-h-[200px]"
                                            placeholder="MVPÂøÖÈ†àÊ©üËÉΩ„ÅÆ„Åø„ÇíËøΩÂä†"
                                            rows="1"
                                            onInput={(e) => {
                                                e.target.style.height = 'auto';
                                                e.target.style.height = e.target.scrollHeight + 'px';
                                            }}
                                            onKeyDown={(e) => {
                                                // Ctrl+Enter or Cmd+Enter to submit
                                                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                                                    e.preventDefault();
                                                    const value = e.target.value.trim();
                                                    if (!value) return;

                                                    // Split by newlines and semicolons
                                                    const taskTitles = value
                                                        .split(/[\n;]/)
                                                        .map(t => t.trim())
                                                        .filter(t => t);

                                                    if (taskTitles.length === 0) return;

                                                    // Section 1„ÅÆ„Çø„Çπ„ÇØÊï∞„Çí„Ç´„Ç¶„É≥„Éà
                                                    let section1Count = 0;
                                                    for (let t of tasks) {
                                                        if (!t.completed && section1Count > 0 && t.isSectionHead) break;
                                                        if (!t.completed) section1Count++;
                                                    }

                                                    // Section 1„Åå5„Å§‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØË≠¶Âëä
                                                    if (section1Count + taskTitles.length > 5) {
                                                        setToastMessage("‚ö†Ô∏è MVPÈñãÁô∫„ÅØ„Ç∑„É≥„Éó„É´„Å´ÔºÅ„Çø„Çπ„ÇØ„ÇíÊ∏õ„Çâ„Åô„Å®ÈõÜ‰∏≠ÂäõUP");
                                                        AudioEngine.play([200, 150], 'sawtooth', 0.1, 0.1);
                                                    }

                                                    // Create multiple tasks
                                                    const newTasks = taskTitles.map((title, index) => ({
                                                        id: (Date.now() + index).toString(),
                                                        title: title,
                                                        completed: false,
                                                        listId: activeListId,
                                                        createdAt: Date.now() + index,
                                                        isSectionHead: tasks.length === 0 && index === 0
                                                    }));

                                                    setTasks([...tasks, ...newTasks]);
                                                    setStats(s => ({ ...s, tasksCreated: s.tasksCreated + newTasks.length }));

                                                    if (newTasks.length > 1) {
                                                        setToastMessage(`‚ú® ${newTasks.length} tasks added`);
                                                    }

                                                    e.target.value = '';
                                                    e.target.style.height = 'auto';
                                                }
                                            }}
                                        />
                                    </div>
                                </div>

                                {/* üî• Morning Burn Fuse Bar - „Çø„Çπ„ÇØÂÖ•Âäõ„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ */}
                                {stats.isBurning && stats.tempGems > 0 && (() => {
                                    const remainingPercent = (stats.tempGems / stats.initialTempGems) * 100;

                                    // ÊÆµÈöéÁöÑ„É°„ÉÉ„Çª„Éº„Ç∏ÔºàÂøÉÁêÜÂ≠¶ÁöÑÊêçÂ§±ÂõûÈÅø„ÇíÊúÄÂ§ßÂåñÔºâ
                                    let burnMessage = 'üî• Â∞éÁÅ´Á∑öÁáÉÁÑº‰∏≠ - ‰ªä„Åô„Åê„Çø„Çπ„ÇØ„ÇíÁùÄÊâã„Åõ„ÇàÔºÅ';
                                    let messageClass = 'text-red-600';

                                    if (remainingPercent <= 5) {
                                        burnMessage = 'üî¥ „ÇÇ„ÅÜÈñì„Å´Âêà„Çè„Å™„ÅÑ...Ôºü';
                                        messageClass = 'text-red-800 animate-pulse';
                                    } else if (remainingPercent <= 10) {
                                        burnMessage = '‚ÄºÔ∏è Ê∂àÊªÖÈñìËøë ‚ÄºÔ∏è';
                                        messageClass = 'text-red-700 font-black';
                                    } else if (remainingPercent <= 25) {
                                        burnMessage = 'üíÄ ÊÆã„Çä„Çè„Åö„Åã...Ê∂à„Åà„Çã„Åû';
                                        messageClass = 'text-red-700';
                                    } else if (remainingPercent <= 50) {
                                        burnMessage = '‚ö†Ô∏è ÂçäÂàÜÊ∂àÊªÖÔºÅÊÄ•„ÅíÔºÅ';
                                        messageClass = 'text-orange-600';
                                    } else if (remainingPercent <= 75) {
                                        burnMessage = 'üî• Â∞éÁÅ´Á∑öÁáÉÁÑº‰∏≠ - ‰ªä„Åô„Åê„Çø„Çπ„ÇØ„ÇíÁùÄÊâã„Åõ„ÇàÔºÅ';
                                    }

                                    // 10%‰ª•‰∏ã„ÅßÁÇπÊªÖ„ÄÅ5%‰ª•‰∏ã„ÅßÁîªÈù¢Êè∫„Çå
                                    const barFlash = remainingPercent <= 10;
                                    const screenShake = remainingPercent <= 5;

                                    return (
                                        <div className={`mb-4 px-2 ${screenShake ? 'animate-[screen-shake_0.3s_ease-in-out_infinite]' : ''}`}>
                                            <div className={`bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner ${barFlash ? 'ring-2 ring-red-500 ring-opacity-75' : ''}`}>
                                                <div
                                                    className={`h-full bg-gradient-to-r from-red-600 to-orange-500 transition-all duration-300 relative ${barFlash ? 'animate-pulse' : ''}`}
                                                    style={{ width: `${remainingPercent}%` }}
                                                >
                                                    <div className={`absolute inset-0 bg-white/20 ${barFlash ? 'animate-ping' : 'animate-pulse'}`}></div>
                                                </div>
                                            </div>
                                            <div className={`text-center text-xs font-bold mt-1 ${messageClass} ${barFlash ? 'text-sm' : ''}`}>
                                                {burnMessage}
                                            </div>
                                        </div>
                                    );
                                })()}

                                <div className="space-y-3 relative">
                                    {incomplete.map((t, index) => {
                                        const isFirst = index === 0;
                                        const showSectionHeader = isFirst || t.isSectionHead;

                                        if (showSectionHeader) {
                                            sectionCounter++;
                                            const sectionNum = sectionCounter;
                                            const isLast = isLastTaskInSection(index);

                                            return (
                                                <React.Fragment key={t.id}>
                                                    <div className="py-4 flex items-center justify-center gap-2" data-section={sectionNum}>
                                                        <div
                                                            className={`font-black text-xs px-4 py-1 rounded-full uppercase tracking-widest cursor-pointer hover:scale-105 transition-transform ${sectionNum === 1 ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-500'}`}
                                                            onContextMenu={(e) => {
                                                                e.preventDefault();
                                                                const newName = prompt('„Çª„ÇØ„Ç∑„Éß„É≥Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', t.sectionName || `Section ${sectionNum}`);
                                                                if (newName !== null && newName.trim()) {
                                                                    updateTask(t.id, { sectionName: newName.trim() });
                                                                }
                                                            }}
                                                            title="Âè≥„ÇØ„É™„ÉÉ„ÇØ„ÅßÂêçÂâç„ÇíÂ§âÊõ¥"
                                                        >
                                                            {t.sectionName || `Section ${sectionNum}`}
                                                        </div>
                                                        {sectionNum === 1 && (
                                                            <div className="flex items-center gap-1 bg-yellow-100 border-2 border-yellow-300 rounded-full px-3 py-1 animate-pulse">
                                                                <span className="text-lg">üöÄ</span>
                                                                <span className="text-[10px] font-black text-yellow-700 uppercase tracking-wider">MVP Focus</span>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* üìä „Çª„ÇØ„Ç∑„Éß„É≥ÈÄ≤Êçó„Éê„Éº - Section 1„ÅÆ„Åø */}
                                                    {sectionNum === 1 && (() => {
                                                        // „Çª„ÇØ„Ç∑„Éß„É≥1„ÅÆÊú™ÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞„ÇíË®àÁÆó
                                                        let section1Incomplete = [];
                                                        for (let i = 0; i < incomplete.length; i++) {
                                                            if (i > 0 && incomplete[i].isSectionHead) break;
                                                            section1Incomplete.push(incomplete[i]);
                                                        }

                                                        // ‰ªäÊó•ÂÆå‰∫Ü„Åó„Åü„Çø„Çπ„ÇØÊï∞„ÇíË®àÁÆó
                                                        const today = getAdjustedToday();
                                                        const section1Completed = completed.filter(task => {
                                                            const completedDate = task.completedAt ? new Date(task.completedAt).toISOString().split('T')[0] : null;
                                                            return completedDate === today;
                                                        }).length;

                                                        const remaining = section1Incomplete.length;
                                                        const totalTasks = remaining + section1Completed;
                                                        const progressPercent = totalTasks > 0 ? (section1Completed / totalTasks) * 100 : 0;

                                                        return (
                                                            <div className="px-4 pb-2">
                                                                <div className="bg-gray-200 rounded-full h-2 overflow-hidden shadow-inner">
                                                                    <div
                                                                        className="h-full bg-gradient-to-r from-green-500 to-emerald-400 transition-all duration-500"
                                                                        style={{ width: `${progressPercent}%` }}
                                                                    />
                                                                </div>
                                                                <div className="text-center text-xs text-gray-600 font-bold mt-1">
                                                                    {remaining === 1 ? (
                                                                        <span className="text-green-600">üéÅ „ÅÇ„Å®1„Å§„ÅßÈÅîÊàêÔºÅÂÆå‰∫ÜÊôÇ50üíé„Éú„Éº„Éä„Çπ</span>
                                                                    ) : remaining === 0 ? (
                                                                        <span className="text-green-600">‚ú® „Çª„ÇØ„Ç∑„Éß„É≥ÂÆå‰∫ÜÔºÅ</span>
                                                                    ) : (
                                                                        <span>„ÅÇ„Å®{remaining}„Çø„Çπ„ÇØ„Åß50üíé</span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        );
                                                    })()}

                                                    <div
                                                        onDragOver={(e) => handleDragOver(e, t)}
                                                        onDrop={(e) => handleDrop(e, t)}
                                                    >
                                                        <TaskItem
                                                            task={t}
                                                            isMobile={isMobile}
                                                            onXpGain={handleXpGain}
                                                            onToggle={() => updateTask(t.id, { completed: true, completedAt: Date.now() })}
                                                            onUpdate={updateTask}
                                                            onDelete={(id) => setTasks(tasks.filter(x => x.id !== id))}
                                                            onDragStart={handleDragStart}
                                                            isDragging={draggedTaskId === t.id}
                                                            isDeadlineView={activeListId === 'deadline'}
                                                            activeTheme={stats.currentTheme}
                                                            onContextMenu={handleContextMenu}
                                                            isFocusedSection={sectionNum === 1}
                                                            isLastInSection={isLast}
                                                            setRewardEffect={setRewardEffect}
                                                            stats={stats}
                                                            setStats={setStats}
                                                            setToastMessage={setToastMessage}
                                                        />
                                                    </div>
                                                </React.Fragment>
                                            );
                                        }

                                        const isLast = isLastTaskInSection(index);
                                        return (
                                            <div
                                                key={t.id}
                                                onDragOver={(e) => handleDragOver(e, t)}
                                                onDrop={(e) => handleDrop(e, t)}
                                            >
                                                <TaskItem
                                                    task={t}
                                                    isMobile={isMobile}
                                                    onXpGain={handleXpGain}
                                                    onToggle={() => updateTask(t.id, { completed: true, completedAt: Date.now() })}
                                                    onUpdate={updateTask}
                                                    onDelete={(id) => setTasks(tasks.filter(x => x.id !== id))}
                                                    onDragStart={handleDragStart}
                                                    isDragging={draggedTaskId === t.id}
                                                    isDeadlineView={activeListId === 'deadline'}
                                                    activeTheme={stats.currentTheme}
                                                    onContextMenu={handleContextMenu}
                                                    isFocusedSection={sectionCounter === 1}
                                                    isLastInSection={isLast}
                                                    setRewardEffect={setRewardEffect}
                                                    stats={stats}
                                                    setStats={setStats}
                                                    setToastMessage={setToastMessage}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* ÂÆå‰∫Ü„Çø„Çπ„ÇØ„Çª„ÇØ„Ç∑„Éß„É≥ */}
                                {completed.length > 0 && (
                                    <div className="mt-16 mb-20">
                                        <button onClick={() => setIsCompletedOpen(!isCompletedOpen)} className={`flex items-center gap-2 text-sm font-black text-gray-400 hover:text-gray-600 px-4 py-3 rounded-xl transition-colors bg-gray-50 border-2 border-transparent hover:border-gray-200 ${juicyBtnClass}`}>
                                            {isCompletedOpen ? <Icons.ChevronDown size={18} /> : <Icons.ChevronRight size={18} />}
                                            ÂÆå‰∫ÜÊ∏à„Åø ({completed.length})
                                        </button>

                                        {isCompletedOpen && (
                                            <div className="mt-4 space-y-2 opacity-75">
                                                {completed.map(t => (
                                                    <TaskItem
                                                        key={t.id}
                                                        task={t}
                                                        isMobile={isMobile}
                                                        onXpGain={handleXpGain}
                                                        onToggle={() => updateTask(t.id, { completed: false })}
                                                        onUpdate={updateTask}
                                                        onDelete={(id) => setTasks(tasks.filter(x => x.id !== id))}
                                                        onDragStart={null}
                                                        isDragging={false}
                                                        isDeadlineView={activeListId === 'deadline'}
                                                        activeTheme={stats.currentTheme}
                                                        setRewardEffect={setRewardEffect}
                                                        stats={stats}
                                                        setStats={setStats}
                                                        setToastMessage={setToastMessage}
                                                    />
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>

                    {/* Effects */}
                    {toastMessage && <Toast message={toastMessage} onClose={closeToast} />}
                    {floatingTexts.map(t => <FloatingText key={t.id} x={t.x} y={t.y} text={t.text} color={t.color} scale={t.scale} />)}
                    {/* ‰∏≠ÊØíÊÄßMAXÔºöÂ†±ÈÖ¨ÊºîÂá∫ */}
                    {rewardEffect}
                    {/* PerformanceOverlay removed */}
                    {showChestModal.show && <ChestModal onClose={() => setShowChestModal({ show: false, isWakeup: false })} onReward={handleReward} isWakeupChest={showChestModal.isWakeup} />}
                    {showIgnition && <IgnitionModal />}

                    {/* üåÖ „É¢„Éº„Éã„É≥„Ç∞„Éú„Éº„Éä„ÇπÂÆùÁÆ± */}
                    {showMorningChest && (
                        <MorningBonusChestModal
                            onClose={() => setShowMorningChest(false)}
                            onClaim={(reward, rarity) => {
                                setStats(prev => ({
                                    ...prev,
                                    gems: prev.gems + reward,
                                    morningChestClaimedDate: getAdjustedToday(),
                                    devLogs: [{
                                        id: Date.now(),
                                        text: `[‚òÄÔ∏è Morning Bonus] +${reward}üíé Áç≤ÂæóÔºÅ${rarity === 'legendary' ? 'üéâ LEGENDARY!!' : ''}`,
                                        colorClass: rarity === 'legendary' ? 'text-yellow-600 font-black' : 'text-orange-600 font-bold'
                                    }, ...prev.devLogs]
                                }));
                                setShowMorningChest(false);
                                setToastMessage(`‚òÄÔ∏è +${reward}üíé „É¢„Éº„Éã„É≥„Ç∞„Éú„Éº„Éä„ÇπÔºÅ`);
                                // Áù°Áú†„ÉÅ„É£„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÁ∂ö„Åë„Å¶Ë°®Á§∫
                                if (sleepChargeAmount > 0) {
                                    setTimeout(() => setShowSleepChargeModal(true), 500);
                                }
                            }}
                        />
                    )}

                    {/* üíé Áù°Áú†„ÉÅ„É£„Éº„Ç∏„É¢„Éº„ÉÄ„É´ */}
                    {showSleepChargeModal && (
                        <SleepChargeModal
                            amount={sleepChargeAmount}
                            onClose={() => setShowSleepChargeModal(false)}
                            onCollect={(amount) => {
                                setStats(prev => ({
                                    ...prev,
                                    gems: prev.gems + amount,
                                    sleepChargeCollectedDate: getAdjustedToday(),
                                    devLogs: [{
                                        id: Date.now(),
                                        text: `[üí§ Sleep Charge] +${amount}üíé ÂõûÂèéÂÆå‰∫Ü`,
                                        colorClass: 'text-blue-600 font-bold'
                                    }, ...prev.devLogs]
                                }));
                                setShowSleepChargeModal(false);
                                setSleepChargeAmount(0);
                                setToastMessage(`üíé +${amount}üíé Áù°Áú†„ÉÅ„É£„Éº„Ç∏ÂõûÂèéÔºÅ`);
                            }}
                        />
                    )}

                    {/* üî• „Çπ„Éà„É™„Éº„ÇØË≠¶Âëä„Éê„Éä„Éº */}
                    {showStreakWarning && !stats.streakBroken && (
                        <StreakWarningBanner
                            streak={stats.streak}
                            onDismiss={() => setShowStreakWarning(false)}
                        />
                    )}

                    {contextMenu && (
                        <ContextMenu
                            x={contextMenu.x}
                            y={contextMenu.y}
                            onDivide={toggleSectionBreak}
                            onMerge={toggleSectionBreak}
                            showMerge={tasks.findIndex(t => t.id === contextMenu.task.id) < tasks.length - 1 && tasks[tasks.findIndex(t => t.id === contextMenu.task.id) + 1].isSectionHead}
                            showPurge={stats.mvpScrutinizerActive}
                            onPurge={purgeTask}
                        />
                    )}

                    {/* üåÄ Antigravity Button */}
                    <AntigravityButton />

                    <style>{`
                        @keyframes warp-fade-in { from { opacity: 0; } to { opacity: 1; } }
                        @keyframes warp-lines { from { opacity: 0; transform: scale(1); } to { opacity: 0.8; transform: scale(3); } }
                        @keyframes warp-ring { from { opacity: 0; transform: scale(0); border-width: 100px; } to { opacity: 0.5; transform: scale(1.5); border-width: 0px; } }
                        @keyframes warp-text { from { opacity: 0; transform: scale(3); } to { opacity: 1; transform: scale(1); } }
                    `}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <!-- Firebase Initialization -->
    <script>
        // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÂàùÊúüÁä∂ÊÖã„ÅÆ„Çπ„Çø„ÉñÈñ¢Êï∞
        window.requestNotificationPermission = () => {
            alert('„Ç®„É©„Éº: „Ç¢„Éó„É™„ÅÆÊ∫ñÂÇô„Åå„Åæ„Å†ÁµÇ„Çè„Å£„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºà„É≠„Éº„Éâ‰∏≠„Åæ„Åü„ÅØÂàùÊúüÂåñ„Ç®„É©„ÉºÔºâ„ÄÇ\nÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBzIHjUneCjIRToqkdsyYL9b1RzVKSEoxg",
                authDomain: "todo-1c26a.firebaseapp.com",
                projectId: "todo-1c26a",
                storageBucket: "todo-1c26a.firebasestorage.app",
                messagingSenderId: "697462680954",
                appId: "1:697462680954:web:5e9f08ecd07b814ccffac3",
                measurementId: "G-6BFDKWQ5ZL"
            };

            try {
                firebase.initializeApp(firebaseConfig);
                const messaging = firebase.messaging();

                // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨ÈñãÔºàReact„Åã„ÇâÂëº„Å∂„Åü„ÇÅÔºâ
                window.requestNotificationPermission = async () => {
                    console.log('Requesting notification permission...');
                    try {
                        if (!("Notification" in window)) {
                            alert("„Åì„ÅÆÁí∞Â¢É„Åß„ÅØÈÄöÁü•Ê©üËÉΩ„Åå‰Ωø„Åà„Åæ„Åõ„Çì„ÄÇ\niPhone„ÅÆÂ†¥Âêà„ÅØ„ÄåÂÖ±Êúâ„Äç‚Üí„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„Åó„Å¶„Åã„Çâ„ÄÅ„Ç¢„Éó„É™„Å®„Åó„Å¶Èñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
                            return;
                        }

                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            console.log('Notification permission granted.');

                            try {
                                // Service Worker„ÇíÊòéÁ§∫ÁöÑ„Å´ÂèñÂæó„ÉªÁôªÈå≤
                                let registration;
                                if ('serviceWorker' in navigator) {
                                    // „Åæ„ÅöÊó¢Â≠ò„ÅÆÁôªÈå≤„ÇíÁ¢∫Ë™ç
                                    registration = await navigator.serviceWorker.getRegistration('./');
                                    if (!registration) {
                                        // „Å™„Åë„Çå„Å∞ÁôªÈå≤Ôºà„Çπ„Ç≥„Éº„Éó„ÅØ„Ç´„É¨„É≥„ÉàÔºâ
                                        registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js', { scope: './' });
                                    }
                                    console.log('SW Registered:', registration);
                                }

                                // registration„ÇíÊ∏°„Åó„Å¶getToken„ÇíÂëº„Å∂
                                const token = await messaging.getToken({
                                    serviceWorkerRegistration: registration
                                });
                                console.log('FCM Token:', token);

                                // Firestore„Å´‰øùÂ≠ò
                                try {
                                    const db = firebase.firestore();
                                    await db.collection('fcmTokens').doc(token).set({
                                        token: token,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        userAgent: navigator.userAgent
                                    });
                                    console.log('Token saved to Firestore');
                                    alert('„ÄêÊàêÂäü„ÄëË®≠ÂÆöÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n„Åì„Çå„ÅßÈÄöÁü•„ÅåÂ±ä„Åç„Åæ„Åô„ÄÇ');
                                } catch (dbError) {
                                    console.error('Error saving to Firestore:', dbError);
                                    alert('„Ç®„É©„Éº: „Éá„Éº„Çø‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n' + dbError.message);
                                }
                            } catch (e) {
                                console.error('Token error:', e);
                                alert('„Ç®„É©„Éº: „Éà„Éº„ÇØ„É≥ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n' + e.message);
                            }
                        } else {
                            alert('ÈÄöÁü•„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åã„ÇâË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        }
                    } catch (err) {
                        console.error('Error requesting permission:', err);
                        alert('„Ç®„É©„Éº: Ë®±ÂèØ„É™„ÇØ„Ç®„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n' + err.message);
                    }
                };

                // Service WorkerÁôªÈå≤
                if ('serviceWorker' in navigator) {
                    // GitHub Pages„ÅÆ„Çµ„Éñ„Éá„Ç£„É¨„ÇØ„Éà„É™(/todo-app/)„Å´ÂØæÂøú„Åô„Çã„Åü„ÇÅÁõ∏ÂØæ„Éë„Çπ„Çí‰ΩøÁî®
                    const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    console.log('Service Worker registered with scope:', registration.scope);
                }

                // „Éï„Ç©„Ç¢„Ç∞„É©„Ç¶„É≥„Éâ„Åß„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°
                messaging.onMessage((payload) => {
                    console.log('Message received. ', payload);
                    // „Éï„Ç©„Ç¢„Ç∞„É©„Ç¶„É≥„Éâ„Åß„ÇÇÈÄöÁü•„ÇíË°®Á§∫
                    new Notification(payload.notification.title || 'Todo App', {
                        body: payload.notification.body,
                        icon: '/favicon.ico'
                    });
                });
            } catch (error) {
                console.error('Firebase initialization error:', error);
                // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©‰∏äÊõ∏„Åç
                window.requestNotificationPermission = () => {
                    alert('„Ç®„É©„Éº: Firebase„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n' + error.message);
                };
            }
        });
    </script>
</body>

</html>